<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Stoica Reader</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#0f0e17"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"/>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER v3 â€” Complete Design System
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#f7f3ec;--surface:#ede8de;--surface2:#e3ddd2;
  --border:#c5bba8;--text:#1a1612;--muted:#7a7060;
  --accent:#c0392b;--accent-glow:rgba(192,57,43,.25);
  --blue:#2c4a7c;--green:#2d6a4f;--gold:#a07820;
  --hi-word:#c0392b;--hi-done:rgba(192,57,43,.12);
  --btn:#1a1612;--btn-txt:#f7f3ec;
  --shadow:rgba(26,22,18,.12);
  --r:8px;--r2:14px;
  --fs:18px;--lh:1.9;
  --font-body:'Crimson Pro',Georgia,serif;
  --font-mono:'Fira Code',monospace;
}
[data-theme=dark]{
  --bg:#0f0e17;--surface:#171624;--surface2:#1f1e2e;
  --border:#2a2840;--text:#e8e4f8;--muted:#706c8a;
  --accent:#e05c72;--accent-glow:rgba(224,92,114,.2);
  --blue:#7c9fd6;--green:#52b788;--gold:#d4a017;
  --hi-word:#e05c72;--hi-done:rgba(224,92,114,.12);
  --btn:#e8e4f8;--btn-txt:#0f0e17;
  --shadow:rgba(0,0,0,.35);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{
  font-family:var(--font-body);
  background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;
  transition:background .3s,color .3s;
}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€ HEADER â”€â”€ */
header{
  height:50px;background:var(--surface);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;
  justify-content:space-between;
  padding:0 18px;flex-shrink:0;
  box-shadow:0 2px 10px var(--shadow);z-index:60;
}
.logo{
  font-family:var(--font-mono);font-size:.9rem;
  font-weight:500;letter-spacing:.14em;
  color:var(--accent);
}
.logo em{color:var(--text);font-style:normal}
.logo sup{font-size:.55rem;color:var(--muted);vertical-align:super;letter-spacing:0}
.hdr-right{display:flex;gap:5px;align-items:center}

/* â”€â”€ TABS â”€â”€ */
.tabs{
  display:flex;background:var(--surface);
  border-bottom:1px solid var(--border);
  padding:0 18px;gap:0;flex-shrink:0;
  overflow-x:auto;
}
.tabs::-webkit-scrollbar{height:0}
.tab{
  padding:7px 14px;
  font-family:var(--font-mono);font-size:.68rem;
  letter-spacing:.06em;border:none;background:none;
  color:var(--muted);cursor:pointer;white-space:nowrap;
  border-bottom:2px solid transparent;
  transition:color .15s,border-color .15s;
}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab:hover:not(.active){color:var(--text)}

/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar{
  display:flex;flex-wrap:wrap;gap:5px;
  padding:8px 18px;background:var(--surface);
  border-bottom:1px solid var(--border);
  align-items:center;flex-shrink:0;
}
.sep{width:1px;height:20px;background:var(--border);margin:0 2px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  display:inline-flex;align-items:center;gap:5px;
  padding:6px 13px;border-radius:var(--r);
  border:1px solid var(--border);
  background:var(--btn);color:var(--btn-txt);
  font-family:var(--font-mono);font-size:.68rem;
  cursor:pointer;white-space:nowrap;letter-spacing:.04em;
  transition:opacity .15s,transform .1s;
}
.btn:hover{opacity:.82}
.btn:active{transform:scale(.97)}
.btn.ghost{background:transparent;color:var(--text)}
.btn.blue{background:var(--blue);color:#fff;border-color:var(--blue)}
.btn.green{background:var(--green);color:#fff;border-color:var(--green)}
.btn.gold{background:var(--gold);color:#fff;border-color:var(--gold)}
.icon-btn{
  background:none;border:1px solid var(--border);
  border-radius:var(--r);color:var(--text);cursor:pointer;
  width:32px;height:32px;display:flex;align-items:center;
  justify-content:center;font-size:.85rem;
  transition:background .15s;flex-shrink:0;
}
.icon-btn:hover{background:var(--surface2)}

/* â”€â”€ STATS BAR â”€â”€ */
.statsbar{
  display:flex;gap:16px;flex-wrap:wrap;
  padding:4px 18px;background:var(--bg);
  border-bottom:1px solid var(--border);
  font-family:var(--font-mono);font-size:.65rem;
  color:var(--muted);align-items:center;flex-shrink:0;
}
.statsbar b{color:var(--text);font-weight:500}
.pill{
  font-family:var(--font-mono);font-size:.63rem;
  padding:2px 9px;border-radius:20px;
  background:var(--border);color:var(--muted);
}
.pill.playing{background:var(--accent);color:#fff;animation:pulse 1.5s infinite}
.pill.paused{background:var(--blue);color:#fff}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-wrap{
  padding:0 18px 5px;background:var(--bg);
  border-bottom:1px solid var(--border);flex-shrink:0;
}
.prog-track{
  width:100%;height:5px;background:var(--surface2);
  border-radius:3px;cursor:pointer;position:relative;
  overflow:hidden;
}
.prog-fill{
  height:100%;width:0%;border-radius:3px;
  background:linear-gradient(90deg,var(--accent),var(--blue));
  pointer-events:none;transition:width .2s;
}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:flex;flex:1;overflow:hidden;min-height:0}

/* â”€â”€ READER â”€â”€ */
.reader-pane{
  flex:1;overflow-y:auto;
  padding:44px 80px;min-width:0;
}
@media(max-width:700px){.reader-pane{padding:24px 18px}}
#textDisplay{
  font-size:var(--fs);line-height:var(--lh);
  white-space:pre-wrap;word-break:break-word;
  outline:none;max-width:780px;margin:0 auto;
}
#textDisplay.empty::before{
  content:'Carga un PDF, un .txt o pega tu texto aquÃ­â€¦';
  color:var(--muted);font-style:italic;
}

/* Word highlighting */
.w{display:inline;cursor:default}
.w.now{
  background:var(--hi-word);color:#fff;
  border-radius:3px;padding:0 2px;
  box-shadow:0 0 8px var(--accent-glow);
}
.w.past{background:var(--hi-done);border-radius:2px}
mark.hl{
  background:#f6d55c;color:#1a1612;
  border-radius:3px;padding:0 1px;
}

/* â”€â”€ SIDE PANEL â”€â”€ */
.side{
  width:310px;min-width:280px;
  border-left:1px solid var(--border);
  background:var(--surface);
  display:flex;flex-direction:column;
  overflow:hidden;flex-shrink:0;
  transition:width .25s;
}
.side.off{width:0;min-width:0;border:none}
.side-inner{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.card{
  background:var(--bg);border:1px solid var(--border);
  border-radius:var(--r2);padding:13px;
  display:flex;flex-direction:column;gap:8px;
}
.card h3{font-family:var(--font-mono);font-size:.65rem;letter-spacing:.1em;color:var(--muted);text-transform:uppercase}
.ctrl-lbl{font-family:var(--font-mono);font-size:.63rem;color:var(--muted)}
input[type=range]{width:100%;accent-color:var(--accent);cursor:pointer}
select{
  border:1px solid var(--border);border-radius:var(--r);
  background:var(--bg);color:var(--text);
  font-family:var(--font-mono);font-size:.68rem;
  padding:5px 8px;width:100%;cursor:pointer;
}
input[type=text]{
  border:1px solid var(--border);border-radius:var(--r);
  background:var(--bg);color:var(--text);
  font-family:var(--font-mono);font-size:.68rem;
  padding:5px 8px;width:100%;
}

/* â”€â”€ TTS BAR â”€â”€ */
.tts-bar{
  background:var(--surface);border-top:1px solid var(--border);
  padding:10px 18px;display:flex;align-items:center;
  gap:10px;flex-shrink:0;
  box-shadow:0 -3px 12px var(--shadow);z-index:40;
}
.play-btn{
  width:46px;height:46px;border-radius:50%;border:none;
  background:var(--accent);color:#fff;font-size:1.15rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:transform .15s,box-shadow .15s;
  box-shadow:0 4px 16px var(--accent-glow);flex-shrink:0;
}
.play-btn:hover{transform:scale(1.08)}
.play-btn.blue{background:var(--blue);box-shadow:0 4px 16px rgba(44,74,124,.3)}
.tts-hint{font-family:var(--font-mono);font-size:.63rem;color:var(--muted);margin-left:auto}

/* â”€â”€ FLOAT â”€â”€ */
#floatCtrl{
  position:fixed;bottom:100px;right:18px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--r2);padding:10px;
  display:flex;flex-direction:column;gap:6px;align-items:center;
  box-shadow:0 8px 32px var(--shadow);z-index:300;
  cursor:move;user-select:none;min-width:52px;
  transition:opacity .2s,transform .2s;
}
#floatCtrl.off{opacity:0;pointer-events:none;transform:scale(.8) translateY(8px)}
.fc-drag{font-family:var(--font-mono);font-size:.58rem;color:var(--muted);letter-spacing:.08em}
.fc-speed{font-family:var(--font-mono);font-size:.68rem;color:var(--muted);text-align:center}
.fc-btn{
  width:38px;height:38px;border-radius:50%;
  border:1px solid var(--border);background:var(--bg);
  color:var(--text);font-size:.9rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:background .15s;
}
.fc-btn:hover{background:var(--surface2)}
.fc-btn.red{background:var(--accent);color:#fff;border-color:var(--accent)}

/* â”€â”€ OVERLAY/MODAL â”€â”€ */
.overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.55);z-index:500;
  align-items:center;justify-content:center;
  backdrop-filter:blur(3px);
}
.overlay.open{display:flex}
.modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r2);padding:26px;
  width:min(600px,96vw);max-height:90vh;overflow-y:auto;
  box-shadow:0 20px 60px var(--shadow);
  display:flex;flex-direction:column;gap:12px;
  animation:mIn .2s ease;
}
@keyframes mIn{from{opacity:0;transform:scale(.95) translateY(8px)}}
.modal h2{font-family:var(--font-mono);font-size:.85rem;letter-spacing:.07em}
.modal textarea{
  border:1px solid var(--border);border-radius:var(--r);
  background:var(--bg);color:var(--text);
  font-family:var(--font-body);font-size:.95rem;
  padding:10px 12px;width:100%;min-height:200px;resize:vertical;
}
.mfooter{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.mrow{display:flex;gap:8px;flex-wrap:wrap}
.mrow>*{flex:1;min-width:130px}
.msect{display:flex;flex-direction:column;gap:5px}
.msect label{font-family:var(--font-mono);font-size:.65rem;color:var(--muted)}

/* â”€â”€ TAB CONTENT â”€â”€ */
.tab-pane{display:none;flex:1;overflow:hidden;flex-direction:column}
.tab-pane.active{display:flex}
.pane-inner{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
.pane-header{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pane-header h2{font-family:var(--font-mono);font-size:.8rem;letter-spacing:.08em}

/* â”€â”€ OUTPUT BOX â”€â”€ */
.out-box{
  background:var(--bg);border:1px solid var(--border);
  border-radius:var(--r);padding:16px;
  font-size:.9rem;line-height:1.75;
  white-space:pre-wrap;word-break:break-word;
  overflow-y:auto;flex:1;
}
.out-box.placeholder{color:var(--muted);font-style:italic}

/* â”€â”€ NOTE CARDS â”€â”€ */
.note-card{
  background:var(--bg);border:1px solid var(--border);
  border-radius:var(--r);padding:12px;
  display:flex;flex-direction:column;gap:6px;
  animation:fadeIn .2s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}}
.note-meta{font-family:var(--font-mono);font-size:.62rem;color:var(--muted)}
.note-body{font-size:.88rem;line-height:1.65;white-space:pre-wrap}
.note-acts{display:flex;gap:5px;flex-wrap:wrap}
.note-edit{
  border:1px solid var(--border);background:var(--surface);
  color:var(--text);font-family:var(--font-body);font-size:.88rem;
  padding:6px 8px;border-radius:4px;width:100%;resize:none;min-height:60px;
}

/* â”€â”€ CONCEPT MAP â”€â”€ */
.cmap-wrap{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r2);padding:20px;
  display:flex;flex-wrap:wrap;gap:10px;
  min-height:180px;align-items:flex-start;align-content:flex-start;
}
.cnode{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--r);padding:7px 12px;
  font-family:var(--font-mono);font-size:.68rem;cursor:pointer;
  transition:background .15s,color .15s;
}
.cnode:hover{background:var(--accent);color:#fff}
.cnode.central{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600}
.branch-box{
  background:var(--surface2);border:1px solid var(--border);
  border-top-width:3px;border-radius:var(--r);
  padding:10px;min-width:150px;max-width:210px;
}
.branch-title{font-family:var(--font-mono);font-size:.65rem;font-weight:500;margin-bottom:6px}
.branch-chips{display:flex;flex-wrap:wrap;gap:4px}

/* â”€â”€ TRANSLATE GRID â”€â”€ */
.trans-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:14px;flex:1;min-height:0;
}
@media(max-width:600px){.trans-grid{grid-template-columns:1fr}}
.trans-col{display:flex;flex-direction:column;gap:5px;min-height:0}
.trans-lbl{font-family:var(--font-mono);font-size:.63rem;color:var(--muted)}

/* â”€â”€ LOADING â”€â”€ */
.lbar{
  position:fixed;top:0;left:0;height:3px;
  background:linear-gradient(90deg,var(--accent),var(--blue));
  z-index:999;width:0%;transition:width .3s;pointer-events:none;
}
.toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
  background:var(--btn);color:var(--btn-txt);
  padding:9px 18px;border-radius:20px;
  font-family:var(--font-mono);font-size:.73rem;
  z-index:999;opacity:0;pointer-events:none;
  transition:opacity .25s,transform .25s;white-space:nowrap;
  box-shadow:0 4px 20px var(--shadow);
}
.toast.on{opacity:1;transform:translateX(-50%) translateY(-3px)}
.spin{animation:spin .8s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ FONT ROW â”€â”€ */
.font-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.font-row label{font-family:var(--font-mono);font-size:.63rem;color:var(--muted)}
.font-row select{width:auto}

/* hidden */
#filePDF,#fileTXT{display:none}
</style>
</head>
<body>

<div class="lbar" id="lbar"></div>
<div class="toast" id="toast"></div>
<input type="file" id="filePDF" accept=".pdf"/>
<input type="file" id="fileTXT" accept=".txt,.md"/>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="logo">STOICA<em>READER</em><sup>v3</sup></div>
  <div class="hdr-right">
    <button class="icon-btn" id="btnTheme" title="Claro/Oscuro">ğŸŒ™</button>
    <button class="icon-btn" id="btnFS"    title="Pantalla completa">â›¶</button>
    <button class="icon-btn" id="btnSide"  title="Panel lateral">â–</button>
    <button class="icon-btn" id="btnFloat" title="Control flotante">âŠ•</button>
  </div>
</header>

<!-- â•â•â• TABS â•â•â• -->
<div class="tabs">
  <button class="tab active" data-tab="reader">ğŸ“– Lector</button>
  <button class="tab" data-tab="notes">ğŸ“ Notas</button>
  <button class="tab" data-tab="summary">ğŸ“‹ Resumen</button>
  <button class="tab" data-tab="questions">â“ Preguntas</button>
  <button class="tab" data-tab="mindmap">ğŸ—º Mapa</button>
  <button class="tab" data-tab="translate">ğŸŒ TraducciÃ³n</button>
</div>

<!-- â•â•â• TOOLBAR â•â•â• -->
<div class="toolbar">
  <button class="btn" id="btnPDF">ğŸ“„ PDF</button>
  <button class="btn" id="btnTXT">ğŸ“ TXT</button>
  <button class="btn ghost" id="btnPaste">ğŸ“‹ Pegar</button>
  <div class="sep"></div>
  <div class="font-row">
    <label>Fuente</label>
    <select id="selFont">
      <option value="'Crimson Pro',Georgia,serif">Crimson</option>
      <option value="Georgia,serif">Georgia</option>
      <option value="'Fira Code',monospace">Mono</option>
      <option value="Arial,sans-serif">Arial</option>
      <option value="'Courier New',monospace">Courier</option>
    </select>
    <label>TamaÃ±o</label>
    <select id="selSize">
      <option value="14px">14</option><option value="16px">16</option>
      <option value="18px" selected>18</option><option value="20px">20</option>
      <option value="24px">24</option><option value="28px">28</option>
    </select>
    <label>LÃ­nea</label>
    <select id="selLH">
      <option value="1.5">1.5</option>
      <option value="1.9" selected>1.9</option>
      <option value="2.3">2.3</option>
    </select>
  </div>
  <div class="sep"></div>
  <button class="btn ghost" id="btnHL">ğŸ–Š Resaltar</button>
  <button class="btn ghost" id="btnSaveNote">ğŸ’¾ Guardar nota</button>
</div>

<!-- â•â•â• STATS â•â•â• -->
<div class="statsbar">
  <span>Palabras: <b id="sWords">0</b></span>
  <span>PÃ¡ginas: <b id="sPages">0</b></span>
  <span>â± <b id="sTime">0 min</b></span>
  <span>PosiciÃ³n: <b id="sPos">0%</b></span>
  <span id="statusPill" class="pill">Detenido</span>
</div>

<!-- â•â•â• PROGRESS BAR â•â•â• -->
<div class="prog-wrap">
  <div class="prog-track" id="progTrack">
    <div class="prog-fill" id="progFill"></div>
  </div>
</div>

<!-- â•â•â• TAB: READER â•â•â• -->
<div class="tab-pane active" id="tab-reader">
  <div class="layout">
    <div class="reader-pane" id="readerPane">
      <div id="textDisplay" class="empty"></div>
    </div>
    <aside class="side" id="sidePanel">
      <div class="side-inner">
        <!-- Voice controls -->
        <div class="card">
          <h3>ğŸ™ Voz</h3>
          <select id="voiceSel"></select>
          <div class="ctrl-lbl">Velocidad: <b id="rateVal">1.0</b>x</div>
          <input type="range" id="rateR" min=".5" max="2.5" step=".1" value="1"/>
          <div class="ctrl-lbl">Tono: <b id="pitchVal">1.0</b></div>
          <input type="range" id="pitchR" min=".5" max="2" step=".1" value="1"/>
          <div class="ctrl-lbl">Volumen: <b id="volVal">100</b>%</div>
          <input type="range" id="volR" min="0" max="1" step=".05" value="1"/>
        </div>
        <!-- Export audio -->
        <div class="card">
          <h3>ğŸ”Š Exportar audio</h3>
          <input type="text" id="audioName" placeholder="nombre-del-audio"/>
          <button class="btn green" id="btnExport">â¬‡ Exportar WebM/audio</button>
          <span style="font-family:var(--font-mono);font-size:.6rem;color:var(--muted)">Inicia la lectura y el audio se grabarÃ¡. Al detener, se descarga.</span>
        </div>
        <!-- Quick translate -->
        <div class="card">
          <h3>ğŸŒ TraducciÃ³n rÃ¡pida</h3>
          <select id="sideTransDest">
            <option value="es">â†’ EspaÃ±ol</option>
            <option value="en">â†’ InglÃ©s</option>
            <option value="fr">â†’ FrancÃ©s</option>
            <option value="de">â†’ AlemÃ¡n</option>
            <option value="pt">â†’ PortuguÃ©s</option>
            <option value="it">â†’ Italiano</option>
          </select>
          <button class="btn blue" id="btnQuickTrans">ğŸŒ Traducir texto</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- â•â•â• TAB: NOTAS â•â•â• -->
<div class="tab-pane" id="tab-notes">
  <div class="pane-inner">
    <div class="pane-header">
      <h2>ğŸ“ MIS NOTAS</h2>
      <button class="btn ghost" id="btnClearNotes" style="margin-left:auto">ğŸ—‘ Limpiar todo</button>
      <button class="btn" id="btnExportNotes">â¬‡ Exportar .txt</button>
    </div>
    <p id="emptyNotes" style="font-family:var(--font-mono);font-size:.73rem;color:var(--muted)">
      Selecciona texto en el lector y pulsa "ğŸ’¾ Guardar nota".
    </p>
    <div id="notesContainer"></div>
  </div>
</div>

<!-- â•â•â• TAB: RESUMEN â•â•â• -->
<div class="tab-pane" id="tab-summary">
  <div class="pane-inner">
    <div class="pane-header">
      <h2>ğŸ“‹ RESUMEN AUTOMÃTICO</h2>
      <select id="selSummLevel">
        <option value="breve">Breve (3-5 oraciones)</option>
        <option value="intermedio" selected>Intermedio (1-2 pÃ¡rrafos)</option>
        <option value="detallado">Detallado (anÃ¡lisis completo)</option>
      </select>
      <button class="btn" id="btnGenSumm">âœ¨ Generar</button>
      <button class="btn ghost" id="btnCopySumm">ğŸ“‹ Copiar</button>
      <button class="btn ghost" id="btnExportSumm">â¬‡ TXT</button>
    </div>
    <div id="summOut" class="out-box placeholder">El resumen aparecerÃ¡ aquÃ­. Carga texto primero, luego pulsa "Generar".</div>
  </div>
</div>

<!-- â•â•â• TAB: PREGUNTAS â•â•â• -->
<div class="tab-pane" id="tab-questions">
  <div class="pane-inner">
    <div class="pane-header">
      <h2>â“ PREGUNTAS AUTOMÃTICAS</h2>
      <select id="selQType">
        <option value="mixtas">Mixtas</option>
        <option value="abiertas">Abiertas</option>
        <option value="cerradas">Cerradas</option>
        <option value="multiple">OpciÃ³n mÃºltiple</option>
      </select>
      <select id="selQLevel">
        <option value="literal">Literal</option>
        <option value="inferencial">Inferencial</option>
        <option value="critico">CrÃ­tico-valorativo</option>
        <option value="analogico">AnalÃ³gico-intertextual</option>
      </select>
      <input type="number" id="qCount" value="10" min="5" max="30"
        style="width:55px;border:1px solid var(--border);border-radius:var(--r);background:var(--bg);color:var(--text);font-family:var(--font-mono);font-size:.68rem;padding:5px 7px"/>
      <button class="btn" id="btnGenQ">âœ¨ Generar</button>
      <button class="btn ghost" id="btnCopyQ">ğŸ“‹ Copiar</button>
    </div>
    <div id="questOut" class="out-box placeholder">Las preguntas con respuesta y justificaciÃ³n aparecerÃ¡n aquÃ­.</div>
  </div>
</div>

<!-- â•â•â• TAB: MAPA â•â•â• -->
<div class="tab-pane" id="tab-mindmap">
  <div class="pane-inner">
    <div class="pane-header">
      <h2>ğŸ—º MAPA CONCEPTUAL</h2>
      <button class="btn" id="btnGenMap">âœ¨ Generar mapa</button>
    </div>
    <div id="cmapOut" class="cmap-wrap">
      <span style="font-family:var(--font-mono);font-size:.73rem;color:var(--muted)">El mapa visual de conceptos aparecerÃ¡ aquÃ­.</span>
    </div>
    <div>
      <div style="font-family:var(--font-mono);font-size:.63rem;color:var(--muted);margin-bottom:6px">IDEAS CLAVE</div>
      <div id="ideasOut" class="out-box placeholder" style="max-height:180px">Las ideas clave del texto aparecerÃ¡n aquÃ­.</div>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: TRADUCCIÃ“N â•â•â• -->
<div class="tab-pane" id="tab-translate">
  <div class="pane-inner" style="height:100%">
    <div class="pane-header">
      <h2>ğŸŒ TRADUCCIÃ“N</h2>
      <select id="transSrc" style="min-width:130px">
        <option value="auto">Detectar idioma</option>
        <option value="es">EspaÃ±ol</option><option value="en">InglÃ©s</option>
        <option value="fr">FrancÃ©s</option><option value="de">AlemÃ¡n</option>
        <option value="pt">PortuguÃ©s</option><option value="it">Italiano</option>
        <option value="zh">Chino</option><option value="ja">JaponÃ©s</option>
        <option value="ar">Ãrabe</option><option value="ru">Ruso</option>
      </select>
      <span style="font-family:var(--font-mono)">â†’</span>
      <select id="transDest" style="min-width:130px">
        <option value="es" selected>EspaÃ±ol</option>
        <option value="en">InglÃ©s</option><option value="fr">FrancÃ©s</option>
        <option value="de">AlemÃ¡n</option><option value="pt">PortuguÃ©s</option>
        <option value="it">Italiano</option><option value="zh">Chino</option>
        <option value="ja">JaponÃ©s</option><option value="ar">Ãrabe</option>
        <option value="ru">Ruso</option>
      </select>
      <button class="btn" id="btnTransAll">ğŸŒ Traducir todo</button>
      <button class="btn ghost" id="btnTransSel">ğŸŒ SelecciÃ³n</button>
      <button class="btn ghost" id="btnCopyTrans">ğŸ“‹ Copiar</button>
    </div>
    <div class="trans-grid" style="flex:1">
      <div class="trans-col">
        <div class="trans-lbl">ORIGINAL</div>
        <div id="transOrig" class="out-box placeholder" style="flex:1">El texto original aparecerÃ¡ aquÃ­.</div>
      </div>
      <div class="trans-col">
        <div class="trans-lbl">TRADUCCIÃ“N</div>
        <div id="transOut" class="out-box placeholder" style="flex:1">La traducciÃ³n aparecerÃ¡ aquÃ­.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• TTS BAR â•â•â• -->
<div class="tts-bar">
  <button class="play-btn blue" id="btnReadSel" title="Leer selecciÃ³n">â—ˆ</button>
  <button class="play-btn" id="btnPlay" title="Reproducir / Pausar">â–¶</button>
  <button class="icon-btn" id="btnStop" title="Detener" style="width:40px;height:40px;font-size:1rem">â¹</button>
  <div class="tts-hint">Espacio = pausa Â· Esc = detener Â· â—ˆ = leer selecciÃ³n</div>
</div>

<!-- â•â•â• FLOAT CONTROL â•â•â• -->
<div id="floatCtrl" class="off">
  <div class="fc-drag" id="fcDrag">â‹®â‹®</div>
  <button class="fc-btn red" id="fc-play">â–¶</button>
  <button class="fc-btn" id="fc-stop">â¹</button>
  <div class="fc-speed" id="fcSpeed">1.0x</div>
  <button class="fc-btn" id="fc-slow" title="MÃ¡s lento">ğŸ¢</button>
  <button class="fc-btn" id="fc-fast" title="MÃ¡s rÃ¡pido">âš¡</button>
</div>

<!-- â•â•â• PASTE MODAL â•â•â• -->
<div class="overlay" id="pasteModal">
  <div class="modal">
    <h2>ğŸ“‹ Pegar texto</h2>
    <textarea id="pasteArea" placeholder="Pega aquÃ­ tu textoâ€¦"></textarea>
    <div class="mfooter">
      <button class="btn ghost" id="btnCancelPaste">Cancelar</button>
      <button class="btn" id="btnConfirmPaste">Cargar texto â€º</button>
    </div>
  </div>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER v3 â€” Full Engine
   - Claude API via Netlify Function (/.netlify/functions/claude)
   - Synchronized word highlighting (onboundary)
   - Interactive progress bar with seek
   - Drag-and-drop float control
   - Notes persisted in localStorage
   - PDF extraction with pdf.js
   - Export audio via MediaRecorder
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $  = id => document.getElementById(id);
const qs = (s, ctx=document) => ctx.querySelector(s);
const API_ENDPOINT = '/.netlify/functions/claude';

function showToast(msg, dur=2800){
  const t=$('toast'); t.textContent=msg;
  t.classList.add('on');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('on'), dur);
}
function setLoad(pct){
  $('lbar').style.width=pct+'%';
  if(pct>=100) setTimeout(()=>$('lbar').style.width='0%',500);
}
function escH(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function dlText(text,name){
  const b=new Blob([text],{type:'text/plain;charset=utf-8'});
  const u=URL.createObjectURL(b);
  const a=document.createElement('a');
  a.href=u;a.download=name;a.click();
  URL.revokeObjectURL(u);
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fullText='';
let wordEls=[];
let curWord=0;
let synth=window.speechSynthesis;
let voices=[];
let utt=null;
let playing=false, paused=false;
let notes=JSON.parse(localStorage.getItem('stoica_notes')||'[]');
let mediaRec=null, audioChunks=[];
let recording=false;

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnTheme').addEventListener('click',()=>{
  const d=document.documentElement.dataset.theme==='dark';
  document.documentElement.dataset.theme=d?'light':'dark';
  $('btnTheme').textContent=d?'ğŸŒ™':'â˜€ï¸';
});

// â”€â”€ FULLSCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnFS').addEventListener('click',()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
});

// â”€â”€ SIDE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnSide').addEventListener('click',()=>$('sidePanel').classList.toggle('off'));

// â”€â”€ FLOAT TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnFloat').addEventListener('click',()=>$('floatCtrl').classList.toggle('off'));

// â”€â”€ FONT / SIZE / LINE-HEIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('selFont').addEventListener('change',()=>{
  document.documentElement.style.setProperty('--font-body',$('selFont').value);
});
$('selSize').addEventListener('change',()=>{
  document.documentElement.style.setProperty('--fs',$('selSize').value);
});
$('selLH').addEventListener('change',()=>{
  document.documentElement.style.setProperty('--lh',$('selLH').value);
});

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    $('tab-'+tab.dataset.tab).classList.add('active');
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXT LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadText(text, src='Texto'){
  fullText=text.trim();
  if(!fullText){showToast('El texto estÃ¡ vacÃ­o.');return;}
  const disp=$('textDisplay');
  disp.classList.remove('empty');
  buildSpans(fullText);
  updateStats();
  stopSpeech();
  setProgress(0);
  showToast(`âœ“ ${src} â€” ${fullText.split(/\s+/).filter(Boolean).length.toLocaleString()} palabras`);
}

function buildSpans(text){
  // Split into tokens preserving whitespace
  const tokens=text.split(/(\s+)/);
  let html=''; let wi=0;
  tokens.forEach(tok=>{
    if(/\S/.test(tok)){
      html+=`<span class="w" data-i="${wi}">${escH(tok)}</span>`;
      wi++;
    } else {
      html+=escH(tok);
    }
  });
  $('textDisplay').innerHTML=html;
  wordEls=[...$('textDisplay').querySelectorAll('.w')];
  curWord=0;
}

function updateStats(){
  const w=fullText?fullText.split(/\s+/).filter(Boolean).length:0;
  $('sWords').textContent=w.toLocaleString();
  $('sPages').textContent=Math.max(1,Math.ceil(w/250));
  $('sTime').textContent=Math.max(1,Math.round(w/200))+' min';
}

// â”€â”€ PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pdfjsLib.GlobalWorkerOptions.workerSrc=
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

$('btnPDF').addEventListener('click',()=>$('filePDF').click());
$('filePDF').addEventListener('change',async e=>{
  const file=e.target.files[0]; if(!file)return;
  setLoad(10);
  showToast('â³ Leyendo PDFâ€¦',10000);
  try{
    const ab=await file.arrayBuffer(); setLoad(30);
    const pdf=await pdfjsLib.getDocument({data:ab}).promise;
    setLoad(40);
    let text='';
    for(let i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i);
      const content=await page.getTextContent();
      // Reconstruct paragraphs from items
      let pageText='';
      let lastY=null;
      content.items.forEach(item=>{
        if(lastY!==null && Math.abs(item.transform[5]-lastY)>5) pageText+='\n';
        pageText+=item.str+' ';
        lastY=item.transform[5];
      });
      text+=pageText+'\n\n';
      setLoad(40+Math.round((i/pdf.numPages)*55));
    }
    setLoad(100);
    loadText(text, file.name);
  }catch(err){
    showToast('Error PDF: '+err.message);
    setLoad(100);
  }
  $('filePDF').value='';
});

// â”€â”€ TXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnTXT').addEventListener('click',()=>$('fileTXT').click());
$('fileTXT').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file)return;
  setLoad(20);
  const r=new FileReader();
  r.onload=ev=>{setLoad(100);loadText(ev.target.result,file.name)};
  r.readAsText(file,'UTF-8');
  $('fileTXT').value='';
});

// â”€â”€ PASTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnPaste').addEventListener('click',()=>{$('pasteModal').classList.add('open');$('pasteArea').focus()});
$('btnCancelPaste').addEventListener('click',()=>{$('pasteModal').classList.remove('open');$('pasteArea').value=''});
$('btnConfirmPaste').addEventListener('click',()=>{
  const t=$('pasteArea').value.trim();
  if(t) loadText(t,'Texto pegado');
  $('pasteModal').classList.remove('open');
  $('pasteArea').value='';
});
$('pasteModal').addEventListener('click',e=>{if(e.target===$('pasteModal')) $('btnCancelPaste').click()});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HIGHLIGHT & NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('btnHL').addEventListener('click',()=>{
  const sel=window.getSelection();
  if(!sel||sel.isCollapsed){showToast('Selecciona texto primero.');return;}
  const range=sel.getRangeAt(0);
  const mark=document.createElement('mark');
  mark.className='hl';
  try{range.surroundContents(mark);sel.removeAllRanges();showToast('âœ“ Texto resaltado');}
  catch(e){showToast('No se puede resaltar esa selecciÃ³n.');}
});

$('btnSaveNote').addEventListener('click',()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(!txt){showToast('Selecciona texto para guardar como nota.');return;}
  addNote(txt);
  sel.removeAllRanges();
  showToast('âœ“ Nota guardada');
});

function addNote(text){
  notes.unshift({id:Date.now(),text,date:new Date().toLocaleString('es-CO')});
  persistNotes();renderNotes();
}
function persistNotes(){localStorage.setItem('stoica_notes',JSON.stringify(notes));}
function renderNotes(){
  const c=$('notesContainer');
  $('emptyNotes').style.display=notes.length?'none':'block';
  c.innerHTML='';
  notes.forEach(n=>{
    const d=document.createElement('div');
    d.className='note-card';
    d.dataset.id=n.id;
    d.innerHTML=`
      <div class="note-meta">${n.date}</div>
      <div class="note-body">${escH(n.text)}</div>
      <div class="note-acts">
        <button class="btn ghost" onclick="editNote(${n.id})">âœï¸ Editar</button>
        <button class="btn ghost" onclick="delNote(${n.id})">ğŸ—‘ Eliminar</button>
        <button class="btn ghost" onclick="speakText(decodeURIComponent('${encodeURIComponent(n.text)}'))">ğŸ”Š Leer</button>
      </div>`;
    c.appendChild(d);
  });
}
window.editNote=function(id){
  const n=notes.find(x=>x.id===id);
  if(!n)return;
  const card=qs(`.note-card[data-id="${id}"]`);
  const body=qs('.note-body',card);
  const ta=document.createElement('textarea');
  ta.className='note-edit'; ta.value=n.text;
  body.replaceWith(ta);
  qs('.note-acts',card).innerHTML=`
    <button class="btn" onclick="saveEdit(${id})">ğŸ’¾ Guardar</button>
    <button class="btn ghost" onclick="renderNotes()">Cancelar</button>`;
};
window.saveEdit=function(id){
  const card=qs(`.note-card[data-id="${id}"]`);
  const ta=qs('textarea',card);
  const n=notes.find(x=>x.id===id);
  if(n&&ta){n.text=ta.value;persistNotes();renderNotes();showToast('âœ“ Nota actualizada');}
};
window.delNote=function(id){
  notes=notes.filter(x=>x.id!==id);
  persistNotes();renderNotes();showToast('Nota eliminada');
};
$('btnClearNotes').addEventListener('click',()=>{
  if(confirm('Â¿Eliminar todas las notas?')){notes=[];persistNotes();renderNotes();}
});
$('btnExportNotes').addEventListener('click',()=>{
  const txt=notes.map(n=>`[${n.date}]\n${n.text}`).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n');
  dlText(txt||'Sin notas.','stoica-notas.txt');
});
renderNotes();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPEECH SYNTHESIS + SYNCHRONIZED HIGHLIGHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadVoices(){
  voices=synth.getVoices();
  const sel=$('voiceSel'); sel.innerHTML='';
  let esIdx=0;
  voices.forEach((v,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=`${v.name} (${v.lang})`;
    sel.appendChild(o);
    if(v.lang.startsWith('es')&&!esIdx) esIdx=i;
  });
  sel.value=esIdx;
}
loadVoices();
if(speechSynthesis.onvoiceschanged!==undefined) speechSynthesis.onvoiceschanged=loadVoices;

// Sliders
$('rateR').addEventListener('input',()=>{
  $('rateVal').textContent=parseFloat($('rateR').value).toFixed(1);
  $('fcSpeed').textContent=parseFloat($('rateR').value).toFixed(1)+'x';
});
$('pitchR').addEventListener('input',()=>$('pitchVal').textContent=parseFloat($('pitchR').value).toFixed(1));
$('volR').addEventListener('input',()=>$('volVal').textContent=Math.round(parseFloat($('volR').value)*100));

function makeUtt(text){
  const u=new SpeechSynthesisUtterance(text);
  u.rate=parseFloat($('rateR').value);
  u.pitch=parseFloat($('pitchR').value);
  u.volume=parseFloat($('volR').value);
  const vi=parseInt($('voiceSel').value);
  if(voices[vi]) u.voice=voices[vi];

  u.onstart=()=>{
    playing=true;paused=false;
    $('btnPlay').textContent='â¸';
    $('fc-play').textContent='â¸';
    $('statusPill').textContent='â–¶ Reproduciendo';
    $('statusPill').className='pill playing';
  };
  u.onpause=()=>{
    paused=true;
    $('btnPlay').textContent='â–¶';
    $('fc-play').textContent='â–¶';
    $('statusPill').textContent='â¸ Pausado';
    $('statusPill').className='pill paused';
  };
  u.onresume=()=>{
    paused=false;
    $('btnPlay').textContent='â¸';
    $('fc-play').textContent='â¸';
    $('statusPill').textContent='â–¶ Reproduciendo';
    $('statusPill').className='pill playing';
  };
  u.onend=u.onerror=()=>{
    playing=false;paused=false;utt=null;
    $('btnPlay').textContent='â–¶';
    $('fc-play').textContent='â–¶';
    $('statusPill').textContent='Detenido';
    $('statusPill').className='pill';
    clearHL();
    stopRecording();
  };

  // â”€â”€ SYNCHRONIZED WORD HIGHLIGHTING â”€â”€
  // onboundary fires with charIndex for each word boundary
  u.onboundary=ev=>{
    if(ev.name!=='word') return;
    const ci=ev.charIndex;
    // Count word index by counting whitespace-separated tokens before ci in text
    const before=text.substring(0,ci);
    const wIdx=before.split(/\s+/).filter(Boolean).length;
    highlightWord(wIdx, text.length);
  };

  return u;
}

function highlightWord(wIdx, totalChars){
  if(!wordEls.length) return;
  // Un-highlight previous
  if(curWord<wordEls.length) wordEls[curWord].classList.remove('now');
  // Mark past words done (batched)
  // Just mark current as now
  curWord=Math.min(wIdx, wordEls.length-1);
  const el=wordEls[curWord];
  if(!el) return;
  el.classList.add('now');
  // Scroll word into view smoothly
  el.scrollIntoView({behavior:'smooth',block:'center'});
  // Progress
  const pct=Math.round((curWord/Math.max(1,wordEls.length-1))*100);
  setProgress(pct);
}

function clearHL(){
  wordEls.forEach(w=>w.classList.remove('now','past'));
  curWord=0;
  setProgress(0);
}

window.speakText=function(text){
  if(!text.trim()) return;
  synth.cancel();
  clearHL();
  utt=makeUtt(text);
  // Chrome bug: speech stops after ~15s if tab not active â€” keep alive
  keepSynthAlive();
  synth.speak(utt);
};

// Chrome keepalive for long texts
let keepAliveTimer=null;
function keepSynthAlive(){
  clearInterval(keepAliveTimer);
  keepAliveTimer=setInterval(()=>{
    if(!synth.speaking){clearInterval(keepAliveTimer);return;}
    // pause/resume trick to prevent Chrome from killing TTS
    // Only needed in background, check visibility
    if(document.hidden){
      synth.pause();
      setTimeout(()=>{if(playing&&paused) synth.resume();},50);
    }
  },10000);
}

function stopSpeech(){
  clearInterval(keepAliveTimer);
  synth.cancel();
  playing=false;paused=false;utt=null;
  $('btnPlay').textContent='â–¶';
  $('fc-play').textContent='â–¶';
  $('statusPill').textContent='Detenido';
  $('statusPill').className='pill';
  clearHL();
  stopRecording();
}

function togglePlay(){
  if(!playing&&!paused){
    const txt=fullText||$('textDisplay').textContent;
    if(!txt.trim()){showToast('Carga texto primero.');return;}
    speakText(txt);
  } else if(playing&&!paused){
    synth.pause();
  } else if(paused){
    synth.resume();
  }
}

$('btnPlay').addEventListener('click',togglePlay);
$('fc-play').addEventListener('click',togglePlay);
$('btnStop').addEventListener('click',stopSpeech);
$('fc-stop').addEventListener('click',stopSpeech);
$('btnReadSel').addEventListener('click',()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(txt) speakText(txt);
  else showToast('Selecciona texto para leer.');
});

// Float speed buttons
$('fc-slow').addEventListener('click',()=>{
  const v=Math.max(.5,parseFloat($('rateR').value)-.1);
  $('rateR').value=v;
  $('rateVal').textContent=v.toFixed(1);
  $('fcSpeed').textContent=v.toFixed(1)+'x';
});
$('fc-fast').addEventListener('click',()=>{
  const v=Math.min(2.5,parseFloat($('rateR').value)+.1);
  $('rateR').value=v;
  $('rateVal').textContent=v.toFixed(1);
  $('fcSpeed').textContent=v.toFixed(1)+'x';
});

// â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setProgress(pct){
  $('progFill').style.width=pct+'%';
  $('sPos').textContent=pct+'%';
}
$('progTrack').addEventListener('click',e=>{
  if(!fullText){showToast('Carga texto primero.');return;}
  const rect=$('progTrack').getBoundingClientRect();
  const pct=Math.max(0,Math.min(100,((e.clientX-rect.left)/rect.width)*100));
  const wIdx=Math.floor((pct/100)*wordEls.length);
  stopSpeech();
  // Restart from that word
  const words=fullText.split(/\s+/).filter(Boolean);
  const remaining=words.slice(wIdx).join(' ');
  curWord=wIdx;
  setTimeout(()=>{
    speakText(remaining);
    if(wordEls[wIdx]) wordEls[wIdx].scrollIntoView({behavior:'smooth',block:'center'});
  },80);
  setProgress(Math.round(pct));
});

// â”€â”€ FLOAT DRAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const el=$('floatCtrl');
  const handle=$('fcDrag');
  let ox,oy,ex,ey;
  handle.addEventListener('mousedown',e=>{
    ex=el.offsetLeft; ey=el.offsetTop;
    ox=e.clientX; oy=e.clientY;
    e.preventDefault();
    const mm=ev=>{
      el.style.right='auto';el.style.bottom='auto';
      el.style.left=(ex+ev.clientX-ox)+'px';
      el.style.top=(ey+ev.clientY-oy)+'px';
    };
    document.addEventListener('mousemove',mm);
    document.addEventListener('mouseup',()=>document.removeEventListener('mousemove',mm),{once:true});
  });
  // Touch support
  handle.addEventListener('touchstart',e=>{
    const t=e.touches[0];
    ex=el.offsetLeft; ey=el.offsetTop;
    ox=t.clientX; oy=t.clientY;
    const tm=ev=>{
      const t2=ev.touches[0];
      el.style.right='auto';el.style.bottom='auto';
      el.style.left=(ex+t2.clientX-ox)+'px';
      el.style.top=(ey+t2.clientY-oy)+'px';
    };
    document.addEventListener('touchmove',tm);
    document.addEventListener('touchend',()=>document.removeEventListener('touchmove',tm),{once:true});
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stopRecording(){
  if(mediaRec&&recording){
    mediaRec.stop();
  }
  recording=false;
}

$('btnExport').addEventListener('click',async()=>{
  const text=fullText.trim()||$('textDisplay').textContent.trim();
  if(!text){showToast('Carga texto primero.');return;}
  const name=($('audioName').value.trim()||'stoica-audio').replace(/[^\w-]/g,'_');

  // Try to use MediaRecorder on audio output
  // Best approach: capture via getUserMedia with system audio (Chrome: screen capture with audio)
  try{
    // Request screen capture including audio tab
    const stream=await navigator.mediaDevices.getDisplayMedia({
      video:true,audio:{echoCancellation:false,noiseSuppression:false}
    });
    // We only want audio
    const audioTracks=stream.getAudioTracks();
    if(!audioTracks.length){
      stream.getTracks().forEach(t=>t.stop());
      throw new Error('Sin pista de audio. Activa "Compartir audio del sistema" o "Compartir audio de la pestaÃ±a".');
    }
    const audioStream=new MediaStream(audioTracks);
    stream.getVideoTracks().forEach(t=>t.stop()); // stop video

    audioChunks=[];
    mediaRec=new MediaRecorder(audioStream,{mimeType:MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm'});
    mediaRec.ondataavailable=e=>audioChunks.push(e.data);
    mediaRec.onstop=()=>{
      const blob=new Blob(audioChunks,{type:'audio/webm'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download=name+'.webm';a.click();
      URL.revokeObjectURL(url);
      audioStream.getTracks().forEach(t=>t.stop());
      showToast('âœ“ Audio exportado como '+name+'.webm');
      recording=false;
    };
    mediaRec.start();
    recording=true;
    showToast('ğŸ”´ Grabandoâ€¦ inicia la lectura ahora. Pulsa â¹ para guardar.',5000);
    speakText(text);
  }catch(err){
    showToast('ExportaciÃ³n: '+err.message);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUDE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callClaude(prompt, maxTokens=2000){
  const res=await fetch(API_ENDPOINT,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      model:'claude-sonnet-4-20250514',
      max_tokens:maxTokens,
      messages:[{role:'user',content:prompt}]
    })
  });
  const data=await res.json();
  if(data.error) throw new Error(
    typeof data.error==='string'?data.error:
    (data.error.message||JSON.stringify(data.error))
  );
  return data.content.map(b=>b.text||'').join('');
}

function getAIText(){
  const t=fullText.trim();
  if(!t){showToast('Carga texto primero.');return null;}
  return t.length>8000?t.substring(0,8000)+'[â€¦texto truncadoâ€¦]':t;
}

// â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUMM_LEVEL={
  breve:'3 a 5 oraciones concisas que capturen la esencia del texto',
  intermedio:'1 a 2 pÃ¡rrafos completos con las ideas principales y secundarias',
  detallado:'un anÃ¡lisis completo con: introducciÃ³n, desarrollo (ideas principales, argumentos, ejemplos), y conclusiÃ³n'
};
$('btnGenSumm').addEventListener('click',async()=>{
  const text=getAIText(); if(!text)return;
  const level=$('selSummLevel').value;
  $('summOut').textContent='â³ Generando resumenâ€¦';
  $('summOut').classList.remove('placeholder');
  setLoad(20);
  try{
    const r=await callClaude(
      `Genera un resumen en espaÃ±ol del siguiente texto. El resumen debe tener ${SUMM_LEVEL[level]}. Escribe solo el resumen, sin tÃ­tulos ni explicaciones adicionales.\n\nTexto:\n${text}`,
      1200
    );
    $('summOut').textContent=r;
    setLoad(100);showToast('âœ“ Resumen generado');
  }catch(e){
    $('summOut').textContent='âŒ '+e.message+'\n\nVerifica que la clave CLAUDE_API_KEY estÃ© configurada en Netlify â†’ Site Settings â†’ Environment Variables.';
    setLoad(100);
  }
});
$('btnCopySumm').addEventListener('click',()=>{
  navigator.clipboard.writeText($('summOut').textContent).then(()=>showToast('âœ“ Resumen copiado'));
});
$('btnExportSumm').addEventListener('click',()=>{
  dlText($('summOut').textContent,'stoica-resumen.txt');
});

// â”€â”€ QUESTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const QTYPE={
  mixtas:'variadas (incluye preguntas abiertas, cerradas y de opciÃ³n mÃºltiple con 4 alternativas A, B, C, D)',
  abiertas:'abiertas (requieren respuesta elaborada)',
  cerradas:'cerradas de SÃ­/No con justificaciÃ³n',
  multiple:'de opciÃ³n mÃºltiple con 4 alternativas (A, B, C, D) indicando cuÃ¡l es la correcta'
};
const QLEVEL={
  literal:'nivel LITERAL â€” informaciÃ³n explÃ­cita, datos directos del texto',
  inferencial:'nivel INFERENCIAL â€” deducciones, conclusiones implÃ­citas, relaciones causales',
  critico:'nivel CRÃTICO-VALORATIVO â€” juicios, opiniones, evaluaciÃ³n de argumentos',
  analogico:'nivel ANALÃ“GICO-INTERTEXTUAL â€” comparaciones con otros textos, contextos o situaciones'
};
$('btnGenQ').addEventListener('click',async()=>{
  const text=getAIText(); if(!text)return;
  const n=parseInt($('qCount').value)||10;
  const qt=QTYPE[$('selQType').value];
  const ql=QLEVEL[$('selQLevel').value];
  $('questOut').textContent='â³ Generando '+n+' preguntasâ€¦';
  $('questOut').classList.remove('placeholder');
  setLoad(20);
  try{
    const r=await callClaude(
      `Genera exactamente ${n} preguntas en espaÃ±ol sobre el siguiente texto.

Tipo: ${qt}.
Nivel: ${ql}.

Para cada pregunta usa este formato exacto:

PREGUNTA [nÃºmero]:
[Texto de la pregunta]
${$('selQType').value==='multiple'?'A) ...\nB) ...\nC) ...\nD) ...\n':''}
RESPUESTA: [Respuesta correcta o mejor respuesta]
JUSTIFICACIÃ“N: [Por quÃ© esa es la respuesta â€” cita del texto o razonamiento]

---

Texto:
${text}`,
      2500
    );
    $('questOut').textContent=r;
    setLoad(100);showToast('âœ“ '+n+' preguntas generadas');
  }catch(e){
    $('questOut').textContent='âŒ '+e.message;
    setLoad(100);
  }
});
$('btnCopyQ').addEventListener('click',()=>{
  navigator.clipboard.writeText($('questOut').textContent).then(()=>showToast('âœ“ Preguntas copiadas'));
});

// â”€â”€ MIND MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnGenMap').addEventListener('click',async()=>{
  const text=getAIText(); if(!text)return;
  $('cmapOut').innerHTML='<span style="font-family:var(--font-mono);font-size:.73rem;color:var(--muted)">â³ Generando mapa conceptualâ€¦</span>';
  $('ideasOut').textContent='â³ Analizando ideas claveâ€¦';
  $('ideasOut').classList.remove('placeholder');
  setLoad(20);
  try{
    const r=await callClaude(
      `Analiza el siguiente texto y responde ÃšNICAMENTE con un objeto JSON vÃ¡lido con esta estructura exacta (sin markdown, sin backticks, sin texto extra antes o despuÃ©s):
{
  "central": "tema central en mÃ¡ximo 4 palabras",
  "ramas": [
    {"nombre": "categorÃ­a 1", "color": "#c0392b", "conceptos": ["concepto a", "concepto b", "concepto c"]},
    {"nombre": "categorÃ­a 2", "color": "#2c4a7c", "conceptos": ["concepto d", "concepto e"]}
  ],
  "ideas_clave": ["Idea principal 1", "Idea principal 2", "Idea principal 3", "Idea principal 4", "Idea principal 5"]
}
Genera entre 4 y 6 ramas. Cada rama con 3-5 conceptos cortos. Solo JSON.

Texto:
${text}`,
      1500
    );
    setLoad(80);
    let parsed;
    try{
      const clean=r.replace(/```json|```/g,'').trim();
      // Find first { to last }
      const start=clean.indexOf('{');
      const end=clean.lastIndexOf('}');
      parsed=JSON.parse(clean.substring(start,end+1));
    }catch(pe){
      throw new Error('No se pudo parsear el mapa. Respuesta: '+r.substring(0,200));
    }
    renderMap(parsed);
    setLoad(100);showToast('âœ“ Mapa generado');
  }catch(e){
    $('cmapOut').innerHTML=`<span style="color:var(--accent);font-family:var(--font-mono);font-size:.73rem">âŒ ${escH(e.message)}</span>`;
    setLoad(100);
  }
});

function renderMap(data){
  const c=$('cmapOut');
  let html=`<div style="width:100%;display:flex;flex-direction:column;gap:16px">`;
  html+=`<div style="text-align:center"><span class="cnode central">${escH(data.central||'Tema central')}</span></div>`;
  html+=`<div style="display:flex;flex-wrap:wrap;gap:14px;justify-content:center">`;
  (data.ramas||[]).forEach(rama=>{
    const col=rama.color||'var(--accent)';
    html+=`<div class="branch-box" style="border-top-color:${col}">
      <div class="branch-title" style="color:${col}">${escH(rama.nombre)}</div>
      <div class="branch-chips">`;
    (rama.conceptos||[]).forEach(c2=>{
      html+=`<span class="cnode" style="font-size:.63rem;padding:4px 8px">${escH(c2)}</span>`;
    });
    html+=`</div></div>`;
  });
  html+=`</div></div>`;
  c.innerHTML=html;
  $('ideasOut').textContent=(data.ideas_clave||[]).map((x,i)=>`${i+1}. ${x}`).join('\n');
}

// â”€â”€ TRANSLATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LANG_NAMES={
  auto:'el idioma del texto',es:'espaÃ±ol',en:'inglÃ©s',fr:'francÃ©s',
  de:'alemÃ¡n',pt:'portuguÃ©s',it:'italiano',zh:'chino',
  ja:'japonÃ©s',ar:'Ã¡rabe',ru:'ruso'
};
async function doTranslate(text, src, dest){
  const srcStr=src==='auto'?'detectando el idioma automÃ¡ticamente':'del '+LANG_NAMES[src];
  const r=await callClaude(
    `Traduce el siguiente texto ${srcStr} al ${LANG_NAMES[dest]}.
Responde ÃšNICAMENTE con la traducciÃ³n, sin comentarios, sin explicaciones, sin comillas adicionales.

Texto:
${text}`,
    2000
  );
  return r.trim();
}

$('btnTransAll').addEventListener('click',async()=>{
  const text=fullText.trim(); if(!text){showToast('Carga texto primero.');return;}
  const src=$('transSrc').value, dest=$('transDest').value;
  const truncated=text.length>6000?text.substring(0,6000)+'[â€¦]':text;
  $('transOrig').textContent=truncated;
  $('transOrig').classList.remove('placeholder');
  $('transOut').textContent='â³ Traduciendoâ€¦';
  $('transOut').classList.remove('placeholder');
  setLoad(20);
  try{
    const r=await doTranslate(truncated,src,dest);
    $('transOut').textContent=r;
    setLoad(100);showToast('âœ“ TraducciÃ³n completada');
  }catch(e){
    $('transOut').textContent='âŒ '+e.message;
    setLoad(100);
  }
});

$('btnTransSel').addEventListener('click',async()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(!txt){showToast('Selecciona texto primero.');return;}
  const src=$('transSrc').value, dest=$('transDest').value;
  $('transOrig').textContent=txt;
  $('transOrig').classList.remove('placeholder');
  $('transOut').textContent='â³ Traduciendoâ€¦';
  $('transOut').classList.remove('placeholder');
  setLoad(20);
  try{
    const r=await doTranslate(txt,src,dest);
    $('transOut').textContent=r;
    setLoad(100);showToast('âœ“ TraducciÃ³n completada');
    // Switch to translate tab
    document.querySelector('[data-tab="translate"]').click();
  }catch(e){
    $('transOut').textContent='âŒ '+e.message;
    setLoad(100);
  }
});

$('btnCopyTrans').addEventListener('click',()=>{
  navigator.clipboard.writeText($('transOut').textContent).then(()=>showToast('âœ“ TraducciÃ³n copiada'));
});

// Quick translate from sidebar
$('btnQuickTrans').addEventListener('click',async()=>{
  const text=fullText.trim(); if(!text){showToast('Carga texto primero.');return;}
  const dest=$('sideTransDest').value;
  const truncated=text.length>6000?text.substring(0,6000)+'[â€¦]':text;
  showToast('â³ Traduciendoâ€¦ espera un momento.',6000);
  setLoad(20);
  try{
    const r=await doTranslate(truncated,'auto',dest);
    $('transOrig').textContent=truncated;
    $('transOrig').classList.remove('placeholder');
    $('transOut').textContent=r;
    $('transOut').classList.remove('placeholder');
    document.querySelector('[data-tab="translate"]').click();
    setLoad(100);showToast('âœ“ TraducciÃ³n completada');
  }catch(e){
    showToast('âŒ '+e.message);
    setLoad(100);
  }
});

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  const tag=e.target.tagName;
  if(tag==='TEXTAREA'||tag==='INPUT') return;
  if(e.code==='Space'){e.preventDefault();togglePlay();}
  if(e.code==='Escape') stopSpeech();
});

// â”€â”€ SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}

console.log('%câœ¦ STOICA READER v3 â€” Listo','color:#c0392b;font-family:monospace;font-weight:bold;font-size:13px');
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Stoica Reader</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#1a1410"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400;1,600&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER â€” 100% GRATUITO
   Sin APIs de pago. Todo en el navegador.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:        #f6f1e9;
  --surf:      #ede7db;
  --surf2:     #e2dace;
  --bdr:       #c4b99e;
  --txt:       #1a1410;
  --muted:     #7a6f5e;
  --acc:       #b5341e;
  --acc2:      #1e3a5f;
  --acc3:      #1e5f3a;
  --gold:      #9a6f00;
  --hi:        rgba(181,52,30,.15);
  --hi-now:    #b5341e;
  --btn:       #1a1410;
  --btnT:      #f6f1e9;
  --shad:      rgba(26,20,16,.12);
  --r: 8px; --r2: 14px;
  --fs: 18px; --lh: 1.9;
  --fBody: 'Lora', Georgia, serif;
  --fMono: 'JetBrains Mono', monospace;
}
[data-theme=dark] {
  --bg:#111018; --surf:#18161f; --surf2:#201e2a;
  --bdr:#2e2c3d; --txt:#eae6f8; --muted:#706c88;
  --acc:#e05c6c; --acc2:#7c9fd6; --acc3:#52b788; --gold:#d4a84b;
  --hi:rgba(224,92,108,.13); --hi-now:#e05c6c;
  --btn:#eae6f8; --btnT:#111018;
  --shad:rgba(0,0,0,.4);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{
  font-family:var(--fBody);background:var(--bg);color:var(--txt);
  display:flex;flex-direction:column;
  transition:background .3s,color .3s;
}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px}

/* â”€â”€ HEADER â”€â”€ */
header {
  height:50px;background:var(--surf);border-bottom:1px solid var(--bdr);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;flex-shrink:0;
  box-shadow:0 2px 12px var(--shad);z-index:60;
}
.logo {
  font-family:var(--fMono);font-size:.88rem;font-weight:600;
  letter-spacing:.16em;color:var(--acc);
  display:flex;align-items:center;gap:8px;
}
.logo em{color:var(--txt);font-style:normal}
.logo .badge {
  font-size:.52rem;background:var(--acc3);color:#fff;
  padding:1px 6px;border-radius:10px;letter-spacing:.04em;font-weight:400;
}
.hdr-r{display:flex;gap:4px;align-items:center}

/* â”€â”€ TABS â”€â”€ */
.tabs {
  display:flex;background:var(--surf);border-bottom:1px solid var(--bdr);
  padding:0 16px;flex-shrink:0;overflow-x:auto;
}
.tabs::-webkit-scrollbar{height:0}
.tab {
  padding:6px 13px;font-family:var(--fMono);font-size:.66rem;
  letter-spacing:.07em;border:none;background:none;
  color:var(--muted);cursor:pointer;white-space:nowrap;
  border-bottom:2px solid transparent;
  transition:color .15s,border-color .15s;
}
.tab.on{color:var(--acc);border-bottom-color:var(--acc)}
.tab:hover:not(.on){color:var(--txt)}

/* â”€â”€ TOOLBAR â”€â”€ */
.bar {
  display:flex;flex-wrap:wrap;gap:5px;padding:7px 16px;
  background:var(--surf);border-bottom:1px solid var(--bdr);
  align-items:center;flex-shrink:0;
}
.vline{width:1px;height:20px;background:var(--bdr);margin:0 2px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display:inline-flex;align-items:center;gap:4px;
  padding:5px 12px;border-radius:var(--r);
  border:1px solid var(--bdr);background:var(--btn);color:var(--btnT);
  font-family:var(--fMono);font-size:.66rem;letter-spacing:.04em;
  cursor:pointer;white-space:nowrap;
  transition:opacity .15s,transform .1s;
}
.btn:hover{opacity:.82}
.btn:active{transform:scale(.97)}
.btn.g  {background:transparent;color:var(--txt)}
.btn.b  {background:var(--acc2);color:#fff;border-color:var(--acc2)}
.btn.gr {background:var(--acc3);color:#fff;border-color:var(--acc3)}
.btn.go {background:var(--gold);color:#fff;border-color:var(--gold)}
.btn.red{background:var(--acc);color:#fff;border-color:var(--acc)}
.ibtn {
  background:none;border:1px solid var(--bdr);border-radius:var(--r);
  color:var(--txt);cursor:pointer;width:31px;height:31px;
  display:flex;align-items:center;justify-content:center;font-size:.82rem;
  transition:background .15s;flex-shrink:0;
}
.ibtn:hover{background:var(--surf2)}

/* â”€â”€ STATS BAR â”€â”€ */
.stats {
  display:flex;gap:14px;flex-wrap:wrap;padding:4px 16px;
  background:var(--bg);border-bottom:1px solid var(--bdr);
  font-family:var(--fMono);font-size:.62rem;color:var(--muted);
  align-items:center;flex-shrink:0;
}
.stats b{color:var(--txt);font-weight:500}
.pill {
  font-family:var(--fMono);font-size:.6rem;padding:2px 8px;
  border-radius:20px;background:var(--bdr);color:var(--muted);
}
.pill.play{background:var(--acc);color:#fff;animation:blink 1.4s infinite}
.pill.pause{background:var(--acc2);color:#fff}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.65}}

/* â”€â”€ PROGRESS BAR â”€â”€ */
.pbwrap{
  padding:0 16px 5px;background:var(--bg);
  border-bottom:1px solid var(--bdr);flex-shrink:0;
}
.pbtrack{
  width:100%;height:5px;background:var(--surf2);
  border-radius:3px;cursor:pointer;overflow:hidden;
  position:relative;
}
.pbfill{
  height:100%;width:0%;border-radius:3px;pointer-events:none;
  background:linear-gradient(90deg,var(--acc),var(--acc2));
  transition:width .15s;
}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:flex;flex:1;overflow:hidden;min-height:0}

/* â”€â”€ READER PANE â”€â”€ */
.rpane{flex:1;overflow-y:auto;padding:44px 80px;min-width:0}
@media(max-width:680px){.rpane{padding:24px 16px}}
#textDisplay{
  font-size:var(--fs);line-height:var(--lh);
  white-space:pre-wrap;word-break:break-word;
  outline:none;max-width:780px;margin:0 auto;
}
#textDisplay.mt::before{
  content:'Carga un PDF, un .txt, o pega tu texto aquÃ­â€¦';
  color:var(--muted);font-style:italic;pointer-events:none;
}
.w{display:inline}
.w.now{
  background:var(--hi-now);color:#fff;border-radius:3px;padding:0 2px;
  box-shadow:0 0 10px rgba(181,52,30,.3);
}
.w.done{background:var(--hi);border-radius:2px}
mark.hl{background:#f6d44c;color:#1a1410;border-radius:2px;padding:0 1px}

/* â”€â”€ SIDE PANEL â”€â”€ */
.side{
  width:300px;min-width:280px;
  border-left:1px solid var(--bdr);background:var(--surf);
  display:flex;flex-direction:column;overflow:hidden;
  flex-shrink:0;transition:width .22s,min-width .22s;
}
.side.off{width:0;min-width:0;border:none}
.sinner{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.card{
  background:var(--bg);border:1px solid var(--bdr);
  border-radius:var(--r2);padding:12px;
  display:flex;flex-direction:column;gap:7px;
}
.card h3{font-family:var(--fMono);font-size:.62rem;letter-spacing:.1em;color:var(--muted);text-transform:uppercase}
.sl-lbl{font-family:var(--fMono);font-size:.62rem;color:var(--muted);display:flex;justify-content:space-between}
input[type=range]{width:100%;accent-color:var(--acc);cursor:pointer;height:4px}
select,input[type=text]{
  border:1px solid var(--bdr);border-radius:var(--r);
  background:var(--bg);color:var(--txt);
  font-family:var(--fMono);font-size:.66rem;padding:5px 8px;
}
select{width:100%;cursor:pointer}

/* â”€â”€ TTS BAR â”€â”€ */
.ttsbar{
  background:var(--surf);border-top:1px solid var(--bdr);
  padding:10px 16px;display:flex;align-items:center;gap:9px;
  flex-shrink:0;box-shadow:0 -3px 12px var(--shad);z-index:40;
}
.pbig{
  width:44px;height:44px;border-radius:50%;border:none;
  background:var(--acc);color:#fff;font-size:1.1rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:transform .15s,box-shadow .15s;flex-shrink:0;
  box-shadow:0 4px 14px rgba(181,52,30,.35);
}
.pbig:hover{transform:scale(1.08)}
.pbig.b2{background:var(--acc2);box-shadow:0 4px 14px rgba(30,58,95,.3)}
.hint{font-family:var(--fMono);font-size:.6rem;color:var(--muted);margin-left:auto}

/* â”€â”€ FLOAT â”€â”€ */
#fc{
  position:fixed;bottom:100px;right:16px;
  background:var(--surf2);border:1px solid var(--bdr);
  border-radius:var(--r2);padding:10px;
  display:flex;flex-direction:column;gap:6px;align-items:center;
  box-shadow:0 8px 30px var(--shad);z-index:300;
  cursor:move;user-select:none;
  transition:opacity .2s,transform .2s;
}
#fc.off{opacity:0;pointer-events:none;transform:scale(.82) translateY(8px)}
.fcdrg{font-family:var(--fMono);font-size:.56rem;color:var(--muted);letter-spacing:.08em;cursor:grab}
.fcspd{font-family:var(--fMono);font-size:.66rem;color:var(--muted);text-align:center}
.fcbtn{
  width:36px;height:36px;border-radius:50%;border:1px solid var(--bdr);
  background:var(--bg);color:var(--txt);font-size:.85rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:background .15s;
}
.fcbtn:hover{background:var(--surf2)}
.fcbtn.r{background:var(--acc);color:#fff;border-color:var(--acc)}

/* â”€â”€ OVERLAY â”€â”€ */
.ov{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
  z-index:500;align-items:center;justify-content:center;
  backdrop-filter:blur(3px);
}
.ov.on{display:flex}
.modal{
  background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r2);
  padding:24px;width:min(580px,96vw);max-height:90vh;overflow-y:auto;
  box-shadow:0 20px 60px var(--shad);display:flex;flex-direction:column;gap:12px;
  animation:mIn .18s ease;
}
@keyframes mIn{from{opacity:0;transform:scale(.95) translateY(8px)}}
.modal h2{font-family:var(--fMono);font-size:.82rem;letter-spacing:.07em}
.modal textarea{
  border:1px solid var(--bdr);border-radius:var(--r);
  background:var(--bg);color:var(--txt);font-family:var(--fBody);font-size:.95rem;
  padding:10px 12px;width:100%;min-height:200px;resize:vertical;
}
.mfooter{display:flex;gap:7px;justify-content:flex-end;flex-wrap:wrap}

/* â”€â”€ TAB PANES â”€â”€ */
.tpane{display:none;flex:1;overflow:hidden;flex-direction:column}
.tpane.on{display:flex}
.pinner{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.phead{display:flex;gap:7px;flex-wrap:wrap;align-items:center}
.phead h2{font-family:var(--fMono);font-size:.78rem;letter-spacing:.08em}

/* â”€â”€ OUTPUT â”€â”€ */
.out{
  background:var(--bg);border:1px solid var(--bdr);border-radius:var(--r);
  padding:16px;font-size:.9rem;line-height:1.75;
  white-space:pre-wrap;word-break:break-word;overflow-y:auto;flex:1;
}
.out.mt{color:var(--muted);font-style:italic}

/* â”€â”€ NOTES â”€â”€ */
.ncard{
  background:var(--bg);border:1px solid var(--bdr);border-radius:var(--r);
  padding:12px;display:flex;flex-direction:column;gap:6px;
  animation:fi .18s ease;
}
@keyframes fi{from{opacity:0;transform:translateY(3px)}}
.nmeta{font-family:var(--fMono);font-size:.6rem;color:var(--muted)}
.nbody{font-size:.87rem;line-height:1.65;white-space:pre-wrap}
.nacts{display:flex;gap:5px;flex-wrap:wrap}
.nta{
  border:1px solid var(--bdr);background:var(--surf);color:var(--txt);
  font-family:var(--fBody);font-size:.87rem;padding:6px 8px;
  border-radius:4px;width:100%;resize:none;min-height:60px;
}

/* â”€â”€ TRANSLATE â”€â”€ */
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1;min-height:0}
@media(max-width:580px){.tgrid{grid-template-columns:1fr}}
.tcol{display:flex;flex-direction:column;gap:5px;min-height:0}
.tlbl{font-family:var(--fMono);font-size:.6rem;color:var(--muted)}

/* â”€â”€ MAP â”€â”€ */
.mapwrap{
  background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r2);
  padding:18px;display:flex;flex-wrap:wrap;gap:10px;
  min-height:160px;align-items:flex-start;align-content:flex-start;
}
.mnode{
  background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);
  padding:6px 11px;font-family:var(--fMono);font-size:.64rem;cursor:pointer;
  transition:background .15s,color .15s;
}
.mnode:hover{background:var(--acc);color:#fff}
.mnode.ctr{background:var(--acc);color:#fff;border-color:var(--acc);font-weight:600}
.branch{
  background:var(--surf2);border:1px solid var(--bdr);
  border-top-width:3px;border-radius:var(--r);
  padding:10px;min-width:140px;max-width:200px;
}
.btitle{font-family:var(--fMono);font-size:.62rem;font-weight:600;margin-bottom:6px}
.bchips{display:flex;flex-wrap:wrap;gap:4px}

/* â”€â”€ QUESTIONS â”€â”€ */
.qcard{
  background:var(--bg);border:1px solid var(--bdr);border-radius:var(--r);
  padding:13px;margin-bottom:8px;display:flex;flex-direction:column;gap:6px;
}
.qnum{font-family:var(--fMono);font-size:.6rem;color:var(--muted)}
.qtxt{font-size:.9rem;font-weight:600;line-height:1.5}
.qans{
  font-size:.84rem;padding-top:7px;border-top:1px dashed var(--bdr);
  display:none;color:var(--txt);
}
.qans.vis{display:block}
.qjust{font-size:.78rem;color:var(--muted);margin-top:3px;font-style:italic}
.qopts label{display:block;font-size:.84rem;margin:3px 0;cursor:pointer}
.qopts label:hover{color:var(--acc)}

/* â”€â”€ LOADING â”€â”€ */
.lbar{
  position:fixed;top:0;left:0;height:3px;
  background:linear-gradient(90deg,var(--acc),var(--acc2));
  z-index:999;width:0%;transition:width .25s;pointer-events:none;
}
.toast{
  position:fixed;bottom:76px;left:50%;transform:translateX(-50%);
  background:var(--btn);color:var(--btnT);
  padding:8px 16px;border-radius:20px;
  font-family:var(--fMono);font-size:.7rem;
  z-index:999;opacity:0;pointer-events:none;
  transition:opacity .22s,transform .22s;white-space:nowrap;
  box-shadow:0 4px 18px var(--shad);
}
.toast.on{opacity:1;transform:translateX(-50%) translateY(-3px)}

/* â”€â”€ FONT ROW â”€â”€ */
.frow{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.frow label{font-family:var(--fMono);font-size:.6rem;color:var(--muted)}
.frow select{width:auto}

/* â”€â”€ SPINNER â”€â”€ */
.spin{display:inline-block;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}

/* hidden */
#filePDF,#fileTXT{display:none}

/* â”€â”€ AUDIO EXPORT STATUS â”€â”€ */
.rec-badge{
  display:inline-flex;align-items:center;gap:5px;
  font-family:var(--fMono);font-size:.66rem;
  background:var(--acc);color:#fff;padding:3px 9px;border-radius:12px;
}
.rec-dot{width:7px;height:7px;background:#fff;border-radius:50%;animation:blink 1s infinite}

/* â”€â”€ SEARCH â”€â”€ */
.srchwrap{
  display:flex;gap:6px;align-items:center;
  background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);
  padding:4px 10px;
}
.srchwrap input{
  border:none;background:transparent;color:var(--txt);
  font-family:var(--fMono);font-size:.7rem;outline:none;flex:1;min-width:0;
}
mark.find{background:#f6d44c;color:#1a1410;border-radius:2px}
mark.find.cur{background:var(--acc);color:#fff}
</style>
</head>
<body>

<div class="lbar" id="lb"></div>
<div class="toast" id="toast"></div>
<input type="file" id="filePDF" accept=".pdf"/>
<input type="file" id="fileTXT" accept=".txt,.md,.csv"/>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="logo">
    STOICA<em>READER</em>
    <span class="badge">100% gratis</span>
  </div>
  <div class="hdr-r">
    <button class="ibtn" id="bTheme"  title="Claro / Oscuro">ğŸŒ™</button>
    <button class="ibtn" id="bFS"     title="Pantalla completa">â›¶</button>
    <button class="ibtn" id="bSide"   title="Panel lateral">â–</button>
    <button class="ibtn" id="bFloat"  title="Control flotante">âŠ•</button>
  </div>
</header>

<!-- â•â•â• TABS â•â•â• -->
<div class="tabs">
  <button class="tab on"  data-tab="reader">ğŸ“– Lector</button>
  <button class="tab"     data-tab="notes">ğŸ“ Notas</button>
  <button class="tab"     data-tab="summary">ğŸ“‹ Resumen</button>
  <button class="tab"     data-tab="questions">â“ Preguntas</button>
  <button class="tab"     data-tab="mindmap">ğŸ—º Mapa</button>
  <button class="tab"     data-tab="translate">ğŸŒ TraducciÃ³n</button>
</div>

<!-- â•â•â• TOOLBAR â•â•â• -->
<div class="bar">
  <button class="btn"  id="bPDF">ğŸ“„ Cargar PDF</button>
  <button class="btn"  id="bTXT">ğŸ“ Cargar TXT</button>
  <button class="btn g" id="bPaste">ğŸ“‹ Pegar texto</button>
  <div class="vline"></div>
  <div class="frow">
    <label>Fuente</label>
    <select id="sfont">
      <option value="'Lora',Georgia,serif">Lora</option>
      <option value="Georgia,serif">Georgia</option>
      <option value="'JetBrains Mono',monospace">Mono</option>
      <option value="Arial,sans-serif">Arial</option>
      <option value="'Courier New',monospace">Courier</option>
    </select>
    <label>TamaÃ±o</label>
    <select id="ssize">
      <option value="14px">14</option><option value="16px">16</option>
      <option value="18px" selected>18</option><option value="20px">20</option>
      <option value="24px">24</option><option value="28px">28</option>
    </select>
    <label>LÃ­nea</label>
    <select id="slh">
      <option value="1.5">1.5</option>
      <option value="1.9" selected>1.9</option>
      <option value="2.3">2.3</option>
    </select>
  </div>
  <div class="vline"></div>
  <button class="btn g" id="bHL">ğŸ–Š Resaltar</button>
  <button class="btn g" id="bNote">ğŸ’¾ Guardar nota</button>
  <div class="vline"></div>
  <!-- Search -->
  <div class="srchwrap">
    <input type="text" id="srchInput" placeholder="Buscar en el textoâ€¦"/>
    <button class="ibtn" id="bSrchPrev" style="border:none;width:22px;height:22px">â—€</button>
    <button class="ibtn" id="bSrchNext" style="border:none;width:22px;height:22px">â–¶</button>
    <span id="srchInfo" style="font-family:var(--fMono);font-size:.6rem;color:var(--muted);white-space:nowrap"></span>
  </div>
</div>

<!-- â•â•â• STATS â•â•â• -->
<div class="stats">
  <span>Palabras: <b id="sw">0</b></span>
  <span>PÃ¡ginas: <b id="sp">0</b></span>
  <span>â± <b id="st">0 min</b></span>
  <span>Avance: <b id="spos">0%</b></span>
  <span id="statPill" class="pill">Detenido</span>
</div>

<!-- â•â•â• PROGRESS BAR â•â•â• -->
<div class="pbwrap">
  <div class="pbtrack" id="pbtrack" title="Clic para ir a esa posiciÃ³n">
    <div class="pbfill" id="pbfill"></div>
  </div>
</div>

<!-- â•â•â• TAB: READER â•â•â• -->
<div class="tpane on" id="tab-reader">
  <div class="layout">
    <div class="rpane" id="rPane"><div id="textDisplay" class="mt"></div></div>
    <aside class="side" id="sideP">
      <div class="sinner">
        <!-- Voice -->
        <div class="card">
          <h3>ğŸ™ Voz y velocidad</h3>
          <select id="voiceSel"></select>
          <div class="sl-lbl"><span>Velocidad</span><b id="rV">1.0x</b></div>
          <input type="range" id="rRate" min=".5" max="2.5" step=".1" value="1"/>
          <div class="sl-lbl"><span>Tono</span><b id="pV">1.0</b></div>
          <input type="range" id="rPitch" min=".5" max="2" step=".1" value="1"/>
          <div class="sl-lbl"><span>Volumen</span><b id="vV">100%</b></div>
          <input type="range" id="rVol" min="0" max="1" step=".05" value="1"/>
        </div>
        <!-- Export audio -->
        <div class="card">
          <h3>ğŸ”Š Exportar audio</h3>
          <input type="text" id="audioName" placeholder="nombre-del-archivo"/>
          <button class="btn gr" id="bExport">â¬‡ Iniciar grabaciÃ³n</button>
          <button class="btn red" id="bStopRec" style="display:none">â¹ Detener y guardar</button>
          <div id="recStatus" style="display:none">
            <span class="rec-badge"><span class="rec-dot"></span>Grabandoâ€¦</span>
          </div>
          <p style="font-family:var(--fMono);font-size:.58rem;color:var(--muted);line-height:1.5">
            Haz clic en "Iniciar grabaciÃ³n", luego en â–¶ para leer. Al terminar, pulsa "Detener y guardar". Chrome pedirÃ¡ compartir pantalla â€” elige la pestaÃ±a actual y activa "Compartir audio de la pestaÃ±a".
          </p>
        </div>
        <!-- Quick translate -->
        <div class="card">
          <h3>ğŸŒ TraducciÃ³n rÃ¡pida</h3>
          <select id="sdest">
            <option value="es">â†’ EspaÃ±ol</option>
            <option value="en">â†’ InglÃ©s</option>
            <option value="fr">â†’ FrancÃ©s</option>
            <option value="de">â†’ AlemÃ¡n</option>
            <option value="pt">â†’ PortuguÃ©s</option>
            <option value="it">â†’ Italiano</option>
            <option value="ru">â†’ Ruso</option>
          </select>
          <button class="btn b" id="bQTrans">ğŸŒ Traducir texto</button>
          <p style="font-family:var(--fMono);font-size:.58rem;color:var(--muted)">Usa MyMemory API (gratis, sin registro).</p>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- â•â•â• TAB: NOTAS â•â•â• -->
<div class="tpane" id="tab-notes">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ“ MIS NOTAS</h2>
      <button class="btn g" id="bClearNotes" style="margin-left:auto">ğŸ—‘ Limpiar todo</button>
      <button class="btn"   id="bExNotes">â¬‡ Exportar .txt</button>
    </div>
    <p id="emptyN" style="font-family:var(--fMono);font-size:.72rem;color:var(--muted)">
      Selecciona texto en el lector â†’ pulsa "ğŸ’¾ Guardar nota".
    </p>
    <div id="notesCont"></div>
  </div>
</div>

<!-- â•â•â• TAB: RESUMEN â•â•â• -->
<div class="tpane" id="tab-summary">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ“‹ RESUMEN AUTOMÃTICO</h2>
      <select id="sLevel">
        <option value="breve">Breve (~5 oraciones)</option>
        <option value="medio" selected>Intermedio (~10 oraciones)</option>
        <option value="completo">Detallado (~20 oraciones)</option>
      </select>
      <button class="btn"   id="bSumm">âœ¨ Generar</button>
      <button class="btn g" id="bCopySumm">ğŸ“‹ Copiar</button>
      <button class="btn g" id="bExSumm">â¬‡ TXT</button>
    </div>
    <div style="font-family:var(--fMono);font-size:.62rem;color:var(--muted);
      background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r);padding:8px 12px;">
      âœ… Funciona <b>sin internet</b> â€” algoritmo de resumen extractivo (extrae las oraciones mÃ¡s importantes por frecuencia de palabras). No usa ninguna API de pago.
    </div>
    <div id="summOut" class="out mt">El resumen aparecerÃ¡ aquÃ­. Carga un texto y pulsa "Generar".</div>
  </div>
</div>

<!-- â•â•â• TAB: PREGUNTAS â•â•â• -->
<div class="tpane" id="tab-questions">
  <div class="pinner">
    <div class="phead">
      <h2>â“ PREGUNTAS DE COMPRENSIÃ“N</h2>
      <select id="qType">
        <option value="literal">Literal</option>
        <option value="inferencial">Inferencial</option>
        <option value="mixto" selected>Mixto</option>
      </select>
      <input type="number" id="qNum" value="10" min="5" max="30"
        style="width:52px;border:1px solid var(--bdr);border-radius:var(--r);
        background:var(--bg);color:var(--txt);font-family:var(--fMono);font-size:.66rem;padding:5px 7px"/>
      <button class="btn" id="bGenQ">âœ¨ Generar</button>
      <button class="btn g" id="bCopyQ">ğŸ“‹ Copiar</button>
    </div>
    <div style="font-family:var(--fMono);font-size:.62rem;color:var(--muted);
      background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r);padding:8px 12px;">
      âœ… Genera preguntas <b>sin internet</b> â€” analiza las oraciones mÃ¡s importantes del texto. Haz clic en cada pregunta para ver la respuesta y justificaciÃ³n.
    </div>
    <div id="questOut"></div>
  </div>
</div>

<!-- â•â•â• TAB: MAPA â•â•â• -->
<div class="tpane" id="tab-mindmap">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ—º MAPA CONCEPTUAL</h2>
      <button class="btn" id="bGenMap">âœ¨ Generar mapa</button>
    </div>
    <div style="font-family:var(--fMono);font-size:.62rem;color:var(--muted);
      background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r);padding:8px 12px;">
      âœ… Extrae conceptos clave <b>sin internet</b> â€” anÃ¡lisis TF-IDF de frecuencia de tÃ©rminos.
    </div>
    <div id="mapOut" class="mapwrap">
      <span style="font-family:var(--fMono);font-size:.7rem;color:var(--muted)">El mapa conceptual aparecerÃ¡ aquÃ­.</span>
    </div>
    <div>
      <div class="tlbl" style="margin-bottom:5px">IDEAS CLAVE EXTRAÃDAS</div>
      <div id="ideasOut" class="out mt" style="max-height:200px">Las ideas clave aparecerÃ¡n aquÃ­.</div>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: TRADUCCIÃ“N â•â•â• -->
<div class="tpane" id="tab-translate">
  <div class="pinner" style="height:100%">
    <div class="phead">
      <h2>ğŸŒ TRADUCCIÃ“N</h2>
      <select id="tSrc" style="min-width:120px">
        <option value="auto">Detectar idioma</option>
        <option value="es">EspaÃ±ol</option>
        <option value="en">InglÃ©s</option>
        <option value="fr">FrancÃ©s</option>
        <option value="de">AlemÃ¡n</option>
        <option value="pt">PortuguÃ©s</option>
        <option value="it">Italiano</option>
        <option value="ru">Ruso</option>
        <option value="zh">Chino</option>
        <option value="ar">Ãrabe</option>
        <option value="ja">JaponÃ©s</option>
      </select>
      <span style="font-family:var(--fMono)">â†’</span>
      <select id="tDest" style="min-width:120px">
        <option value="es" selected>EspaÃ±ol</option>
        <option value="en">InglÃ©s</option>
        <option value="fr">FrancÃ©s</option>
        <option value="de">AlemÃ¡n</option>
        <option value="pt">PortuguÃ©s</option>
        <option value="it">Italiano</option>
        <option value="ru">Ruso</option>
        <option value="zh">Chino</option>
        <option value="ar">Ãrabe</option>
        <option value="ja">JaponÃ©s</option>
      </select>
      <button class="btn"   id="bTransAll">ğŸŒ Traducir todo</button>
      <button class="btn g" id="bTransSel">ğŸŒ SelecciÃ³n</button>
      <button class="btn g" id="bCopyTrans">ğŸ“‹ Copiar</button>
    </div>
    <div style="font-family:var(--fMono);font-size:.62rem;color:var(--muted);
      background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r);padding:8px 12px;">
      âœ… Usa <b>MyMemory</b> (API gratuita, sin registro, sin clave). LÃ­mite: 10.000 palabras/dÃ­a. Para textos largos, traduce por secciones.
    </div>
    <div class="tgrid" style="flex:1">
      <div class="tcol">
        <div class="tlbl">TEXTO ORIGINAL</div>
        <div id="tOrig" class="out mt" style="flex:1">El texto original aparecerÃ¡ aquÃ­.</div>
      </div>
      <div class="tcol">
        <div class="tlbl">TRADUCCIÃ“N</div>
        <div id="tOut" class="out mt" style="flex:1">La traducciÃ³n aparecerÃ¡ aquÃ­.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• TTS BAR â•â•â• -->
<div class="ttsbar">
  <button class="pbig b2" id="bSel" title="Leer selecciÃ³n">â—ˆ</button>
  <button class="pbig"    id="bPlay" title="Reproducir / Pausar">â–¶</button>
  <button class="ibtn"    id="bStop" title="Detener" style="width:38px;height:38px;font-size:.95rem">â¹</button>
  <div class="hint">Espacio = pausar Â· Esc = detener Â· â—ˆ = leer selecciÃ³n</div>
</div>

<!-- â•â•â• CONTROL FLOTANTE â•â•â• -->
<div id="fc" class="off">
  <div class="fcdrg" id="fcdrag">â‹®â‹®</div>
  <button class="fcbtn r" id="fc-p">â–¶</button>
  <button class="fcbtn"   id="fc-s">â¹</button>
  <div class="fcspd" id="fcspd">1.0x</div>
  <button class="fcbtn" id="fc-sl" title="MÃ¡s lento">ğŸ¢</button>
  <button class="fcbtn" id="fc-fa" title="MÃ¡s rÃ¡pido">âš¡</button>
</div>

<!-- â•â•â• MODAL: PEGAR â•â•â• -->
<div class="ov" id="pasteOv">
  <div class="modal">
    <h2>ğŸ“‹ Pegar texto</h2>
    <textarea id="pasteA" placeholder="Pega aquÃ­ tu textoâ€¦"></textarea>
    <div class="mfooter">
      <button class="btn g" id="bCancelP">Cancelar</button>
      <button class="btn"   id="bConfP">Cargar texto â€º</button>
    </div>
  </div>
</div>

<!-- PDF.js (Mozilla, 100% gratuito y open source) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER â€” Motor completo, 100% gratuito
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Sin APIs de pago. Todas las funciones corren en el navegador.

   FUNCIONES:
   â€¢ Lectura en voz (Web Speech API â€” nativa, gratis)
   â€¢ Resaltado sincronizado palabra x palabra (onboundary)
   â€¢ Barra de progreso interactiva con seek
   â€¢ Carga PDF (PDF.js â€” open source, gratis)
   â€¢ Carga TXT / pegar texto
   â€¢ Notas (localStorage â€” gratis)
   â€¢ Resumen extractivo (algoritmo TF-IDF propio â€” gratis, offline)
   â€¢ Preguntas de comprensiÃ³n (extracciÃ³n de oraciones â€” gratis, offline)
   â€¢ Mapa conceptual (TF-IDF propio â€” gratis, offline)
   â€¢ TraducciÃ³n (MyMemory API â€” gratuita, sin registro)
   â€¢ Exportar audio (MediaRecorder + getDisplayMedia â€” gratis)
   â€¢ Control flotante arrastrable
   â€¢ BÃºsqueda en el texto
   â€¢ PWA / Offline
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ UTILIDADES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $  = id => document.getElementById(id);
const qs = (s,ctx=document) => ctx.querySelector(s);
const E  = txt => txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function toast(msg, dur=2600){
  const t=$('toast'); t.textContent=msg;
  t.classList.add('on');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('on'),dur);
}
function load(pct){
  $('lb').style.width=pct+'%';
  if(pct>=100) setTimeout(()=>$('lb').style.width='0%',500);
}
function dl(text, name){
  const b=new Blob([text],{type:'text/plain;charset=utf-8'});
  const u=URL.createObjectURL(b);
  Object.assign(document.createElement('a'),{href:u,download:name}).click();
  URL.revokeObjectURL(u);
}

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fullText='';
let wordEls=[];
let curW=0;
let synth=window.speechSynthesis;
let voices=[];
let utt=null;
let playing=false, paused=false;
let notes=JSON.parse(localStorage.getItem('sr_notes')||'[]');
let mediaRec=null, recChunks=[], recording=false;
let keepTimer=null;
let srchMatches=[], srchIdx=0;

// â”€â”€ PDF.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pdfjsLib.GlobalWorkerOptions.workerSrc=
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ TEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bTheme').onclick=()=>{
  const dark=document.documentElement.dataset.theme==='dark';
  document.documentElement.dataset.theme=dark?'light':'dark';
  $('bTheme').textContent=dark?'ğŸŒ™':'â˜€ï¸';
};

// â”€â”€ PANTALLA COMPLETA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bFS').onclick=()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};

// â”€â”€ PANEL LATERAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bSide').onclick=()=>$('sideP').classList.toggle('off');

// â”€â”€ FLOTANTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bFloat').onclick=()=>$('fc').classList.toggle('off');

// â”€â”€ FUENTE / TAMAÃ‘O / INTERLINEADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('sfont').onchange=()=>document.documentElement.style.setProperty('--fBody',$('sfont').value);
$('ssize').onchange=()=>document.documentElement.style.setProperty('--fs',$('ssize').value);
$('slh').onchange=()=>document.documentElement.style.setProperty('--lh',$('slh').value);

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tpane').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    $('tab-'+t.dataset.tab).classList.add('on');
  };
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGA DE TEXTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadText(text, src='Texto'){
  fullText=text.trim();
  if(!fullText){toast('El texto estÃ¡ vacÃ­o.');return;}
  buildSpans(fullText);
  updateStats();
  stopSpeech();
  setProgress(0);
  clearSearch();
  const n=fullText.split(/\s+/).filter(Boolean).length;
  toast(`âœ“ ${src} cargado â€” ${n.toLocaleString()} palabras`);
}

function buildSpans(text){
  // Tokenize preserving whitespace and line breaks
  const tokens=text.split(/(\s+)/);
  let html=''; let wi=0;
  tokens.forEach(tok=>{
    if(/\S/.test(tok)){
      html+=`<span class="w" data-i="${wi}">${E(tok)}</span>`;
      wi++;
    } else {
      // Preserve line breaks as <br> pairs
      html+=E(tok).replace(/\n/g,'\n');
    }
  });
  const d=$('textDisplay');
  d.innerHTML=html;
  d.classList.remove('mt');
  wordEls=[...d.querySelectorAll('.w')];
  curW=0;
}

function updateStats(){
  if(!fullText){$('sw').textContent='0';$('sp').textContent='0';$('st').textContent='0 min';return;}
  const w=fullText.split(/\s+/).filter(Boolean).length;
  $('sw').textContent=w.toLocaleString();
  $('sp').textContent=Math.max(1,Math.ceil(w/250));
  $('st').textContent=Math.max(1,Math.round(w/200))+' min';
}

// â”€â”€ PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bPDF').onclick=()=>$('filePDF').click();
$('filePDF').onchange=async e=>{
  const file=e.target.files[0]; if(!file)return;
  load(10);
  toast('â³ Leyendo PDFâ€¦',12000);
  try{
    const ab=await file.arrayBuffer(); load(30);
    const pdf=await pdfjsLib.getDocument({data:ab}).promise;
    load(40);
    let text='';
    for(let i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i);
      const ct=await page.getTextContent();
      let pageText=''; let lastY=null; let lastX=null;
      ct.items.forEach(item=>{
        const y=item.transform[5];
        const x=item.transform[4];
        if(lastY!==null){
          const dy=Math.abs(y-lastY);
          if(dy>12) pageText+='\n\n'; // paragraph break
          else if(dy>4) pageText+='\n'; // line break
          else if(x-lastX>20) pageText+=' '; // word gap
        }
        pageText+=item.str;
        lastY=y; lastX=x+(item.width||0);
      });
      text+=pageText.trim()+'\n\n';
      load(40+Math.round((i/pdf.numPages)*55));
    }
    load(100);
    loadText(text, file.name);
  }catch(err){
    toast('Error al leer el PDF: '+err.message); load(100);
  }
  $('filePDF').value='';
};

// â”€â”€ TXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bTXT').onclick=()=>$('fileTXT').click();
$('fileTXT').onchange=e=>{
  const file=e.target.files[0]; if(!file)return;
  load(20);
  const r=new FileReader();
  r.onload=ev=>{load(100);loadText(ev.target.result,file.name)};
  r.readAsText(file,'UTF-8');
  $('fileTXT').value='';
};

// â”€â”€ PEGAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bPaste').onclick=()=>{$('pasteOv').classList.add('on');$('pasteA').focus()};
$('bCancelP').onclick=()=>{$('pasteOv').classList.remove('on');$('pasteA').value=''};
$('bConfP').onclick=()=>{
  const t=$('pasteA').value.trim();
  if(t) loadText(t,'Texto pegado');
  $('pasteOv').classList.remove('on');$('pasteA').value='';
};
$('pasteOv').onclick=e=>{if(e.target===$('pasteOv'))$('bCancelP').click()};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESALTADO Y NOTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('bHL').onclick=()=>{
  const sel=window.getSelection();
  if(!sel||sel.isCollapsed){toast('Selecciona texto primero.');return;}
  const range=sel.getRangeAt(0);
  const mark=document.createElement('mark');
  mark.className='hl';
  try{range.surroundContents(mark);sel.removeAllRanges();toast('âœ“ Texto resaltado');}
  catch{toast('SelecciÃ³n invÃ¡lida â€” intenta seleccionar dentro de un pÃ¡rrafo.');}
};

$('bNote').onclick=()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(!txt){toast('Selecciona texto para guardar como nota.');return;}
  addNote(txt); sel.removeAllRanges(); toast('âœ“ Nota guardada');
};

function addNote(text){
  notes.unshift({id:Date.now(),text,date:new Date().toLocaleString('es-CO')});
  saveNotes(); renderNotes();
}
function saveNotes(){localStorage.setItem('sr_notes',JSON.stringify(notes));}

function renderNotes(){
  $('emptyN').style.display=notes.length?'none':'block';
  const c=$('notesCont'); c.innerHTML='';
  notes.forEach(n=>{
    const d=document.createElement('div');
    d.className='ncard'; d.dataset.id=n.id;
    d.innerHTML=`
      <div class="nmeta">${E(n.date)}</div>
      <div class="nbody">${E(n.text)}</div>
      <div class="nacts">
        <button class="btn g" onclick="editNote(${n.id})">âœï¸ Editar</button>
        <button class="btn g" onclick="delNote(${n.id})">ğŸ—‘ Eliminar</button>
        <button class="btn g" onclick="readNote(${n.id})">ğŸ”Š Leer</button>
      </div>`;
    c.appendChild(d);
  });
}
window.editNote=function(id){
  const n=notes.find(x=>x.id===id); if(!n)return;
  const card=qs(`.ncard[data-id="${id}"]`);
  const body=qs('.nbody',card);
  const ta=document.createElement('textarea');
  ta.className='nta'; ta.value=n.text;
  body.replaceWith(ta);
  qs('.nacts',card).innerHTML=`
    <button class="btn" onclick="saveNote(${id})">ğŸ’¾ Guardar</button>
    <button class="btn g" onclick="renderNotes()">Cancelar</button>`;
};
window.saveNote=function(id){
  const ta=qs(`.ncard[data-id="${id}"] textarea`);
  const n=notes.find(x=>x.id===id);
  if(n&&ta){n.text=ta.value;saveNotes();renderNotes();toast('âœ“ Nota actualizada');}
};
window.delNote=function(id){
  if(!confirm('Â¿Eliminar esta nota?'))return;
  notes=notes.filter(x=>x.id!==id);saveNotes();renderNotes();toast('Nota eliminada');
};
window.readNote=function(id){
  const n=notes.find(x=>x.id===id); if(n) speak(n.text);
};
$('bClearNotes').onclick=()=>{
  if(!confirm('Â¿Eliminar TODAS las notas?'))return;
  notes=[];saveNotes();renderNotes();
};
$('bExNotes').onclick=()=>{
  if(!notes.length){toast('No hay notas para exportar.');return;}
  dl(notes.map(n=>`[${n.date}]\n${n.text}`).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n'),'stoica-notas.txt');
  toast('âœ“ Notas exportadas');
};
renderNotes();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BÃšSQUEDA EN EL TEXTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearSearch(){
  srchMatches=[]; srchIdx=0;
  $('srchInfo').textContent='';
  // Remove find highlights (rebuild spans)
}

$('srchInput').addEventListener('input', debounce(doSearch, 300));
$('bSrchNext').onclick=()=>{if(srchMatches.length){srchIdx=(srchIdx+1)%srchMatches.length;highlightSearchCurrent();}};
$('bSrchPrev').onclick=()=>{if(srchMatches.length){srchIdx=(srchIdx-1+srchMatches.length)%srchMatches.length;highlightSearchCurrent();}};

function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

function doSearch(){
  const q=$('srchInput').value.trim().toLowerCase();
  // Remove old highlights in text but keep word spans
  document.querySelectorAll('mark.find').forEach(m=>{
    const parent=m.parentNode;
    parent.replaceChild(document.createTextNode(m.textContent),m);
    parent.normalize();
  });
  srchMatches=[];srchIdx=0;
  if(!q||!fullText){$('srchInfo').textContent='';return;}
  // Rebuild highlighting
  const d=$('textDisplay');
  const walker=document.createTreeWalker(d,NodeFilter.SHOW_TEXT,null);
  const textNodes=[];
  let node;
  while((node=walker.nextNode())) textNodes.push(node);
  let count=0;
  textNodes.forEach(tn=>{
    const val=tn.nodeValue;
    const lower=val.toLowerCase();
    let idx=0, pos;
    const frag=document.createDocumentFragment();
    while((pos=lower.indexOf(q,idx))!==-1){
      if(pos>idx) frag.appendChild(document.createTextNode(val.slice(idx,pos)));
      const mark=document.createElement('mark');
      mark.className='find'; mark.textContent=val.slice(pos,pos+q.length);
      frag.appendChild(mark);
      srchMatches.push(mark);
      idx=pos+q.length; count++;
    }
    if(idx<val.length) frag.appendChild(document.createTextNode(val.slice(idx)));
    if(count) tn.parentNode.replaceChild(frag,tn);
  });
  $('srchInfo').textContent=count?`${count} encontrado${count!==1?'s':''}`:' sin resultados';
  if(srchMatches.length) highlightSearchCurrent();
}

function highlightSearchCurrent(){
  srchMatches.forEach((m,i)=>m.className=i===srchIdx?'find cur':'find');
  if(srchMatches[srchIdx]) srchMatches[srchIdx].scrollIntoView({behavior:'smooth',block:'center'});
  $('srchInfo').textContent=`${srchIdx+1}/${srchMatches.length}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEB SPEECH API â€” VOZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadVoices(){
  voices=synth.getVoices();
  const sel=$('voiceSel'); sel.innerHTML='';
  let esDefault=0;
  voices.forEach((v,i)=>{
    const o=document.createElement('option');
    o.value=i; o.textContent=`${v.name} (${v.lang})`;
    sel.appendChild(o);
    if(v.lang.startsWith('es')&&!esDefault){esDefault=i;}
  });
  sel.value=esDefault;
}
loadVoices();
if(speechSynthesis.onvoiceschanged!==undefined) speechSynthesis.onvoiceschanged=loadVoices;

// Sliders
$('rRate').oninput=()=>{
  const v=parseFloat($('rRate').value).toFixed(1);
  $('rV').textContent=v+'x'; $('fcspd').textContent=v+'x';
};
$('rPitch').oninput=()=>$('pV').textContent=parseFloat($('rPitch').value).toFixed(1);
$('rVol').oninput=()=>$('vV').textContent=Math.round(parseFloat($('rVol').value)*100)+'%';

// â”€â”€ Crear utterance â”€â”€
function makeUtt(text){
  const u=new SpeechSynthesisUtterance(text);
  u.rate=parseFloat($('rRate').value);
  u.pitch=parseFloat($('rPitch').value);
  u.volume=parseFloat($('rVol').value);
  const vi=parseInt($('voiceSel').value);
  if(voices[vi]) u.voice=voices[vi];

  u.onstart=()=>{
    playing=true;paused=false;
    $('bPlay').textContent='â¸'; $('fc-p').textContent='â¸';
    $('statPill').textContent='â–¶ Reproduciendo';
    $('statPill').className='pill play';
  };
  u.onpause=()=>{
    paused=true;
    $('bPlay').textContent='â–¶'; $('fc-p').textContent='â–¶';
    $('statPill').textContent='â¸ Pausado';
    $('statPill').className='pill pause';
  };
  u.onresume=()=>{
    paused=false;
    $('bPlay').textContent='â¸'; $('fc-p').textContent='â¸';
    $('statPill').textContent='â–¶ Reproduciendo';
    $('statPill').className='pill play';
  };
  u.onend=u.onerror=()=>resetPlay();

  // â”€â”€ RESALTADO SINCRONIZADO â”€â”€
  // onboundary dispara con charIndex para cada palabra
  u.onboundary=ev=>{
    if(ev.name!=='word') return;
    // Contar quÃ© palabra es por charIndex en el texto
    const before=text.substring(0,ev.charIndex);
    const wIdx=before.split(/\s+/).filter(Boolean).length;
    hlWord(wIdx);
  };

  return u;
}

function hlWord(idx){
  if(!wordEls.length) return;
  if(curW<wordEls.length) wordEls[curW].classList.remove('now');
  curW=Math.min(idx,wordEls.length-1);
  const el=wordEls[curW];
  if(!el) return;
  el.classList.add('now');
  el.scrollIntoView({behavior:'smooth',block:'center',inline:'nearest'});
  const pct=Math.round((curW/Math.max(1,wordEls.length-1))*100);
  setProgress(pct);
}

function clearHL(){
  wordEls.forEach(w=>{w.classList.remove('now','done');});
  curW=0;setProgress(0);
}

function resetPlay(){
  clearInterval(keepTimer);
  playing=false;paused=false;utt=null;
  $('bPlay').textContent='â–¶'; $('fc-p').textContent='â–¶';
  $('statPill').textContent='Detenido';
  $('statPill').className='pill';
  clearHL();
  stopRec();
}

// â”€â”€ Keep-alive para Chrome (evita que corte TTS en tabs inactivas) â”€â”€
function keepAlive(){
  clearInterval(keepTimer);
  keepTimer=setInterval(()=>{
    if(!synth.speaking){clearInterval(keepTimer);return;}
    if(document.hidden){synth.pause();setTimeout(()=>{if(playing&&paused)synth.resume();},80);}
  },12000);
}

function speak(text){
  if(!text.trim())return;
  synth.cancel();clearHL();
  utt=makeUtt(text);
  keepAlive();
  synth.speak(utt);
}

function stopSpeech(){
  clearInterval(keepTimer);
  synth.cancel();
  resetPlay();
}

function togglePlay(){
  if(!playing&&!paused){
    const txt=fullText||$('textDisplay').textContent;
    if(!txt.trim()){toast('Carga texto primero.');return;}
    speak(txt);
  } else if(playing&&!paused){
    synth.pause();
  } else if(paused){
    synth.resume();
  }
}

$('bPlay').onclick=togglePlay;
$('fc-p').onclick=togglePlay;
$('bStop').onclick=stopSpeech;
$('fc-s').onclick=stopSpeech;

$('bSel').onclick=()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(txt) speak(txt);
  else toast('Selecciona texto primero.');
};

// Float speed
$('fc-sl').onclick=()=>{
  const v=Math.max(.5,parseFloat($('rRate').value)-.1);
  $('rRate').value=v; $('rV').textContent=v.toFixed(1)+'x'; $('fcspd').textContent=v.toFixed(1)+'x';
};
$('fc-fa').onclick=()=>{
  const v=Math.min(2.5,parseFloat($('rRate').value)+.1);
  $('rRate').value=v; $('rV').textContent=v.toFixed(1)+'x'; $('fcspd').textContent=v.toFixed(1)+'x';
};

// â”€â”€ BARRA DE PROGRESO INTERACTIVA â”€â”€
function setProgress(pct){
  $('pbfill').style.width=pct+'%';
  $('spos').textContent=pct+'%';
}

$('pbtrack').onclick=e=>{
  if(!fullText){toast('Carga texto primero.');return;}
  const rect=$('pbtrack').getBoundingClientRect();
  const pct=Math.max(0,Math.min(100,((e.clientX-rect.left)/rect.width)*100));
  const wIdx=Math.floor((pct/100)*(wordEls.length-1));
  stopSpeech();
  // Reanudar desde esa palabra
  const words=fullText.split(/\s+/).filter(Boolean);
  const from=words.slice(wIdx).join(' ');
  curW=wIdx;
  setTimeout(()=>{
    speak(from);
    if(wordEls[wIdx]) wordEls[wIdx].scrollIntoView({behavior:'smooth',block:'center'});
  },80);
  setProgress(Math.round(pct));
};

// â”€â”€ ARRASTRAR FLOTANTE â”€â”€
(()=>{
  const el=$('fc'), handle=$('fcdrag');
  let ox,oy,ex,ey;
  function onMove(cx,cy){
    el.style.right='auto';el.style.bottom='auto';
    el.style.left=(ex+cx-ox)+'px';el.style.top=(ey+cy-oy)+'px';
  }
  handle.addEventListener('mousedown',e=>{
    ex=el.offsetLeft;ey=el.offsetTop;ox=e.clientX;oy=e.clientY;e.preventDefault();
    const mm=ev=>onMove(ev.clientX,ev.clientY);
    document.addEventListener('mousemove',mm);
    document.addEventListener('mouseup',()=>document.removeEventListener('mousemove',mm),{once:true});
  });
  handle.addEventListener('touchstart',e=>{
    const t=e.touches[0];
    ex=el.offsetLeft;ey=el.offsetTop;ox=t.clientX;oy=t.clientY;
    const tm=ev=>{const t2=ev.touches[0];onMove(t2.clientX,t2.clientY);};
    document.addEventListener('touchmove',tm,{passive:true});
    document.addEventListener('touchend',()=>document.removeEventListener('touchmove',tm),{once:true});
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTAR AUDIO (MediaRecorder + getDisplayMedia â€” GRATIS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('bExport').onclick=async()=>{
  const text=fullText.trim()||$('textDisplay').textContent.trim();
  if(!text){toast('Carga texto primero.');return;}
  try{
    // Request tab audio capture
    const stream=await navigator.mediaDevices.getDisplayMedia({
      video:{displaySurface:'browser'},
      audio:{echoCancellation:false,noiseSuppression:false,sampleRate:48000}
    });
    // Check audio tracks
    const aTracks=stream.getAudioTracks();
    if(!aTracks.length){
      stream.getTracks().forEach(t=>t.stop());
      toast('âš ï¸ Activa "Compartir audio de la pestaÃ±a" cuando Chrome lo pida.');
      return;
    }
    // Stop video track â€” only need audio
    stream.getVideoTracks().forEach(t=>t.stop());
    const aStream=new MediaStream(aTracks);

    recChunks=[];
    const mimeType=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ?'audio/webm;codecs=opus':'audio/webm';
    mediaRec=new MediaRecorder(aStream,{mimeType});
    mediaRec.ondataavailable=e=>{if(e.data.size>0)recChunks.push(e.data);};
    mediaRec.onstop=()=>{
      const name=($('audioName').value.trim()||'stoica-audio').replace(/[^\w\-]/g,'_');
      const blob=new Blob(recChunks,{type:'audio/webm'});
      const url=URL.createObjectURL(blob);
      Object.assign(document.createElement('a'),{href:url,download:name+'.webm'}).click();
      URL.revokeObjectURL(url);
      aStream.getTracks().forEach(t=>t.stop());
      showRecUI(false);
      toast('âœ“ Audio guardado como '+name+'.webm');
      recording=false; mediaRec=null;
    };
    mediaRec.start(1000);
    recording=true;
    showRecUI(true);
    speak(text);
    toast('ğŸ”´ Grabando â€” pulsa "Detener y guardar" cuando termines.',5000);
  }catch(err){
    if(err.name==='NotAllowedError') toast('Permiso denegado. Permite compartir la pantalla para grabar audio.');
    else toast('Error: '+err.message);
  }
};

$('bStopRec').onclick=()=>{
  stopSpeech();
  if(mediaRec&&recording) mediaRec.stop();
};

function stopRec(){
  if(mediaRec&&recording) mediaRec.stop();
}

function showRecUI(on){
  $('bExport').style.display=on?'none':'';
  $('bStopRec').style.display=on?'':'none';
  $('recStatus').style.display=on?'':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADUCCIÃ“N â€” MyMemory API (GRATIS, sin clave, sin registro)
// LÃ­mite: 10.000 palabras/dÃ­a por IP
// Docs: https://mymemory.translated.net/doc/spec.php
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANG_NAMES={
  es:'EspaÃ±ol',en:'InglÃ©s',fr:'FrancÃ©s',de:'AlemÃ¡n',
  pt:'PortuguÃ©s',it:'Italiano',ru:'Ruso',zh:'Chino',
  ar:'Ãrabe',ja:'JaponÃ©s',auto:'auto'
};

async function translateText(text, src, dest){
  // MyMemory API: GET request, no CORS issues, no key needed
  const langPair=src==='auto'?`${dest}|${dest}`:`${src}|${dest}`;
  // Split into chunks of ~500 chars (API limit per request)
  const chunks=splitChunks(text, 480);
  let translated='';
  for(let i=0;i<chunks.length;i++){
    load(Math.round((i/chunks.length)*90));
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(chunks[i])}&langpair=${src==='auto'?`en|${dest}`:langPair}`;
    const res=await fetch(url);
    if(!res.ok) throw new Error('Error de red: '+res.status);
    const data=await res.json();
    if(data.responseStatus!==200) throw new Error(data.responseDetails||'Error de traducciÃ³n');
    translated+=data.responseData.translatedText+' ';
  }
  return translated.trim();
}

function splitChunks(text, maxLen){
  // Split by sentences to preserve meaning
  const sentences=text.match(/[^.!?]+[.!?]*/g)||[text];
  const chunks=[]; let cur='';
  sentences.forEach(s=>{
    if((cur+s).length>maxLen){if(cur) chunks.push(cur.trim());cur=s;}
    else cur+=s;
  });
  if(cur.trim()) chunks.push(cur.trim());
  return chunks.length?chunks:[text];
}

async function runTranslate(text, src, dest, origEl, outEl){
  if(!text.trim()){toast('No hay texto para traducir.');return;}
  origEl.textContent=text.length>4000?text.substring(0,4000)+'[â€¦ texto truncado]':text;
  origEl.classList.remove('mt');
  outEl.textContent='â³ Traduciendoâ€¦';
  outEl.classList.remove('mt');
  load(10);
  try{
    // Limit to 4000 chars per translation
    const truncated=text.length>4000?text.substring(0,4000):text;
    const result=await translateText(truncated, src, dest);
    outEl.textContent=result;
    load(100);
    toast(`âœ“ Traducido al ${LANG_NAMES[dest]}`);
    // Switch to translate tab
    document.querySelector('[data-tab="translate"]').click();
  }catch(err){
    outEl.textContent='âŒ Error: '+err.message+'\n\nPosibles causas:\nâ€¢ Sin conexiÃ³n a internet\nâ€¢ LÃ­mite diario de MyMemory alcanzado (10.000 palabras/dÃ­a)\nâ€¢ El texto es demasiado largo â€” intenta con un fragmento mÃ¡s corto.';
    load(100);
  }
}

$('bTransAll').onclick=async()=>{
  await runTranslate(fullText, $('tSrc').value, $('tDest').value, $('tOrig'), $('tOut'));
};
$('bTransSel').onclick=async()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(!txt){toast('Selecciona texto primero.');return;}
  await runTranslate(txt, $('tSrc').value, $('tDest').value, $('tOrig'), $('tOut'));
};
$('bCopyTrans').onclick=()=>{
  const t=$('tOut').textContent;
  if(!t||t.startsWith('La traducciÃ³n')){toast('No hay traducciÃ³n que copiar.');return;}
  navigator.clipboard.writeText(t).then(()=>toast('âœ“ TraducciÃ³n copiada'));
};

// Quick translate from sidebar
$('bQTrans').onclick=async()=>{
  if(!fullText.trim()){toast('Carga texto primero.');return;}
  const dest=$('sdest').value;
  $('tDest').value=dest;
  await runTranslate(fullText, 'auto', dest, $('tOrig'), $('tOut'));
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESUMEN EXTRACTIVO â€” Algoritmo TF-IDF propio
// 100% offline, sin internet, sin APIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STOP_ES=new Set('a al ante aquÃ©l aquella aquello aquel como con cual de del desde dos el ella ellas ellos en entre era eres es esta estaba estas este esto estos fue fue hay la las le les lo los me mi mis muy no nos o para pero por que quien se si sin son su sus tambiÃ©n tan te tenÃ­a todo todos una uno unos voy ya yo un mÃ¡s ni ni es'.split(' '));
const STOP_EN=new Set('a an the and or but if in on at to of for is are was were be been being have has had do does did will would shall should may might must can could am i we you he she it they their them there this that these those with from by as into then than also'.split(' '));

function extractWords(text){
  return text.toLowerCase().replace(/[^a-zÃ¡Ã©Ã­Ã³ÃºÃ¼Ã±\w\s]/gi,' ')
    .split(/\s+/).filter(w=>w.length>3&&!STOP_ES.has(w)&&!STOP_EN.has(w));
}

function tfidf(text){
  // Simple word frequency map
  const words=extractWords(text);
  const freq={};
  words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  // Normalize
  const max=Math.max(...Object.values(freq),1);
  Object.keys(freq).forEach(k=>freq[k]/=max);
  return freq;
}

function scoreSentences(sentences, freq){
  return sentences.map(s=>{
    const words=extractWords(s);
    if(!words.length) return {s,score:0};
    const score=words.reduce((acc,w)=>acc+(freq[w]||0),0)/words.length;
    return {s,score};
  });
}

function genSummary(text, n){
  // Split into sentences
  const rawSentences=text.match(/[^.!?]+[.!?]*/g)||[];
  const sentences=rawSentences.map(s=>s.trim()).filter(s=>s.length>20);
  if(!sentences.length) return 'No se encontraron oraciones suficientes en el texto.';
  const freq=tfidf(text);
  const scored=scoreSentences(sentences,freq);
  // Sort by score, take top N
  const top=scored
    .slice()
    .sort((a,b)=>b.score-a.score)
    .slice(0,n)
    .map(x=>x.s);
  // Re-order by original position
  const ordered=sentences.filter(s=>top.includes(s));
  return ordered.join(' ');
}

$('bSumm').onclick=()=>{
  if(!fullText){toast('Carga texto primero.');return;}
  const level=$('sLevel').value;
  const nMap={breve:5,medio:10,completo:20};
  const n=nMap[level];
  load(30);
  setTimeout(()=>{
    try{
      const result=genSummary(fullText,n);
      $('summOut').textContent=result;
      $('summOut').classList.remove('mt');
      load(100);
      toast('âœ“ Resumen generado ('+n+' oraciones clave)');
    }catch(e){
      $('summOut').textContent='Error: '+e.message;
      load(100);
    }
  },100);
};
$('bCopySumm').onclick=()=>{
  const t=$('summOut').textContent;
  if($('summOut').classList.contains('mt')){toast('Genera un resumen primero.');return;}
  navigator.clipboard.writeText(t).then(()=>toast('âœ“ Resumen copiado'));
};
$('bExSumm').onclick=()=>{
  const t=$('summOut').textContent;
  if($('summOut').classList.contains('mt')){toast('Genera un resumen primero.');return;}
  dl(t,'stoica-resumen.txt');toast('âœ“ Resumen exportado');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREGUNTAS DE COMPRENSIÃ“N â€” Sin API, sin internet
// Genera preguntas basadas en oraciones clave del texto
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genQuestions(text, type, count){
  const rawSentences=text.match(/[^.!?]+[.!?]*/g)||[];
  const sentences=rawSentences.map(s=>s.trim()).filter(s=>s.split(/\s+/).length>6);
  if(sentences.length<3) return null;

  const freq=tfidf(text);
  const scored=scoreSentences(sentences,freq)
    .sort((a,b)=>b.score-a.score);

  const questions=[];
  const used=new Set();

  // â”€â”€ PLANTILLAS POR TIPO â”€â”€
  const templates={
    literal:[
      (s)=>({q:`Â¿QuÃ© se menciona sobre "${extractSubject(s)}"?`,a:s,j:'Esta informaciÃ³n aparece de forma explÃ­cita en el texto.'}),
      (s)=>({q:`SegÃºn el texto, Â¿quÃ© dice sobre ${extractSubject(s)}?`,a:s,j:'El texto lo expresa directamente en esta oraciÃ³n.'}),
      (s)=>({q:`Â¿CÃ³mo describe el texto a "${extractSubject(s)}"?`,a:s,j:'La descripciÃ³n estÃ¡ dada de forma literal en el fragmento.'}),
      (s)=>({q:`Â¿QuÃ© afirma el autor en relaciÃ³n con ${extractSubject(s)}?`,a:s,j:'La afirmaciÃ³n estÃ¡ presente de manera explÃ­cita.'}),
    ],
    inferencial:[
      (s)=>({q:`Â¿Por quÃ© crees que "${extractSubject(s)}" es importante en el contexto del texto?`,a:'Respuesta inferida: '+summarizeSentence(s),j:'Esta conclusiÃ³n se deduce del contenido implÃ­cito del texto.'}),
      (s)=>({q:`Â¿QuÃ© consecuencias podrÃ­an derivarse de lo que se afirma sobre ${extractSubject(s)}?`,a:'Posible consecuencia: '+summarizeSentence(s),j:'Se infiere a partir del contexto general del fragmento.'}),
      (s)=>({q:`Â¿QuÃ© intenciÃ³n tiene el autor al mencionar "${extractSubject(s)}"?`,a:'IntenciÃ³n probable: contextualizar o argumentar sobre el tema central.',j:'Se deduce del tono y estructura del texto.'}),
      (s)=>({q:`Â¿QuÃ© relaciÃ³n existe entre "${extractSubject(s)}" y el tema principal del texto?`,a:'RelaciÃ³n: '+summarizeSentence(s),j:'La relaciÃ³n se establece de forma implÃ­cita en el texto.'}),
    ]
  };

  // Mix types if "mixto"
  const pool=type==='mixto'
    ?[...templates.literal,...templates.inferencial]
    :(templates[type]||templates.literal);

  let qi=0;
  for(let i=0;i<scored.length&&questions.length<count;i++){
    const sent=scored[i].s;
    if(used.has(sent)) continue;
    used.add(sent);
    const tpl=pool[qi%pool.length];
    qi++;
    try{
      const q=tpl(sent);
      if(q.q&&q.a) questions.push({...q,orig:sent});
    }catch(e){/* skip */}
  }

  // Fill remaining with extra questions if needed
  if(questions.length<count){
    const keywords=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,20).map(e=>e[0]);
    keywords.forEach(kw=>{
      if(questions.length>=count) return;
      questions.push({
        q:`Â¿CuÃ¡l es la importancia del concepto "${kw}" dentro del texto?`,
        a:`El tÃ©rmino "${kw}" aparece como uno de los conceptos de mayor frecuencia y relevancia en el texto.`,
        j:'Se identifica como palabra clave por su alta frecuencia de apariciÃ³n.',
        orig:''
      });
    });
  }

  return questions.slice(0,count);
}

function extractSubject(sentence){
  // Extract first noun phrase (simplified)
  const words=sentence.trim().split(/\s+/);
  // Return first 2-4 meaningful words
  const meaningful=words.filter(w=>w.length>2&&!STOP_ES.has(w.toLowerCase())&&!STOP_EN.has(w.toLowerCase()));
  return meaningful.slice(0,3).join(' ').replace(/[.,;:]/g,'')||words.slice(0,2).join(' ');
}

function summarizeSentence(s){
  const words=s.split(/\s+/);
  return words.length>15?words.slice(0,12).join(' ')+'â€¦':s;
}

$('bGenQ').onclick=()=>{
  if(!fullText){toast('Carga texto primero.');return;}
  const count=Math.min(30,Math.max(5,parseInt($('qNum').value)||10));
  const type=$('qType').value;
  load(30);
  setTimeout(()=>{
    const qs=genQuestions(fullText,type,count);
    load(100);
    if(!qs||!qs.length){
      $('questOut').innerHTML='<p style="color:var(--muted);font-family:var(--fMono);font-size:.72rem">El texto es muy corto para generar preguntas. Prueba con un texto mÃ¡s largo.</p>';
      return;
    }
    renderQuestions(qs);
    toast(`âœ“ ${qs.length} preguntas generadas`);
  },150);
};

function renderQuestions(list){
  const c=$('questOut'); c.innerHTML='';
  list.forEach((q,i)=>{
    const card=document.createElement('div');
    card.className='qcard';
    card.innerHTML=`
      <div class="qnum">PREGUNTA ${i+1} ${$('qType').value==='inferencial'?'Â· Inferencial':'Â· ComprensiÃ³n'}</div>
      <div class="qtxt">${E(q.q)}</div>
      <button class="btn g" onclick="this.nextElementSibling.classList.toggle('vis');this.textContent=this.textContent.includes('Ver')?'Ocultar respuesta':'Ver respuesta'">Ver respuesta</button>
      <div class="qans">
        <strong>Respuesta:</strong> ${E(q.a)}<br/>
        <span class="qjust">JustificaciÃ³n: ${E(q.j)}</span>
        ${q.orig?`<br/><span class="qjust" style="color:var(--acc2)">Fragmento de referencia: "${E(summarizeSentence(q.orig))}"</span>`:''}
      </div>`;
    c.appendChild(card);
  });
}

$('bCopyQ').onclick=()=>{
  const cards=[...$('questOut').querySelectorAll('.qcard')];
  if(!cards.length){toast('Genera preguntas primero.');return;}
  const text=cards.map((c,i)=>{
    const q=qs('.qtxt',c)?.textContent||'';
    const a=qs('.qans',c)?.textContent?.trim()||'';
    return `${i+1}. ${q}\n${a}`;
  }).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€\n\n');
  navigator.clipboard.writeText(text).then(()=>toast('âœ“ Preguntas copiadas'));
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAPA CONCEPTUAL â€” TF-IDF propio, offline, gratis
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genMap(text){
  const freq=tfidf(text);
  // Top keywords sorted by frequency
  const sorted=Object.entries(freq)
    .filter(([w])=>w.length>4)
    .sort((a,b)=>b[1]-a[1]);

  if(!sorted.length) return null;

  const central=sorted[0][0];
  // Group remaining into branches of ~5 concepts
  const rest=sorted.slice(1,31).map(e=>e[0]);
  const branchSize=5;
  const branchColors=['var(--acc)','var(--acc2)','var(--acc3)','var(--gold)','#7b2d8b','#2d7b8b'];
  const branches=[];
  for(let i=0;i<rest.length;i+=branchSize){
    const chunk=rest.slice(i,i+branchSize);
    if(chunk.length) branches.push({
      nombre:`Ãrea ${Math.floor(i/branchSize)+1}`,
      conceptos:chunk,
      color:branchColors[Math.floor(i/branchSize)%branchColors.length]
    });
  }

  // Key ideas: top sentences
  const sentences=(text.match(/[^.!?]+[.!?]*/g)||[]).map(s=>s.trim()).filter(s=>s.length>20);
  const scoredS=scoreSentences(sentences,freq).sort((a,b)=>b.score-a.score).slice(0,8);

  return {central,branches,ideas:scoredS.map(x=>x.s)};
}

$('bGenMap').onclick=()=>{
  if(!fullText){toast('Carga texto primero.');return;}
  load(30);
  setTimeout(()=>{
    const result=genMap(fullText);
    load(100);
    if(!result){
      $('mapOut').innerHTML='<span style="font-family:var(--fMono);font-size:.7rem;color:var(--muted)">Texto muy corto para generar mapa. Prueba con mÃ¡s contenido.</span>';
      return;
    }
    renderMap(result);
    toast('âœ“ Mapa conceptual generado');
  },150);
};

function renderMap(data){
  const c=$('mapOut');
  let html=`<div style="width:100%;display:flex;flex-direction:column;gap:16px">`;
  html+=`<div style="text-align:center"><span class="mnode ctr">${E(data.central)}</span></div>`;
  html+=`<div style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center">`;
  data.branches.forEach(b=>{
    html+=`<div class="branch" style="border-top-color:${b.color}">
      <div class="btitle" style="color:${b.color}">${E(b.nombre)}</div>
      <div class="bchips">`;
    b.conceptos.forEach(c2=>html+=`<span class="mnode" style="font-size:.6rem;padding:4px 8px">${E(c2)}</span>`);
    html+=`</div></div>`;
  });
  html+=`</div></div>`;
  c.innerHTML=html;
  $('ideasOut').textContent=data.ideas.map((s,i)=>`${i+1}. ${s}`).join('\n\n');
  $('ideasOut').classList.remove('mt');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TECLADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  const tag=e.target.tagName;
  if(tag==='TEXTAREA'||tag==='INPUT') return;
  if(e.code==='Space'){e.preventDefault();togglePlay();}
  if(e.code==='Escape') stopSpeech();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER (PWA / Offline)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}

console.log('%câœ¦ STOICA READER â€” 100% gratuito y funcional',
  'color:#b5341e;font-family:monospace;font-weight:bold;font-size:12px');
</script>
</body>
</html>

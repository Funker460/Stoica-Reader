<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Stoica Reader</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#0e0f14"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,600;1,8..60,400&family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER v4.2 â€” ACADEMIC EDITION
   Paleta sobria, tipografÃ­a acadÃ©mica, claridad cognitiva
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* â”€â”€ DARK THEME (Default) â”€â”€ */
  --bg:       #0e0f14;
  --bg2:      #111318;
  --surf:     #16181f;
  --surf2:    #1c1e27;
  --surf3:    #232630;
  --bdr:      #272a35;
  --bdr2:     #323646;
  --txt:      #dde1ec;
  --txt2:     #a8afc4;
  --muted:    #5e6480;

  /* â”€â”€ ACCENT PALETTE â€” Refined, academic â”€â”€ */
  --acc:      #5b8dee;   /* Azul institucional */
  --acc-dim:  rgba(91,141,238,.13);
  --acc2:     #3dc9b0;   /* Teal / esmeralda */
  --acc2-dim: rgba(61,201,176,.1);
  --acc3:     #e8914a;   /* Ãmbar cÃ¡lido */
  --acc3-dim: rgba(232,145,74,.1);
  --warn:     #e05c6c;
  --gold:     #c8a653;

  /* â”€â”€ TTS highlight â”€â”€ */
  --hi-now:   #5b8dee;
  --hi-done:  rgba(91,141,238,.1);

  /* â”€â”€ UI â”€â”€ */
  --shad:     rgba(0,0,0,.55);
  --shad2:    rgba(0,0,0,.85);
  --r:6px; --r2:10px; --r3:18px;
  --fs:18px; --lh:1.95;

  /* â”€â”€ FONTS â”€â”€ */
  --fBody: 'Source Serif 4', Georgia, serif;
  --fSans: 'IBM Plex Sans', system-ui, sans-serif;
  --fMono: 'IBM Plex Mono', monospace;

  /* â”€â”€ GRADIENTS â”€â”€ */
  --grad: linear-gradient(135deg, var(--acc) 0%, var(--acc2) 100%);
  --grad-h: linear-gradient(135deg, #4a7de8 0%, #2db89e 100%);
}
[data-theme=light] {
  --bg:#f7f8fb; --bg2:#f0f2f7; --surf:#ffffff; --surf2:#f0f2f8;
  --surf3:#e6e9f2; --bdr:#d8dce8; --bdr2:#c4c9d8;
  --txt:#1a1d2e; --txt2:#4a5070; --muted:#8890aa;
  --shad:rgba(26,29,46,.1); --shad2:rgba(26,29,46,.25);
  --acc:#3d6fd4; --acc-dim:rgba(61,111,212,.1);
  --acc2:#2aaa96; --acc2-dim:rgba(42,170,150,.08);
  --acc3:#c4783a; --acc3-dim:rgba(196,120,58,.1);
  --warn:#c94255; --gold:#a8893f;
  --hi-now:#3d6fd4; --hi-done:rgba(61,111,212,.1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: var(--fSans);
  background: var(--bg);
  color: var(--txt);
  display: flex;
  flex-direction: column;
  transition: background .3s, color .3s;
}
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 4px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  height: 46px;
  background: var(--surf);
  border-bottom: 1px solid var(--bdr);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  flex-shrink: 0;
  z-index: 60;
}
.logo {
  font-family: var(--fMono);
  font-size: .74rem;
  font-weight: 400;
  letter-spacing: .25em;
  color: var(--acc);
  display: flex;
  align-items: center;
  gap: 10px;
}
.logo .sep { color: var(--bdr2); }
.logo .sub { color: var(--muted); font-weight: 300; letter-spacing: .1em; }
.badge-v {
  font-size: .52rem;
  background: var(--acc-dim);
  color: var(--acc);
  padding: 2px 7px;
  border-radius: 10px;
  letter-spacing: .06em;
  border: 1px solid rgba(91,141,238,.25);
  font-family: var(--fMono);
}
.hdr-r { display: flex; gap: 3px; align-items: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs {
  display: flex;
  background: var(--surf);
  border-bottom: 1px solid var(--bdr);
  padding: 0 14px;
  flex-shrink: 0;
  overflow-x: auto;
  gap: 0;
}
.tabs::-webkit-scrollbar { height: 0; }
.tab {
  padding: 8px 13px;
  font-family: var(--fMono);
  font-size: .6rem;
  letter-spacing: .09em;
  border: none;
  background: none;
  color: var(--muted);
  cursor: pointer;
  white-space: nowrap;
  border-bottom: 2px solid transparent;
  transition: color .15s, border-color .15s;
}
.tab.on { color: var(--acc); border-bottom-color: var(--acc); }
.tab:hover:not(.on) { color: var(--txt2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOOLBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bar {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  padding: 6px 14px;
  background: var(--bg2);
  border-bottom: 1px solid var(--bdr);
  align-items: center;
  flex-shrink: 0;
}
.vline { width: 1px; height: 18px; background: var(--bdr2); margin: 0 3px; flex-shrink: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 5px 11px;
  border-radius: var(--r);
  border: 1px solid var(--bdr2);
  background: var(--surf2);
  color: var(--txt2);
  font-family: var(--fMono);
  font-size: .6rem;
  letter-spacing: .04em;
  cursor: pointer;
  white-space: nowrap;
  transition: all .15s;
}
.btn:hover { background: var(--surf3); color: var(--txt); border-color: var(--bdr2); }
.btn:active { transform: scale(.97); }
.btn.g { background: transparent; color: var(--muted); border-color: var(--bdr); }
.btn.g:hover { background: var(--surf2); color: var(--txt2); }
.btn.pri { background: var(--acc); color: #fff; border-color: transparent; }
.btn.pri:hover { background: #4a7de8; }
.btn.teal { background: var(--acc2); color: #fff; border-color: transparent; }
.btn.teal:hover { filter: brightness(1.1); }
.btn.amber { background: var(--acc3); color: #fff; border-color: transparent; }
.btn.amber:hover { filter: brightness(1.1); }
.btn.danger { background: var(--warn); color: #fff; border-color: transparent; }
.ibtn {
  background: none;
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  color: var(--muted);
  cursor: pointer;
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  font-size: .78rem;
  transition: all .15s;
  flex-shrink: 0;
}
.ibtn:hover { background: var(--surf2); color: var(--txt2); border-color: var(--bdr2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS & PROGRESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  padding: 3px 16px;
  background: var(--bg);
  border-bottom: 1px solid var(--bdr);
  font-family: var(--fMono);
  font-size: .57rem;
  color: var(--muted);
  align-items: center;
  flex-shrink: 0;
}
.stats b { color: var(--txt2); font-weight: 500; }
.pill {
  font-family: var(--fMono);
  font-size: .54rem;
  padding: 2px 8px;
  border-radius: 20px;
  background: var(--surf2);
  color: var(--muted);
  border: 1px solid var(--bdr);
}
.pill.play {
  background: var(--acc-dim);
  color: var(--acc);
  border-color: rgba(91,141,238,.35);
  animation: blink 1.6s infinite;
}
.pill.pause {
  background: var(--acc2-dim);
  color: var(--acc2);
  border-color: rgba(61,201,176,.3);
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.45} }

.pbwrap {
  padding: 0 16px 5px;
  background: var(--bg);
  border-bottom: 1px solid var(--bdr);
  flex-shrink: 0;
}
.pbtrack {
  width: 100%;
  height: 3px;
  background: var(--surf2);
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  overflow: visible;
}
.pbfill {
  height: 100%;
  width: 0%;
  border-radius: 3px;
  background: var(--grad);
  transition: width .12s;
  position: relative;
}
.pbfill::after {
  content: '';
  position: absolute;
  right: -5px; top: -4px;
  width: 11px; height: 11px;
  border-radius: 50%;
  background: var(--acc);
  opacity: 0;
  transition: opacity .15s;
  box-shadow: 0 0 8px rgba(91,141,238,.6);
}
.pbtrack:hover .pbfill::after { opacity: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT & READER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.layout { display: flex; flex: 1; overflow: hidden; min-height: 0; }

.rpane {
  flex: 1;
  overflow-y: auto;
  padding: 52px 96px;
  min-width: 0;
  scroll-behavior: smooth;
}
@media (max-width: 700px) { .rpane { padding: 24px 18px; } }

#textDisplay {
  font-family: var(--fBody);
  font-size: var(--fs);
  font-weight: 300;
  line-height: var(--lh);
  white-space: pre-wrap;
  word-break: break-word;
  outline: none;
  max-width: 740px;
  margin: 0 auto;
  color: var(--txt);
}
#textDisplay.mt::before {
  content: 'Carga un archivo o pega tu texto aquÃ­â€¦';
  color: var(--muted);
  font-style: italic;
  font-family: var(--fSans);
  font-size: 1rem;
  font-weight: 400;
}

/* TTS word highlighting */
.w { display: inline; }
.w.now {
  background: var(--hi-now);
  color: #fff;
  border-radius: 3px;
  padding: 0 2px;
  box-shadow: 0 0 12px rgba(91,141,238,.35);
}
.w.done { background: var(--hi-done); border-radius: 2px; }
mark.hl {
  background: rgba(200,166,83,.22);
  color: var(--txt);
  border-radius: 2px;
  padding: 0 1px;
  border-bottom: 1.5px solid var(--gold);
}
mark.find { background: rgba(200,166,83,.3); color: var(--txt); border-radius: 2px; }
mark.find.cur { background: var(--acc3); color: #fff; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.side {
  width: 285px;
  min-width: 265px;
  border-left: 1px solid var(--bdr);
  background: var(--surf);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
  transition: width .22s, min-width .22s;
}
.side.off { width: 0; min-width: 0; border: none; }
.sinner {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.card {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  border-radius: var(--r2);
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 7px;
}
.card h3 {
  font-family: var(--fMono);
  font-size: .55rem;
  letter-spacing: .14em;
  color: var(--muted);
  text-transform: uppercase;
}
.sl-lbl {
  font-family: var(--fMono);
  font-size: .57rem;
  color: var(--muted);
  display: flex;
  justify-content: space-between;
}
input[type=range] { width: 100%; accent-color: var(--acc); cursor: pointer; height: 3px; }
select, input[type=text] {
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  background: var(--surf2);
  color: var(--txt);
  font-family: var(--fMono);
  font-size: .6rem;
  padding: 5px 8px;
}
select { width: 100%; cursor: pointer; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TTS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ttsbar {
  background: var(--surf);
  border-top: 1px solid var(--bdr);
  padding: 8px 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  z-index: 40;
}
.pbig {
  width: 40px; height: 40px;
  border-radius: 50%;
  border: none;
  background: var(--grad);
  color: #fff;
  font-size: .9rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform .15s, box-shadow .15s;
  flex-shrink: 0;
  box-shadow: 0 3px 12px rgba(91,141,238,.3);
}
.pbig:hover { transform: scale(1.08); box-shadow: 0 4px 18px rgba(91,141,238,.45); }
.pbig.sel {
  background: linear-gradient(135deg, var(--acc2), var(--acc));
  box-shadow: 0 3px 12px rgba(61,201,176,.3);
}
.hint {
  font-family: var(--fMono);
  font-size: .56rem;
  color: var(--muted);
  margin-left: auto;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLOATING CONTROL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#fc {
  position: fixed;
  bottom: 88px; right: 14px;
  background: var(--surf2);
  border: 1px solid var(--bdr2);
  border-radius: var(--r2);
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: center;
  box-shadow: 0 8px 28px var(--shad2);
  z-index: 300;
  cursor: move;
  user-select: none;
  transition: opacity .2s, transform .2s;
}
#fc.off { opacity: 0; pointer-events: none; transform: scale(.84) translateY(8px); }
.fcdrg { font-family: var(--fMono); font-size: .5rem; color: var(--muted); cursor: grab; }
.fcspd { font-family: var(--fMono); font-size: .6rem; color: var(--muted); text-align: center; }
.fcbtn {
  width: 33px; height: 33px;
  border-radius: 50%;
  border: 1px solid var(--bdr2);
  background: var(--surf3);
  color: var(--txt2);
  font-size: .78rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.fcbtn:hover { background: var(--surf2); }
.fcbtn.r { background: var(--grad); color: #fff; border: none; box-shadow: 0 2px 8px rgba(91,141,238,.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY / MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ov {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  z-index: 500;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px);
}
.ov.on { display: flex; }
.modal {
  background: var(--surf);
  border: 1px solid var(--bdr2);
  border-radius: var(--r2);
  padding: 24px;
  width: min(600px, 96vw);
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 24px 60px var(--shad2);
  display: flex;
  flex-direction: column;
  gap: 12px;
  animation: mIn .18s ease;
}
@keyframes mIn { from { opacity: 0; transform: scale(.95) translateY(10px); } }
.modal h2 { font-family: var(--fMono); font-size: .76rem; letter-spacing: .08em; color: var(--txt); }
.modal textarea {
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  background: var(--bg);
  color: var(--txt);
  font-family: var(--fBody);
  font-size: .95rem;
  padding: 12px;
  width: 100%;
  min-height: 200px;
  resize: vertical;
  line-height: 1.8;
}
.mfooter { display: flex; gap: 7px; justify-content: flex-end; flex-wrap: wrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB PANES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tpane { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.tpane.on { display: flex; }
.pinner {
  flex: 1;
  overflow-y: auto;
  padding: 16px 18px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.phead {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
  flex-shrink: 0;
  padding-bottom: 4px;
  border-bottom: 1px solid var(--bdr);
  margin-bottom: 2px;
}
.phead h2 {
  font-family: var(--fMono);
  font-size: .68rem;
  letter-spacing: .12em;
  color: var(--txt2);
  margin-right: 6px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OUTPUT / INFO BOX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.out {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 16px;
  font-family: var(--fBody);
  font-size: .9rem;
  line-height: 1.8;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-y: auto;
  flex: 1;
}
.out.mt { color: var(--muted); font-style: italic; font-family: var(--fSans); }
.infobox {
  font-family: var(--fMono);
  font-size: .58rem;
  color: var(--muted);
  background: var(--surf);
  border: 1px solid var(--bdr);
  border-left: 3px solid var(--acc2);
  border-radius: 0 var(--r) var(--r) 0;
  padding: 7px 11px;
  line-height: 1.65;
  flex-shrink: 0;
}
.infobox b { color: var(--acc2); font-weight: 500; }
.infobox.warn { border-left-color: var(--acc3); }
.infobox.warn b { color: var(--acc3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ncard {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  animation: fi .18s ease;
}
@keyframes fi { from { opacity: 0; transform: translateY(4px); } }
.nmeta { font-family: var(--fMono); font-size: .55rem; color: var(--muted); }
.nbody { font-family: var(--fBody); font-size: .87rem; line-height: 1.7; white-space: pre-wrap; }
.nacts { display: flex; gap: 5px; flex-wrap: wrap; }
.nta {
  border: 1px solid var(--bdr);
  background: var(--surf2);
  color: var(--txt);
  font-family: var(--fSans);
  font-size: .87rem;
  padding: 7px 9px;
  border-radius: 4px;
  width: 100%;
  resize: none;
  min-height: 60px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSLATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; flex: 1; min-height: 0; }
@media (max-width: 580px) { .tgrid { grid-template-columns: 1fr; } }
.tcol { display: flex; flex-direction: column; gap: 5px; min-height: 0; }
.tlbl { font-family: var(--fMono); font-size: .56rem; color: var(--muted); letter-spacing: .08em; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUESTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.qcard {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 7px;
  transition: border-color .15s;
}
.qcard:hover { border-color: var(--bdr2); }
.qnum {
  font-family: var(--fMono);
  font-size: .55rem;
  color: var(--muted);
  letter-spacing: .08em;
  text-transform: uppercase;
}
.qtxt { font-family: var(--fSans); font-size: .9rem; font-weight: 500; line-height: 1.55; }
.qans {
  font-family: var(--fSans);
  font-size: .84rem;
  padding-top: 10px;
  border-top: 1px solid var(--bdr);
  display: none;
  color: var(--txt2);
  line-height: 1.7;
}
.qans.vis { display: block; animation: fi .2s ease; }
.qjust { font-size: .77rem; color: var(--muted); margin-top: 5px; font-style: italic; display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOICES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.voice-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
  gap: 7px;
}
.vcard {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  cursor: pointer;
  transition: all .15s;
}
.vcard:hover { border-color: var(--bdr2); background: var(--surf2); }
.vcard.sel {
  border-color: var(--acc);
  background: var(--acc-dim);
  box-shadow: 0 0 0 1px rgba(91,141,238,.2);
}
.vname { font-family: var(--fMono); font-size: .65rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.vlang { font-family: var(--fMono); font-size: .54rem; color: var(--muted); }
.vtag {
  font-family: var(--fMono);
  font-size: .5rem;
  padding: 2px 6px;
  border-radius: 10px;
  background: var(--surf2);
  border: 1px solid var(--bdr);
  color: var(--muted);
  display: inline-block;
}
.vtag.es { color: var(--acc3); border-color: rgba(232,145,74,.4); background: var(--acc3-dim); }
.vtag.en { color: var(--acc); border-color: rgba(91,141,238,.35); background: var(--acc-dim); }
.vtag.star { color: var(--gold); border-color: rgba(200,166,83,.4); }
.voice-filter { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; flex-shrink: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOOLS SECTION (HERRAMIENTAS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Sub-tabs */
.tool-tabs { display: flex; gap: 4px; flex-shrink: 0; margin-bottom: 2px; }
.tool-tab {
  font-family: var(--fMono);
  font-size: .58rem;
  padding: 5px 12px;
  border: 1px solid var(--bdr);
  border-radius: var(--r3);
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  transition: all .15s;
  letter-spacing: .05em;
}
.tool-tab.on { background: var(--acc); color: #fff; border-color: transparent; }
.tool-tab:hover:not(.on) { background: var(--surf2); color: var(--txt2); }

/* Tool pane */
.tool-pane { display: none; flex-direction: column; gap: 12px; flex: 1; min-height: 0; }
.tool-pane.on { display: flex; }

/* â”€â”€ MIND MAP â”€â”€ */
.mm-canvas {
  background: var(--surf);
  border: 1px solid var(--bdr);
  border-radius: var(--r2);
  padding: 20px;
  overflow: auto;
  min-height: 200px;
  flex: 1;
}
.mm-center {
  display: inline-block;
  font-family: var(--fMono);
  font-size: .8rem;
  font-weight: 500;
  background: var(--grad);
  color: #fff;
  padding: 10px 22px;
  border-radius: var(--r3);
  letter-spacing: .06em;
  box-shadow: 0 4px 18px rgba(91,141,238,.3);
}
.mm-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-top: 16px;
}
.mm-branch {
  background: var(--surf2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 10px 12px;
  min-width: 140px;
  max-width: 200px;
  flex: 1;
}
.mm-branch-title {
  font-family: var(--fMono);
  font-size: .58rem;
  font-weight: 500;
  letter-spacing: .07em;
  text-transform: uppercase;
  margin-bottom: 7px;
  padding-bottom: 5px;
  border-bottom: 1px solid var(--bdr);
}
.mm-chips { display: flex; flex-wrap: wrap; gap: 4px; }
.mm-chip {
  font-family: var(--fMono);
  font-size: .58rem;
  background: var(--bg2);
  border: 1px solid var(--bdr2);
  border-radius: var(--r);
  padding: 3px 8px;
  cursor: pointer;
  transition: all .12s;
}
.mm-chip:hover { border-color: var(--acc); color: var(--acc); }

/* â”€â”€ HIERARCHY â”€â”€ */
.hier-wrap { padding: 4px; overflow-y: auto; flex: 1; }
.hier-root { list-style: none; padding: 0; }
.hier-item { margin: 3px 0; }
.hier-children { list-style: none; padding-left: 20px; margin-top: 3px; border-left: 1px solid var(--bdr2); }
.hier-node {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: var(--fMono);
  font-size: .62rem;
  background: var(--surf2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 4px 10px;
  cursor: pointer;
  transition: all .12s;
  margin: 2px 0;
}
.hier-node:hover { border-color: var(--acc); color: var(--acc); }
.hier-node.l0 {
  background: var(--acc-dim);
  border-color: rgba(91,141,238,.35);
  color: var(--acc);
  font-weight: 500;
  font-size: .68rem;
}
.hier-node.l0::before { content: 'â—†'; font-size: .55rem; }
.hier-node.l1 { color: var(--acc2); border-color: rgba(61,201,176,.3); background: var(--acc2-dim); }
.hier-node.l1::before { content: 'â–¸'; font-size: .6rem; color: var(--acc2); }
.hier-node.l2 { color: var(--txt2); font-size: .58rem; }
.hier-node.l2::before { content: 'Â·'; font-size: .7rem; color: var(--muted); }

/* â”€â”€ COMPARATIVE TABLE â”€â”€ */
.comp-wrap { overflow-x: auto; flex: 1; }
.comp-table {
  width: 100%;
  border-collapse: collapse;
  font-family: var(--fSans);
  font-size: .82rem;
}
.comp-table th {
  background: var(--surf2);
  border: 1px solid var(--bdr);
  padding: 9px 14px;
  font-family: var(--fMono);
  font-size: .58rem;
  letter-spacing: .09em;
  color: var(--muted);
  text-align: left;
  text-transform: uppercase;
}
.comp-table td {
  border: 1px solid var(--bdr);
  padding: 8px 14px;
  line-height: 1.55;
  vertical-align: top;
}
.comp-table tr:nth-child(even) td { background: var(--bg2); }
.comp-table tr:hover td { background: var(--surf); }
.comp-table .concept-cell {
  font-family: var(--fMono);
  font-size: .62rem;
  font-weight: 500;
  color: var(--acc);
}

/* â”€â”€ IDEAS KEY â”€â”€ */
.idea-list { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex: 1; }
.idea-card {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 12px 14px;
  display: flex;
  gap: 10px;
  align-items: flex-start;
  transition: border-color .15s;
}
.idea-card:hover { border-color: var(--bdr2); }
.idea-num {
  font-family: var(--fMono);
  font-size: .6rem;
  color: var(--acc);
  font-weight: 500;
  min-width: 22px;
  padding-top: 1px;
}
.idea-text { font-family: var(--fBody); font-size: .87rem; line-height: 1.7; color: var(--txt); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO EXPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rec-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-family: var(--fMono);
  font-size: .6rem;
  background: rgba(224,92,108,.1);
  color: var(--warn);
  padding: 3px 9px;
  border-radius: 12px;
  border: 1px solid rgba(224,92,108,.35);
}
.rec-dot { width: 7px; height: 7px; background: var(--warn); border-radius: 50%; animation: blink .9s infinite; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.srchwrap {
  display: flex;
  gap: 4px;
  align-items: center;
  background: var(--surf2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 4px 8px;
}
.srchwrap input {
  border: none;
  background: transparent;
  color: var(--txt);
  font-family: var(--fMono);
  font-size: .63rem;
  outline: none;
  flex: 1;
  min-width: 0;
}
.srchwrap input::placeholder { color: var(--muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING & TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lbar {
  position: fixed; top: 0; left: 0;
  height: 2px;
  background: var(--grad);
  z-index: 999;
  width: 0%;
  transition: width .25s;
  pointer-events: none;
}
.toast {
  position: fixed;
  bottom: 72px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--surf2);
  color: var(--txt);
  border: 1px solid var(--bdr2);
  padding: 8px 16px;
  border-radius: var(--r3);
  font-family: var(--fMono);
  font-size: .64rem;
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s, transform .2s;
  white-space: nowrap;
  box-shadow: 0 6px 24px var(--shad2);
}
.toast.on { opacity: 1; transform: translateX(-50%) translateY(-4px); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FONT ROW & MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.frow { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
.frow label { font-family: var(--fMono); font-size: .56rem; color: var(--muted); }
.frow select { width: auto; }
#fileInput { display: none; }
</style>
</head>
<body>

<div class="lbar" id="lb"></div>
<div class="toast" id="toast"></div>
<input type="file" id="fileInput" accept=".pdf,.txt,.md,.csv,.docx,.pptx,.epub"/>

<!-- â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo">
    STOICA <span class="sep">|</span> <span class="sub">Reader</span>
    <span class="badge-v">v4.2</span>
  </div>
  <div class="hdr-r">
    <button class="ibtn" id="bTheme"  title="Claro / Oscuro">ğŸŒ™</button>
    <button class="ibtn" id="bFS"     title="Pantalla completa">â›¶</button>
    <button class="ibtn" id="bSide"   title="Panel lateral">â–</button>
    <button class="ibtn" id="bFloat"  title="Control flotante">âŠ•</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <button class="tab on"  data-tab="reader">ğŸ“– Lector</button>
  <button class="tab"     data-tab="voices">ğŸ™ Voces</button>
  <button class="tab"     data-tab="notes">ğŸ“ Notas</button>
  <button class="tab"     data-tab="summary">ğŸ“‹ Resumen</button>
  <button class="tab"     data-tab="questions">â“ Preguntas</button>
  <button class="tab"     data-tab="tools">ğŸ”§ Herramientas</button>
  <button class="tab"     data-tab="translate">ğŸŒ TraducciÃ³n</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• TOOLBAR â•â•â•â•â•â•â•â•â•â•â• -->
<div class="bar">
  <button class="btn pri" id="bFile">ğŸ“‚ Cargar archivo</button>
  <button class="btn g"   id="bPaste">ğŸ“‹ Pegar texto</button>
  <div class="vline"></div>
  <div class="frow">
    <label>Fuente</label>
    <select id="sfont">
      <option value="'Source Serif 4',Georgia,serif">Source Serif</option>
      <option value="'IBM Plex Sans',sans-serif">IBM Plex Sans</option>
      <option value="'IBM Plex Mono',monospace">Monoespaciada</option>
      <option value="Georgia,serif">Georgia</option>
      <option value="'Courier New',monospace">Courier</option>
    </select>
    <label>TamaÃ±o</label>
    <select id="ssize">
      <option value="14px">14</option><option value="16px">16</option>
      <option value="18px" selected>18</option><option value="20px">20</option>
      <option value="24px">24</option><option value="28px">28</option>
    </select>
    <label>LÃ­nea</label>
    <select id="slh">
      <option value="1.6">1.6</option>
      <option value="1.95" selected>1.95</option>
      <option value="2.3">2.3</option>
    </select>
  </div>
  <div class="vline"></div>
  <button class="btn g" id="bHL">ğŸ–Š Resaltar</button>
  <button class="btn g" id="bNote">ğŸ’¾ Nota</button>
  <div class="vline"></div>
  <div class="srchwrap">
    <input type="text" id="srchInput" placeholder="Buscar en el textoâ€¦"/>
    <button class="ibtn" id="bSrchPrev" style="border:none;width:20px;height:20px">â—€</button>
    <button class="ibtn" id="bSrchNext" style="border:none;width:20px;height:20px">â–¶</button>
    <span id="srchInfo" style="font-family:var(--fMono);font-size:.56rem;color:var(--muted);white-space:nowrap"></span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stats">
  <span>Palabras: <b id="sw">0</b></span>
  <span>PÃ¡ginas: <b id="sp">0</b></span>
  <span>â± <b id="st">0 min</b></span>
  <span>Avance: <b id="spos">0%</b></span>
  <span id="statPill" class="pill">Detenido</span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• PROGRESS â•â•â•â•â•â•â•â•â•â•â• -->
<div class="pbwrap">
  <div class="pbtrack" id="pbtrack" title="Clic para saltar a esa posiciÃ³n">
    <div class="pbfill" id="pbfill"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB: LECTOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tpane on" id="tab-reader">
  <div class="layout">
    <div class="rpane" id="rPane">
      <div id="textDisplay" class="mt"></div>
    </div>
    <aside class="side" id="sideP">
      <div class="sinner">
        <!-- Voz activa -->
        <div class="card">
          <h3>ğŸ™ Voz activa</h3>
          <select id="voiceSel"></select>
          <div class="sl-lbl"><span>Velocidad</span><b id="rV">1.0Ã—</b></div>
          <input type="range" id="rRate" min=".5" max="2.5" step=".1" value="1"/>
          <div class="sl-lbl"><span>Tono</span><b id="pV">1.0</b></div>
          <input type="range" id="rPitch" min=".5" max="2" step=".1" value="1"/>
          <div class="sl-lbl"><span>Volumen</span><b id="vV">100%</b></div>
          <input type="range" id="rVol" min="0" max="1" step=".05" value="1"/>
          <button class="btn g" onclick="goTab('voices')" style="font-size:.55rem">â†’ Gestionar todas las voces</button>
        </div>
        <!-- Exportar audio -->
        <div class="card">
          <h3>ğŸ”Š Exportar audio</h3>
          <input type="text" id="audioName" placeholder="nombre-del-archivo"/>
          <button class="btn teal" id="bExport">â¬‡ Iniciar grabaciÃ³n</button>
          <button class="btn danger" id="bStopRec" style="display:none">â¹ Detener y guardar</button>
          <div id="recStatus" style="display:none">
            <span class="rec-badge"><span class="rec-dot"></span>Grabandoâ€¦</span>
          </div>
          <p style="font-family:var(--fMono);font-size:.54rem;color:var(--muted);line-height:1.6">
            Comparte la pestaÃ±a y activa "Compartir audio de la pestaÃ±a".
          </p>
        </div>
        <!-- TraducciÃ³n rÃ¡pida -->
        <div class="card">
          <h3>ğŸŒ TraducciÃ³n rÃ¡pida</h3>
          <select id="sdest">
            <option value="es">â†’ EspaÃ±ol</option>
            <option value="en">â†’ InglÃ©s</option>
            <option value="fr">â†’ FrancÃ©s</option>
            <option value="de">â†’ AlemÃ¡n</option>
            <option value="pt">â†’ PortuguÃ©s</option>
          </select>
          <button class="btn pri" id="bQTrans">ğŸŒ Traducir texto</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB: VOCES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tpane" id="tab-voices">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ™ VOCES DEL SISTEMA</h2>
      <div class="voice-filter">
        <select id="vLangFilter">
          <option value="">Todos los idiomas</option>
          <option value="es">EspaÃ±ol</option>
          <option value="en">InglÃ©s</option>
          <option value="fr">FrancÃ©s</option>
          <option value="de">AlemÃ¡n</option>
          <option value="pt">PortuguÃ©s</option>
        </select>
        <button class="btn g" id="bRefreshVoices">â†º Actualizar</button>
        <span id="vCount" style="font-family:var(--fMono);font-size:.57rem;color:var(--muted)"></span>
      </div>
    </div>
    <div class="infobox">
      <b>SelecciÃ³n de voz:</b> Haz clic en una tarjeta para activarla Â· Usa â–¶ para previsualizar Â· Las voces disponibles dependen del sistema operativo y el navegador.
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
      <input type="text" id="previewTxt" placeholder="Texto de prueba para previsualizar vozâ€¦" style="flex:1;max-width:450px"/>
    </div>
    <div class="voice-grid" id="voiceGrid"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB: NOTAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tpane" id="tab-notes">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ“ MIS NOTAS</h2>
      <button class="btn g" id="bClearNotes" style="margin-left:auto">ğŸ—‘ Limpiar todo</button>
      <button class="btn g" id="bExNotesTxt">â¬‡ TXT</button>
    </div>
    <p id="emptyN" style="font-family:var(--fMono);font-size:.7rem;color:var(--muted)">
      Selecciona texto en el lector â†’ pulsa "ğŸ’¾ Nota" en la barra de herramientas.
    </p>
    <div id="notesCont"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB: RESUMEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tpane" id="tab-summary">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ“‹ RESUMEN AUTOMÃTICO</h2>
      <select id="sLevel">
        <option value="breve">Breve (~5 oraciones)</option>
        <option value="medio" selected>Intermedio (~10 oraciones)</option>
        <option value="completo">Detallado (~20 oraciones)</option>
      </select>
      <button class="btn pri" id="bSumm">âœ¨ Generar</button>
      <button class="btn g"   id="bCopySumm">ğŸ“‹ Copiar</button>
      <button class="btn g"   id="bExSumm">â¬‡ TXT</button>
    </div>
    <div class="infobox">âœ… Funciona <b>sin internet</b> â€” algoritmo extractivo TF-IDF. Sin APIs de pago.</div>
    <div id="summOut" class="out mt">El resumen aparecerÃ¡ aquÃ­. Carga un texto y pulsa "Generar".</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB: PREGUNTAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tpane" id="tab-questions">
  <div class="pinner">
    <div class="phead">
      <h2>â“ PREGUNTAS DE COMPRENSIÃ“N</h2>
      <select id="qType">
        <option value="literal">Literal</option>
        <option value="inferencial">Inferencial</option>
        <option value="mixto" selected>Mixto</option>
      </select>
      <input type="number" id="qNum" value="10" min="5" max="30"
        style="width:52px;border:1px solid var(--bdr);border-radius:var(--r);
        background:var(--surf2);color:var(--txt);font-family:var(--fMono);font-size:.6rem;padding:5px 7px"/>
      <button class="btn pri"   id="bGenQ">âœ¨ Generar</button>
      <button class="btn g"     id="bCopyQ">ğŸ“‹ Copiar</button>
      <button class="btn amber" id="bExQDocx">â¬‡ Word</button>
      <button class="btn teal"  id="bExQXlsx">â¬‡ Excel</button>
    </div>
    <div class="infobox">âœ… GeneraciÃ³n <b>sin internet</b>. Exporta a Word (.docx) o Excel (.xlsx) directamente.</div>
    <div id="questOut"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB: HERRAMIENTAS (ex Mapa)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tpane" id="tab-tools">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ”§ HERRAMIENTAS DE ANÃLISIS</h2>
      <button class="btn pri" id="bGenAll">âœ¨ Analizar texto</button>
    </div>
    <div class="infobox">âœ… AnÃ¡lisis TF-IDF <b>sin internet</b>. Genera mapa mental, jerarquÃ­a conceptual, cuadro comparativo e ideas clave.</div>

    <div class="tool-tabs" id="toolTabsBar">
      <button class="tool-tab on" data-tpane="tp-map">ğŸ—º Mapa mental</button>
      <button class="tool-tab"    data-tpane="tp-hier">ğŸ— JerarquÃ­a</button>
      <button class="tool-tab"    data-tpane="tp-comp">âš–ï¸ Comparativo</button>
      <button class="tool-tab"    data-tpane="tp-ideas">ğŸ’¡ Ideas clave</button>
    </div>

    <!-- Mapa mental -->
    <div class="tool-pane on" id="tp-map">
      <div class="mm-canvas" id="mmOut">
        <span style="font-family:var(--fMono);font-size:.68rem;color:var(--muted)">
          Carga un texto y pulsa "âœ¨ Analizar texto" para generar el mapa mental.
        </span>
      </div>
    </div>

    <!-- JerarquÃ­a -->
    <div class="tool-pane" id="tp-hier">
      <div class="hier-wrap" id="hierOut">
        <span style="font-family:var(--fMono);font-size:.68rem;color:var(--muted)">La jerarquÃ­a conceptual aparecerÃ¡ aquÃ­.</span>
      </div>
    </div>

    <!-- Comparativo -->
    <div class="tool-pane" id="tp-comp">
      <div class="comp-wrap">
        <div id="compOut">
          <span style="font-family:var(--fMono);font-size:.68rem;color:var(--muted)">El cuadro comparativo aparecerÃ¡ aquÃ­.</span>
        </div>
      </div>
    </div>

    <!-- Ideas clave -->
    <div class="tool-pane" id="tp-ideas">
      <div class="idea-list" id="ideasOut">
        <span style="font-family:var(--fMono);font-size:.68rem;color:var(--muted)">Las ideas clave aparecerÃ¡n aquÃ­.</span>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB: TRADUCCIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tpane" id="tab-translate">
  <div class="pinner" style="height:100%">
    <div class="phead">
      <h2>ğŸŒ TRADUCCIÃ“N</h2>
      <select id="tSrc" style="min-width:110px">
        <option value="auto">Detectar</option>
        <option value="es">EspaÃ±ol</option>
        <option value="en">InglÃ©s</option>
        <option value="fr">FrancÃ©s</option>
        <option value="de">AlemÃ¡n</option>
        <option value="pt">PortuguÃ©s</option>
        <option value="it">Italiano</option>
        <option value="ru">Ruso</option>
        <option value="zh">Chino</option>
        <option value="ar">Ãrabe</option>
        <option value="ja">JaponÃ©s</option>
      </select>
      <span style="font-family:var(--fMono);color:var(--muted)">â†’</span>
      <select id="tDest" style="min-width:110px">
        <option value="es" selected>EspaÃ±ol</option>
        <option value="en">InglÃ©s</option>
        <option value="fr">FrancÃ©s</option>
        <option value="de">AlemÃ¡n</option>
        <option value="pt">PortuguÃ©s</option>
        <option value="it">Italiano</option>
        <option value="ru">Ruso</option>
        <option value="zh">Chino</option>
        <option value="ar">Ãrabe</option>
        <option value="ja">JaponÃ©s</option>
      </select>
      <button class="btn pri" id="bTransAll">ğŸŒ Traducir todo</button>
      <button class="btn g"   id="bTransSel">ğŸŒ SelecciÃ³n</button>
      <button class="btn g"   id="bCopyTrans">ğŸ“‹ Copiar</button>
    </div>
    <div class="infobox warn">
      <b>Motor de traducciÃ³n:</b> Usa mÃºltiples APIs gratuitas en cascada â€” LibreTranslate (ilimitado) â†’ MyMemory (10.000 pal./dÃ­a) â†’ Lingva. Sin registro ni clave.
    </div>
    <div class="tgrid" style="flex:1">
      <div class="tcol">
        <div class="tlbl">TEXTO ORIGINAL</div>
        <div id="tOrig" class="out mt" style="flex:1">El texto original aparecerÃ¡ aquÃ­.</div>
      </div>
      <div class="tcol">
        <div class="tlbl">TRADUCCIÃ“N</div>
        <div id="tOut" class="out mt" style="flex:1">La traducciÃ³n aparecerÃ¡ aquÃ­.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TTS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="ttsbar">
  <button class="pbig sel" id="bSel"  title="Leer selecciÃ³n">â—ˆ</button>
  <button class="pbig"     id="bPlay" title="Reproducir / Pausar">â–¶</button>
  <button class="ibtn"     id="bStop" title="Detener" style="width:38px;height:38px;font-size:.88rem">â¹</button>
  <div class="hint">Espacio = pausar Â· Esc = detener Â· â—ˆ = leer selecciÃ³n</div>
</div>

<!-- â•â•â• CONTROL FLOTANTE â•â•â• -->
<div id="fc" class="off">
  <div class="fcdrg" id="fcdrag">â‹®â‹®</div>
  <button class="fcbtn r" id="fc-p">â–¶</button>
  <button class="fcbtn"   id="fc-s">â¹</button>
  <div class="fcspd" id="fcspd">1.0Ã—</div>
  <button class="fcbtn" id="fc-sl" title="MÃ¡s lento">ğŸ¢</button>
  <button class="fcbtn" id="fc-fa" title="MÃ¡s rÃ¡pido">âš¡</button>
</div>

<!-- â•â•â• MODAL PEGAR â•â•â• -->
<div class="ov" id="pasteOv">
  <div class="modal">
    <h2>ğŸ“‹ Pegar texto</h2>
    <textarea id="pasteA" placeholder="Pega aquÃ­ tu textoâ€¦"></textarea>
    <div class="mfooter">
      <button class="btn g"   id="bCancelP">Cancelar</button>
      <button class="btn pri" id="bConfP">Cargar texto â€º</button>
    </div>
  </div>
</div>

<!-- â•â•â• LIBRARIES â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER v4.2 â€” ACADEMIC EDITION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Cambios v4.2:
   â€¢ Paleta acadÃ©mica sobria (azul institucional / teal / Ã¡mbar)
   â€¢ TipografÃ­a: Source Serif 4 + IBM Plex Sans + IBM Plex Mono
   â€¢ SecciÃ³n "Herramientas" (ex Mapa) rediseÃ±ada completamente
   â€¢ TraducciÃ³n multi-API: LibreTranslate â†’ MyMemory â†’ Lingva
   â€¢ Voz por defecto: Google EspaÃ±ol (Estados Unidos)
   â€¢ JerarquÃ­a, comparativo e ideas clave mejorados visualmente
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ UTILIDADES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const qs = (s, ctx=document) => ctx.querySelector(s);
const E  = t => String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function toast(msg, dur=2700){
  const t=$('toast'); t.textContent=msg;
  t.classList.add('on');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('on'), dur);
}
function load(pct){
  $('lb').style.width=pct+'%';
  if(pct>=100) setTimeout(()=>$('lb').style.width='0%',500);
}
function dl(text, name){
  const b=new Blob([text],{type:'text/plain;charset=utf-8'});
  const u=URL.createObjectURL(b);
  Object.assign(document.createElement('a'),{href:u,download:name}).click();
  URL.revokeObjectURL(u);
}
function dlBlob(blob, name){
  const u=URL.createObjectURL(blob);
  Object.assign(document.createElement('a'),{href:u,download:name}).click();
  setTimeout(()=>URL.revokeObjectURL(u), 2000);
}
function debounce(fn, ms){
  let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); };
}
function goTab(name){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.tpane').forEach(x=>x.classList.remove('on'));
  const t=qs(`[data-tab="${name}"]`);
  if(t) t.classList.add('on');
  $('tab-'+name)?.classList.add('on');
}
window.goTab=goTab;

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fullText='';
let wordEls=[];
let curW=0;
let synth=window.speechSynthesis;
let voices=[];
let utt=null;
let playing=false, paused=false;
let notes=JSON.parse(localStorage.getItem('sr_notes_v42')||'[]');
let mediaRec=null, recChunks=[], recording=false;
let keepTimer=null;
let srchMatches=[], srchIdx=0;
let lastQs=[];
let lastMapData=null;

// â”€â”€ PDF.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pdfjsLib.GlobalWorkerOptions.workerSrc=
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ TEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bTheme').onclick=()=>{
  const dark=document.documentElement.dataset.theme==='dark';
  document.documentElement.dataset.theme=dark?'light':'dark';
  $('bTheme').textContent=dark?'ğŸŒ™':'â˜€ï¸';
};
$('bFS').onclick=()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};
$('bSide').onclick=()=>$('sideP').classList.toggle('off');
$('bFloat').onclick=()=>$('fc').classList.toggle('off');
$('sfont').onchange=()=>document.documentElement.style.setProperty('--fBody',$('sfont').value);
$('ssize').onchange=()=>document.documentElement.style.setProperty('--fs',$('ssize').value);
$('slh').onchange=()=>document.documentElement.style.setProperty('--lh',$('slh').value);

// â”€â”€ TABS NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tpane').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    $('tab-'+t.dataset.tab)?.classList.add('on');
  };
});

// â”€â”€ TOOL SUB-TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tool-tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tool-tab').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tool-pane').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    $(t.dataset.tpane)?.classList.add('on');
  };
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGA DE TEXTO â€” Multiformato
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadText(text, src='Texto'){
  fullText=text.trim();
  if(!fullText){toast('El texto estÃ¡ vacÃ­o.');return;}
  buildSpans(fullText);
  updateStats();
  stopSpeech();
  setProgress(0);
  clearSearch();
  const n=fullText.split(/\s+/).filter(Boolean).length;
  toast(`âœ“ ${src} â€” ${n.toLocaleString()} palabras`);
}

function buildSpans(text){
  const tokens=text.split(/(\s+)/);
  let html=''; let wi=0;
  tokens.forEach(tok=>{
    if(/\S/.test(tok)){
      html+=`<span class="w" data-i="${wi}">${E(tok)}</span>`;
      wi++;
    } else {
      html+=tok.replace(/\n/g,'<br/>');
    }
  });
  const d=$('textDisplay');
  d.innerHTML=html;
  d.classList.remove('mt');
  wordEls=[...d.querySelectorAll('.w')];
  curW=0;
}

function updateStats(){
  if(!fullText){$('sw').textContent='0';$('sp').textContent='0';$('st').textContent='0 min';return;}
  const w=fullText.split(/\s+/).filter(Boolean).length;
  $('sw').textContent=w.toLocaleString();
  $('sp').textContent=Math.max(1,Math.ceil(w/250));
  $('st').textContent=Math.max(1,Math.round(w/200))+' min';
}

// â”€â”€ FILE INPUT UNIFICADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bFile').onclick=()=>$('fileInput').click();
$('fileInput').onchange=async e=>{
  const file=e.target.files[0]; if(!file)return;
  const name=file.name.toLowerCase();
  load(10);
  try{
    if(name.endsWith('.pdf'))       await loadPDF(file);
    else if(name.endsWith('.docx')) await loadDOCX(file);
    else if(name.endsWith('.pptx')) await loadPPTX(file);
    else if(name.endsWith('.epub')) await loadEPUB(file);
    else                            await loadTXT(file);
  }catch(err){toast('Error: '+err.message);load(100);}
  $('fileInput').value='';
};

async function loadPDF(file){
  toast('â³ Leyendo PDFâ€¦',15000);
  const ab=await file.arrayBuffer(); load(30);
  let pdf;
  try{ pdf=await pdfjsLib.getDocument({data:ab}).promise; }
  catch(e){ toast('PDF daÃ±ado o protegido: '+e.message); load(100); return; }
  load(40);
  let text=''; let hasText=false;
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const ct=await page.getTextContent();
    if(ct.items.length) hasText=true;
    let pageText=''; let lastY=null; let lastX=null;
    ct.items.forEach(item=>{
      const y=item.transform[5], x=item.transform[4];
      if(lastY!==null){
        const dy=Math.abs(y-lastY);
        if(dy>12) pageText+='\n\n';
        else if(dy>4) pageText+='\n';
        else if(x-lastX>20) pageText+=' ';
      }
      pageText+=item.str;
      lastY=y; lastX=x+(item.width||0);
    });
    text+=pageText.trim()+'\n\n';
    load(40+Math.round((i/pdf.numPages)*55));
  }
  load(100);
  if(!hasText){ toast('âš ï¸ PDF escaneado (imagen). No contiene texto extraÃ­ble. Usa OCR primero.',5000); return; }
  loadText(text, file.name);
}

async function loadDOCX(file){
  toast('â³ Leyendo DOCXâ€¦',10000);
  if(typeof mammoth==='undefined'){ toast('LibrerÃ­a mammoth no disponible.'); load(100); return; }
  const ab=await file.arrayBuffer(); load(50);
  const result=await mammoth.extractRawText({arrayBuffer:ab});
  load(100);
  if(result.value) loadText(result.value, file.name);
  else toast('No se pudo extraer texto del DOCX.');
}

async function loadPPTX(file){
  toast('â³ Leyendo PPTXâ€¦',10000);
  try{
    const ab=await file.arrayBuffer(); load(30);
    const text=await extractPPTXText(ab);
    load(100);
    if(text.trim()) loadText(text, file.name);
    else toast('No se pudo extraer texto del PPTX.');
  }catch(e){ toast('Error PPTX: '+e.message); load(100); }
}

async function extractPPTXText(ab){
  const bytes=new Uint8Array(ab);
  const files=parseZip(bytes);
  const slideFiles=Object.keys(files)
    .filter(k=>k.match(/^ppt\/slides\/slide\d+\.xml$/))
    .sort((a,b)=>parseInt(a.match(/\d+/)[0])-parseInt(b.match(/\d+/)[0]));
  let text='';
  slideFiles.forEach((sf,i)=>{
    const xml=new TextDecoder('utf-8').decode(files[sf]);
    const matches=xml.match(/<a:t[^>]*>([^<]*)<\/a:t>/g)||[];
    const slideText=matches.map(m=>m.replace(/<[^>]+>/g,'')).filter(Boolean).join(' ');
    if(slideText.trim()) text+=`[Diapositiva ${i+1}]\n${slideText.trim()}\n\n`;
    load(30+Math.round((i/slideFiles.length)*65));
  });
  return text;
}

function parseZip(bytes){
  const files={};
  let i=0;
  const view=new DataView(bytes.buffer);
  while(i<bytes.length-4){
    if(view.getUint32(i,true)===0x04034b50){
      const fnLen=view.getUint16(i+26,true);
      const extraLen=view.getUint16(i+28,true);
      const compSize=view.getUint32(i+18,true);
      const compMethod=view.getUint16(i+8,true);
      const fname=new TextDecoder().decode(bytes.slice(i+30,i+30+fnLen));
      const dataStart=i+30+fnLen+extraLen;
      if(compMethod===0) files[fname]=bytes.slice(dataStart,dataStart+compSize);
      i=dataStart+compSize;
    } else { i++; }
  }
  return files;
}

async function loadEPUB(file){
  toast('â³ Leyendo EPUBâ€¦',10000);
  try{
    const ab=await file.arrayBuffer(); load(30);
    const bytes=new Uint8Array(ab);
    const zipFiles=parseZip(bytes);
    load(50);
    const htmlFiles=Object.keys(zipFiles).filter(k=>k.match(/\.(html|xhtml|htm)$/i)&&!k.includes('nav'));
    let text='';
    htmlFiles.forEach(hf=>{
      const html=new TextDecoder('utf-8').decode(zipFiles[hf]);
      const tmp=document.createElement('div');
      tmp.innerHTML=html;
      tmp.querySelectorAll('script,style,nav').forEach(el=>el.remove());
      const t=tmp.innerText||tmp.textContent;
      if(t.trim()) text+=t.trim()+'\n\n';
    });
    load(100);
    if(text.trim()) loadText(text, file.name);
    else toast('No se pudo extraer texto del EPUB.');
  }catch(e){ toast('Error EPUB: '+e.message); load(100); }
}

async function loadTXT(file){
  const r=new FileReader();
  return new Promise((res,rej)=>{
    r.onload=ev=>{ load(100); loadText(ev.target.result, file.name); res(); };
    r.onerror=rej;
    r.readAsText(file,'UTF-8');
  });
}

$('bPaste').onclick=()=>{ $('pasteOv').classList.add('on'); $('pasteA').focus(); };
$('bCancelP').onclick=()=>{ $('pasteOv').classList.remove('on'); $('pasteA').value=''; };
$('bConfP').onclick=()=>{
  const t=$('pasteA').value.trim();
  if(t) loadText(t,'Texto pegado');
  $('pasteOv').classList.remove('on'); $('pasteA').value='';
};
$('pasteOv').onclick=e=>{ if(e.target===$('pasteOv')) $('bCancelP').click(); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESALTADO Y NOTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('bHL').onclick=()=>{
  const sel=window.getSelection();
  if(!sel||sel.isCollapsed){ toast('Selecciona texto primero.'); return; }
  const range=sel.getRangeAt(0);
  const mark=document.createElement('mark');
  mark.className='hl';
  try{ range.surroundContents(mark); sel.removeAllRanges(); toast('âœ“ Texto resaltado'); }
  catch{ toast('SelecciÃ³n invÃ¡lida.'); }
};
$('bNote').onclick=()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(!txt){ toast('Selecciona texto para guardar como nota.'); return; }
  addNote(txt); sel.removeAllRanges(); toast('âœ“ Nota guardada');
};
function addNote(text){ notes.unshift({id:Date.now(),text,date:new Date().toLocaleString('es-CO')}); saveNotes(); renderNotes(); }
function saveNotes(){ localStorage.setItem('sr_notes_v42',JSON.stringify(notes)); }
function renderNotes(){
  $('emptyN').style.display=notes.length?'none':'block';
  const c=$('notesCont'); c.innerHTML='';
  notes.forEach(n=>{
    const d=document.createElement('div');
    d.className='ncard'; d.dataset.id=n.id;
    d.innerHTML=`
      <div class="nmeta">${E(n.date)}</div>
      <div class="nbody">${E(n.text)}</div>
      <div class="nacts">
        <button class="btn g" onclick="editNote(${n.id})">âœï¸ Editar</button>
        <button class="btn g" onclick="delNote(${n.id})">ğŸ—‘ Borrar</button>
        <button class="btn g" onclick="readNote(${n.id})">ğŸ”Š Leer</button>
      </div>`;
    c.appendChild(d);
  });
}
window.editNote=function(id){
  const n=notes.find(x=>x.id===id); if(!n)return;
  const card=qs(`.ncard[data-id="${id}"]`);
  const body=qs('.nbody',card);
  const ta=document.createElement('textarea'); ta.className='nta'; ta.value=n.text;
  body.replaceWith(ta);
  qs('.nacts',card).innerHTML=`
    <button class="btn pri" onclick="saveNote(${id})">ğŸ’¾ Guardar</button>
    <button class="btn g" onclick="renderNotes()">Cancelar</button>`;
};
window.saveNote=function(id){
  const ta=qs(`.ncard[data-id="${id}"] textarea`);
  const n=notes.find(x=>x.id===id);
  if(n&&ta){ n.text=ta.value; saveNotes(); renderNotes(); toast('âœ“ Nota actualizada'); }
};
window.delNote=function(id){
  if(!confirm('Â¿Eliminar esta nota?'))return;
  notes=notes.filter(x=>x.id!==id); saveNotes(); renderNotes();
};
window.readNote=function(id){ const n=notes.find(x=>x.id===id); if(n) speak(n.text); };
$('bClearNotes').onclick=()=>{ if(!confirm('Â¿Eliminar TODAS las notas?'))return; notes=[]; saveNotes(); renderNotes(); };
$('bExNotesTxt').onclick=()=>{
  if(!notes.length){ toast('No hay notas.'); return; }
  dl(notes.map(n=>`[${n.date}]\n${n.text}`).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€\n\n'),'stoica-notas.txt');
};
renderNotes();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BÃšSQUEDA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearSearch(){ srchMatches=[]; srchIdx=0; $('srchInfo').textContent=''; }
$('srchInput').addEventListener('input',debounce(doSearch,300));
$('bSrchNext').onclick=()=>{ if(srchMatches.length){ srchIdx=(srchIdx+1)%srchMatches.length; highlightSearchCurrent(); } };
$('bSrchPrev').onclick=()=>{ if(srchMatches.length){ srchIdx=(srchIdx-1+srchMatches.length)%srchMatches.length; highlightSearchCurrent(); } };

function doSearch(){
  const q=$('srchInput').value.trim().toLowerCase();
  document.querySelectorAll('mark.find').forEach(m=>{ const p=m.parentNode; p.replaceChild(document.createTextNode(m.textContent),m); p.normalize(); });
  srchMatches=[]; srchIdx=0;
  if(!q||!fullText){ $('srchInfo').textContent=''; return; }
  const d=$('textDisplay');
  const walker=document.createTreeWalker(d,NodeFilter.SHOW_TEXT,null);
  const textNodes=[]; let node;
  while((node=walker.nextNode())) textNodes.push(node);
  let count=0;
  textNodes.forEach(tn=>{
    const val=tn.nodeValue; const lower=val.toLowerCase();
    let idx=0, pos;
    const frag=document.createDocumentFragment();
    while((pos=lower.indexOf(q,idx))!==-1){
      if(pos>idx) frag.appendChild(document.createTextNode(val.slice(idx,pos)));
      const mark=document.createElement('mark');
      mark.className='find'; mark.textContent=val.slice(pos,pos+q.length);
      frag.appendChild(mark); srchMatches.push(mark); idx=pos+q.length; count++;
    }
    if(idx<val.length) frag.appendChild(document.createTextNode(val.slice(idx)));
    if(count) tn.parentNode.replaceChild(frag,tn);
  });
  $('srchInfo').textContent=count?`${count} resultado${count!==1?'s':''}`:' â€”';
  if(srchMatches.length) highlightSearchCurrent();
}
function highlightSearchCurrent(){
  srchMatches.forEach((m,i)=>m.className=i===srchIdx?'find cur':'find');
  srchMatches[srchIdx]?.scrollIntoView({behavior:'smooth',block:'center'});
  $('srchInfo').textContent=`${srchIdx+1}/${srchMatches.length}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEB SPEECH API â€” VOCES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadVoices(){
  voices=synth.getVoices();
  if(!voices.length) return;

  const sel=$('voiceSel'); sel.innerHTML='';

  // â”€â”€ Encontrar Google EspaÃ±ol (Estados Unidos) como predeterminado â”€â”€
  let defaultIdx=0;
  const esUSPatterns=['google espaÃ±ol estados unidos','google spanish united states','google es-us'];
  voices.forEach((v,i)=>{
    const o=document.createElement('option');
    o.value=i; o.textContent=`${v.name} (${v.lang})`;
    sel.appendChild(o);

    // Detectar Google ES-US
    const vn=v.name.toLowerCase();
    const vl=v.lang.toLowerCase();
    const isGoogleEsUS=
      (vl==='es-us'&&vn.includes('google'))||
      (vl.startsWith('es')&&vn.includes('google')&&(vn.includes('estados unidos')||vn.includes('united states')||vl==='es-us'))||
      esUSPatterns.some(p=>vn.includes(p.split(' ')[1])&&vl.startsWith('es'));
    if(isGoogleEsUS) defaultIdx=i;
  });

  // Fallback: primera voz en espaÃ±ol
  if(defaultIdx===0){
    voices.forEach((v,i)=>{ if(v.lang.startsWith('es')&&defaultIdx===0) defaultIdx=i; });
  }
  sel.value=defaultIdx;
  renderVoiceGrid();
}

loadVoices();
if(speechSynthesis.onvoiceschanged!==undefined) speechSynthesis.onvoiceschanged=loadVoices;

function renderVoiceGrid(){
  const filter=$('vLangFilter').value;
  const grid=$('voiceGrid'); grid.innerHTML='';
  const curIdx=parseInt($('voiceSel').value)||0;
  const filtered=voices.map((v,i)=>({v,i})).filter(({v})=>!filter||v.lang.startsWith(filter));
  $('vCount').textContent=`${filtered.length} voz${filtered.length!==1?'es':''}`;

  filtered.forEach(({v,i})=>{
    const card=document.createElement('div');
    card.className='vcard'+(i===curIdx?' sel':'');
    const lc=v.lang.split('-')[0].toLowerCase();
    const tagCls=(lc==='es')?'es':(lc==='en')?'en':'';
    const isStar=curIdx===i;
    card.innerHTML=`
      <div class="vname">${E(v.name)}</div>
      <div class="vlang">${E(v.lang)}</div>
      <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;margin-top:2px">
        <span class="vtag ${tagCls}">${E(v.lang)}</span>
        ${v.localService?'<span class="vtag" style="color:var(--acc2);border-color:rgba(61,201,176,.35)">Local</span>':''}
        ${isStar?'<span class="vtag star">â˜… Activa</span>':''}
        <button class="btn g" style="margin-left:auto;padding:2px 7px;font-size:.52rem"
          onclick="previewVoice(${i})">â–¶</button>
      </div>`;
    card.onclick=e=>{ if(e.target.tagName==='BUTTON')return; selectVoice(i); };
    grid.appendChild(card);
  });
}

window.selectVoice=function(i){
  $('voiceSel').value=i;
  renderVoiceGrid();
  toast(`âœ“ Voz activa: ${voices[i]?.name}`);
};
window.previewVoice=function(i){
  const txt=$('previewTxt').value.trim()||
    'Esta es una prueba de voz para el lector acadÃ©mico Stoica.';
  const u=new SpeechSynthesisUtterance(txt);
  if(voices[i]) u.voice=voices[i];
  u.rate=parseFloat($('rRate').value);
  u.pitch=parseFloat($('rPitch').value);
  u.volume=parseFloat($('rVol').value);
  synth.cancel(); synth.speak(u);
  toast(`â–¶ ${voices[i]?.name}`);
};
$('vLangFilter').onchange=renderVoiceGrid;
$('bRefreshVoices').onclick=()=>{ loadVoices(); toast('âœ“ Voces actualizadas'); };

// Sliders
$('rRate').oninput=()=>{ const v=parseFloat($('rRate').value).toFixed(1); $('rV').textContent=v+'Ã—'; $('fcspd').textContent=v+'Ã—'; };
$('rPitch').oninput=()=>$('pV').textContent=parseFloat($('rPitch').value).toFixed(1);
$('rVol').oninput=()=>$('vV').textContent=Math.round(parseFloat($('rVol').value)*100)+'%';

// â”€â”€ Utterance â”€â”€
function makeUtt(text){
  const u=new SpeechSynthesisUtterance(text);
  u.rate=parseFloat($('rRate').value);
  u.pitch=parseFloat($('rPitch').value);
  u.volume=parseFloat($('rVol').value);
  const vi=parseInt($('voiceSel').value);
  if(voices[vi]) u.voice=voices[vi];

  u.onstart=()=>{
    playing=true; paused=false;
    $('bPlay').textContent='â¸'; $('fc-p').textContent='â¸';
    $('statPill').textContent='â–¶ Reproduciendo';
    $('statPill').className='pill play';
  };
  u.onpause=()=>{
    paused=true;
    $('bPlay').textContent='â–¶'; $('fc-p').textContent='â–¶';
    $('statPill').textContent='â¸ Pausado';
    $('statPill').className='pill pause';
  };
  u.onresume=()=>{
    paused=false;
    $('bPlay').textContent='â¸'; $('fc-p').textContent='â¸';
    $('statPill').textContent='â–¶ Reproduciendo';
    $('statPill').className='pill play';
  };
  u.onend=u.onerror=()=>resetPlay();

  u.onboundary=ev=>{
    if(ev.name!=='word') return;
    const before=text.substring(0,ev.charIndex);
    const wIdx=before.split(/\s+/).filter(Boolean).length;
    hlWord(wIdx);
  };
  return u;
}

function hlWord(idx){
  if(!wordEls.length) return;
  if(curW<wordEls.length) wordEls[curW].classList.remove('now');
  curW=Math.min(idx,wordEls.length-1);
  const el=wordEls[curW];
  if(!el) return;
  el.classList.add('now','done');
  el.scrollIntoView({behavior:'smooth',block:'center',inline:'nearest'});
  setProgress(Math.round((curW/Math.max(1,wordEls.length-1))*100));
}
function clearHL(){ wordEls.forEach(w=>w.classList.remove('now','done')); curW=0; setProgress(0); }

function resetPlay(){
  clearInterval(keepTimer);
  playing=false; paused=false; utt=null;
  $('bPlay').textContent='â–¶'; $('fc-p').textContent='â–¶';
  $('statPill').textContent='Detenido';
  $('statPill').className='pill';
  clearHL(); stopRec();
}
function keepAlive(){
  clearInterval(keepTimer);
  keepTimer=setInterval(()=>{
    if(!synth.speaking){ clearInterval(keepTimer); return; }
    if(document.hidden){ synth.pause(); setTimeout(()=>{ if(playing&&paused) synth.resume(); },80); }
  },12000);
}
function speak(text){
  if(!text.trim()) return;
  synth.cancel(); clearHL();
  utt=makeUtt(text);
  keepAlive();
  synth.speak(utt);
}
function stopSpeech(){ clearInterval(keepTimer); synth.cancel(); resetPlay(); }
function togglePlay(){
  if(!playing&&!paused){
    const txt=fullText||$('textDisplay').textContent;
    if(!txt.trim()){ toast('Carga texto primero.'); return; }
    speak(txt);
  } else if(playing&&!paused){ synth.pause(); }
  else if(paused){ synth.resume(); }
}

$('bPlay').onclick=togglePlay;
$('fc-p').onclick=togglePlay;
$('bStop').onclick=stopSpeech;
$('fc-s').onclick=stopSpeech;
$('bSel').onclick=()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(txt) speak(txt); else toast('Selecciona texto primero.');
};
$('fc-sl').onclick=()=>{ const v=Math.max(.5,parseFloat($('rRate').value)-.1); $('rRate').value=v; $('rV').textContent=v.toFixed(1)+'Ã—'; $('fcspd').textContent=v.toFixed(1)+'Ã—'; };
$('fc-fa').onclick=()=>{ const v=Math.min(2.5,parseFloat($('rRate').value)+.1); $('rRate').value=v; $('rV').textContent=v.toFixed(1)+'Ã—'; $('fcspd').textContent=v.toFixed(1)+'Ã—'; };

function setProgress(pct){ $('pbfill').style.width=pct+'%'; $('spos').textContent=pct+'%'; }

$('pbtrack').onclick=e=>{
  if(!fullText){ toast('Carga texto primero.'); return; }
  const rect=$('pbtrack').getBoundingClientRect();
  const pct=Math.max(0,Math.min(100,((e.clientX-rect.left)/rect.width)*100));
  const wIdx=Math.floor((pct/100)*(wordEls.length-1));
  stopSpeech();
  const words=fullText.split(/\s+/).filter(Boolean);
  const from=words.slice(wIdx).join(' ');
  curW=wIdx;
  setTimeout(()=>{ speak(from); wordEls[wIdx]?.scrollIntoView({behavior:'smooth',block:'center'}); },80);
  setProgress(Math.round(pct));
};

// â”€â”€ Flotante â”€â”€
(()=>{
  const el=$('fc'), handle=$('fcdrag');
  let ox,oy,ex,ey;
  function onMove(cx,cy){ el.style.right='auto'; el.style.bottom='auto'; el.style.left=(ex+cx-ox)+'px'; el.style.top=(ey+cy-oy)+'px'; }
  handle.addEventListener('mousedown',e=>{ ex=el.offsetLeft; ey=el.offsetTop; ox=e.clientX; oy=e.clientY; e.preventDefault();
    const mm=ev=>onMove(ev.clientX,ev.clientY);
    document.addEventListener('mousemove',mm);
    document.addEventListener('mouseup',()=>document.removeEventListener('mousemove',mm),{once:true});
  });
  handle.addEventListener('touchstart',e=>{ const t=e.touches[0]; ex=el.offsetLeft; ey=el.offsetTop; ox=t.clientX; oy=t.clientY;
    const tm=ev=>{ const t2=ev.touches[0]; onMove(t2.clientX,t2.clientY); };
    document.addEventListener('touchmove',tm,{passive:true});
    document.addEventListener('touchend',()=>document.removeEventListener('touchmove',tm),{once:true});
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTAR AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('bExport').onclick=async()=>{
  const text=fullText.trim()||$('textDisplay').textContent.trim();
  if(!text){ toast('Carga texto primero.'); return; }
  try{
    const stream=await navigator.mediaDevices.getDisplayMedia({
      video:{displaySurface:'browser'},
      audio:{echoCancellation:false,noiseSuppression:false,sampleRate:48000}
    });
    const aTracks=stream.getAudioTracks();
    if(!aTracks.length){ stream.getTracks().forEach(t=>t.stop()); toast('âš ï¸ Activa "Compartir audio de la pestaÃ±a".'); return; }
    stream.getVideoTracks().forEach(t=>t.stop());
    const aStream=new MediaStream(aTracks);
    recChunks=[];
    const mimeType=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
    mediaRec=new MediaRecorder(aStream,{mimeType});
    mediaRec.ondataavailable=e=>{ if(e.data.size>0) recChunks.push(e.data); };
    mediaRec.onstop=()=>{
      const name=($('audioName').value.trim()||'stoica-audio').replace(/[^\w\-]/g,'_');
      dlBlob(new Blob(recChunks,{type:'audio/webm'}), name+'.webm');
      aStream.getTracks().forEach(t=>t.stop());
      showRecUI(false); toast('âœ“ Audio guardado: '+name+'.webm');
      recording=false; mediaRec=null;
    };
    mediaRec.start(1000); recording=true;
    showRecUI(true); speak(text);
    toast('ğŸ”´ Grabando â€” pulsa "Detener y guardar" cuando termines.',5000);
  }catch(err){
    if(err.name==='NotAllowedError') toast('Permiso denegado. Permite compartir la pantalla.');
    else toast('Error: '+err.message);
  }
};
$('bStopRec').onclick=()=>{ stopSpeech(); if(mediaRec&&recording) mediaRec.stop(); };
function stopRec(){ if(mediaRec&&recording) mediaRec.stop(); }
function showRecUI(on){ $('bExport').style.display=on?'none':''; $('bStopRec').style.display=on?'':'none'; $('recStatus').style.display=on?'':'none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADUCCIÃ“N â€” MULTI-API CASCADA (sin clave, sin registro)
// Prioridad: LibreTranslate pÃºblico â†’ MyMemory â†’ Lingva
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANG_NAMES={es:'EspaÃ±ol',en:'InglÃ©s',fr:'FrancÃ©s',de:'AlemÃ¡n',pt:'PortuguÃ©s',it:'Italiano',ru:'Ruso',zh:'Chino',ar:'Ãrabe',ja:'JaponÃ©s',auto:'auto'};

// Instancias pÃºblicas de LibreTranslate
const LIBRE_INSTANCES=[
  'https://libretranslate.de',
  'https://translate.terraprint.co',
  'https://lt.vern.cc'
];

async function tryLibreTranslate(text, src, dest){
  // LibreTranslate API: POST /translate (sin clave en instancias pÃºblicas)
  const srcCode=src==='auto'?'auto':src;
  for(const instance of LIBRE_INSTANCES){
    try{
      const res=await Promise.race([
        fetch(`${instance}/translate`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({q:text,source:srcCode,target:dest,format:'text'})
        }),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),6000))
      ]);
      if(!res.ok) continue;
      const data=await res.json();
      if(data.translatedText) return data.translatedText;
    }catch(e){ continue; }
  }
  throw new Error('LibreTranslate no disponible');
}

async function tryMyMemory(text, src, dest){
  const srcCode=src==='auto'?'en':src;
  const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${srcCode}|${dest}`;
  const res=await fetch(url);
  if(!res.ok) throw new Error('MyMemory error '+res.status);
  const data=await res.json();
  if(data.responseStatus!==200) throw new Error(data.responseDetails||'Error MyMemory');
  return data.responseData.translatedText;
}

async function tryLingva(text, src, dest){
  // Lingva API pÃºblica
  const srcCode=src==='auto'?'en':src;
  const encoded=encodeURIComponent(text);
  const res=await Promise.race([
    fetch(`https://lingva.ml/api/v1/${srcCode}/${dest}/${encoded}`),
    new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),6000))
  ]);
  if(!res.ok) throw new Error('Lingva error '+res.status);
  const data=await res.json();
  if(data.translation) return data.translation;
  throw new Error('Sin traducciÃ³n de Lingva');
}

async function translateChunk(text, src, dest){
  // Intentar en cascada
  try{ return await tryLibreTranslate(text,src,dest); } catch(e1){}
  try{ return await tryMyMemory(text,src,dest); } catch(e2){}
  try{ return await tryLingva(text,src,dest); } catch(e3){}
  throw new Error('Todos los servicios de traducciÃ³n fallaron. Verifica tu conexiÃ³n.');
}

function splitChunks(text, maxLen=800){
  const sentences=text.match(/[^.!?]+[.!?]*/g)||[text];
  const chunks=[]; let cur='';
  sentences.forEach(s=>{
    if((cur+s).length>maxLen){ if(cur) chunks.push(cur.trim()); cur=s; }
    else cur+=s;
  });
  if(cur.trim()) chunks.push(cur.trim());
  return chunks.length?chunks:[text];
}

async function runTranslate(text, src, dest, origEl, outEl){
  if(!text.trim()){ toast('No hay texto para traducir.'); return; }
  const truncated=text.length>5000?text.substring(0,5000):text;
  origEl.textContent=truncated+(text.length>5000?'\n[â€¦texto truncado a 5000 chars]':'');
  origEl.classList.remove('mt');
  outEl.textContent='â³ Traduciendoâ€¦';
  outEl.classList.remove('mt');
  load(10);
  try{
    const chunks=splitChunks(truncated,800);
    let result='';
    for(let i=0;i<chunks.length;i++){
      load(10+Math.round((i/chunks.length)*85));
      result+=await translateChunk(chunks[i],src,dest)+' ';
    }
    outEl.textContent=result.trim();
    load(100);
    toast(`âœ“ Traducido al ${LANG_NAMES[dest]}`);
    document.querySelector('[data-tab="translate"]').click();
  }catch(err){
    outEl.textContent='âŒ Error: '+err.message+'\n\nSugerencias:\nâ€¢ Verifica tu conexiÃ³n a internet\nâ€¢ Intenta con un fragmento mÃ¡s corto\nâ€¢ Espera unos minutos y vuelve a intentar';
    load(100);
  }
}

$('bTransAll').onclick=async()=>await runTranslate(fullText,$('tSrc').value,$('tDest').value,$('tOrig'),$('tOut'));
$('bTransSel').onclick=async()=>{
  const sel=window.getSelection(); const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(!txt){ toast('Selecciona texto primero.'); return; }
  await runTranslate(txt,$('tSrc').value,$('tDest').value,$('tOrig'),$('tOut'));
};
$('bCopyTrans').onclick=()=>{
  const t=$('tOut').textContent;
  if(!t||t.startsWith('La traducciÃ³n')){ toast('No hay traducciÃ³n.'); return; }
  navigator.clipboard.writeText(t).then(()=>toast('âœ“ TraducciÃ³n copiada'));
};
$('bQTrans').onclick=async()=>{
  if(!fullText.trim()){ toast('Carga texto primero.'); return; }
  $('tDest').value=$('sdest').value;
  await runTranslate(fullText,'auto',$('sdest').value,$('tOrig'),$('tOut'));
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALGORITMOS NLP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STOP_ES=new Set('a al ante aquÃ©l aquella aquello aquel como con cual de del desde dos el ella ellas ellos en entre era eres es esta estaba estas este esto estos fue hay la las le les lo los me mi mis muy no nos o para pero por que quien se si sin son su sus tambiÃ©n tan te tenÃ­a todo todos una uno unos voy ya yo un mÃ¡s ni'.split(' '));
const STOP_EN=new Set('a an the and or but if in on at to of for is are was were be been being have has had do does did will would shall should may might must can could am i we you he she it they their them there this that these those with from by as into then than also'.split(' '));

function extractWords(text){
  return text.toLowerCase().replace(/[^a-zÃ¡Ã©Ã­Ã³ÃºÃ¼Ã±\w\s]/gi,' ').split(/\s+/).filter(w=>w.length>3&&!STOP_ES.has(w)&&!STOP_EN.has(w));
}
function tfidf(text){
  const words=extractWords(text); const freq={};
  words.forEach(w=>{ freq[w]=(freq[w]||0)+1; });
  const max=Math.max(...Object.values(freq),1);
  Object.keys(freq).forEach(k=>freq[k]/=max);
  return freq;
}
function scoreSentences(sentences,freq){
  return sentences.map(s=>{
    const words=extractWords(s);
    if(!words.length) return {s,score:0};
    return {s, score:words.reduce((acc,w)=>acc+(freq[w]||0),0)/words.length};
  });
}

// â”€â”€ RESUMEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genSummary(text,n){
  const rawS=text.match(/[^.!?]+[.!?]*/g)||[];
  const sentences=rawS.map(s=>s.trim()).filter(s=>s.length>20);
  if(!sentences.length) return 'No se encontraron oraciones suficientes.';
  const freq=tfidf(text);
  const top=scoreSentences(sentences,freq).slice().sort((a,b)=>b.score-a.score).slice(0,n).map(x=>x.s);
  return sentences.filter(s=>top.includes(s)).join(' ');
}
$('bSumm').onclick=()=>{
  if(!fullText){ toast('Carga texto primero.'); return; }
  const nMap={breve:5,medio:10,completo:20};
  const n=nMap[$('sLevel').value];
  load(30);
  setTimeout(()=>{
    try{ $('summOut').textContent=genSummary(fullText,n); $('summOut').classList.remove('mt'); load(100); toast('âœ“ Resumen generado ('+n+' oraciones)'); }
    catch(e){ $('summOut').textContent='Error: '+e.message; load(100); }
  },100);
};
$('bCopySumm').onclick=()=>{
  if($('summOut').classList.contains('mt')){ toast('Genera un resumen primero.'); return; }
  navigator.clipboard.writeText($('summOut').textContent).then(()=>toast('âœ“ Copiado'));
};
$('bExSumm').onclick=()=>{
  if($('summOut').classList.contains('mt')){ toast('Genera un resumen primero.'); return; }
  dl($('summOut').textContent,'stoica-resumen.txt'); toast('âœ“ Exportado');
};

// â”€â”€ PREGUNTAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractSubject(sentence){
  const words=sentence.trim().split(/\s+/);
  const meaningful=words.filter(w=>w.length>2&&!STOP_ES.has(w.toLowerCase())&&!STOP_EN.has(w.toLowerCase()));
  return meaningful.slice(0,3).join(' ').replace(/[.,;:]/g,'')||words.slice(0,2).join(' ');
}
function summarizeSentence(s){
  const words=s.split(/\s+/);
  return words.length>15?words.slice(0,12).join(' ')+'â€¦':s;
}
function genQuestions(text,type,count){
  const rawS=text.match(/[^.!?]+[.!?]*/g)||[];
  const sentences=rawS.map(s=>s.trim()).filter(s=>s.split(/\s+/).length>6);
  if(sentences.length<3) return null;
  const freq=tfidf(text);
  const scored=scoreSentences(sentences,freq).sort((a,b)=>b.score-a.score);
  const questions=[]; const used=new Set();
  const templates={
    literal:[
      s=>({q:`Â¿QuÃ© se menciona sobre "${extractSubject(s)}"?`,a:s,j:'InformaciÃ³n explÃ­cita en el texto.'}),
      s=>({q:`SegÃºn el texto, Â¿quÃ© dice sobre ${extractSubject(s)}?`,a:s,j:'El texto lo expresa directamente.'}),
      s=>({q:`Â¿CÃ³mo describe el texto a "${extractSubject(s)}"?`,a:s,j:'DescripciÃ³n literal en el fragmento.'}),
      s=>({q:`Â¿QuÃ© afirma el autor sobre ${extractSubject(s)}?`,a:s,j:'AfirmaciÃ³n presente de forma explÃ­cita.'}),
    ],
    inferencial:[
      s=>({q:`Â¿Por quÃ© crees que "${extractSubject(s)}" es importante en el texto?`,a:'Inferencia: '+summarizeSentence(s),j:'ConclusiÃ³n deducida del contenido implÃ­cito.'}),
      s=>({q:`Â¿QuÃ© consecuencias se derivan de lo afirmado sobre ${extractSubject(s)}?`,a:'Consecuencia probable: '+summarizeSentence(s),j:'Se infiere del contexto general.'}),
      s=>({q:`Â¿QuÃ© intenciÃ³n tiene el autor al mencionar "${extractSubject(s)}"?`,a:'IntenciÃ³n probable: contextualizar el tema central.',j:'Deducido del tono y estructura.'}),
      s=>({q:`Â¿QuÃ© relaciÃ³n existe entre "${extractSubject(s)}" y el tema principal?`,a:'RelaciÃ³n: '+summarizeSentence(s),j:'Establecida implÃ­citamente.'}),
    ]
  };
  const pool=type==='mixto'?[...templates.literal,...templates.inferencial]:(templates[type]||templates.literal);
  let qi=0;
  for(let i=0;i<scored.length&&questions.length<count;i++){
    const sent=scored[i].s; if(used.has(sent)) continue; used.add(sent);
    const tpl=pool[qi%pool.length]; qi++;
    try{ const q=tpl(sent); if(q.q&&q.a) questions.push({...q,orig:sent}); }catch(e){}
  }
  if(questions.length<count){
    Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,20).map(e=>e[0]).forEach(kw=>{
      if(questions.length>=count) return;
      questions.push({q:`Â¿CuÃ¡l es la importancia de "${kw}" en el texto?`,a:`El tÃ©rmino "${kw}" es un concepto de alta frecuencia y relevancia en el texto.`,j:'Identificado como palabra clave por frecuencia.',orig:''});
    });
  }
  return questions.slice(0,count);
}

$('bGenQ').onclick=()=>{
  if(!fullText){ toast('Carga texto primero.'); return; }
  const count=Math.min(30,Math.max(5,parseInt($('qNum').value)||10));
  load(30);
  setTimeout(()=>{
    const qs=genQuestions(fullText,$('qType').value,count);
    load(100);
    if(!qs||!qs.length){ $('questOut').innerHTML='<p style="font-family:var(--fMono);font-size:.7rem;color:var(--muted)">Texto muy corto. Prueba con mÃ¡s contenido.</p>'; return; }
    lastQs=qs; renderQuestions(qs); toast(`âœ“ ${qs.length} preguntas generadas`);
  },150);
};

function renderQuestions(list){
  const c=$('questOut'); c.innerHTML='';
  list.forEach((q,i)=>{
    const card=document.createElement('div');
    card.className='qcard';
    card.innerHTML=`
      <div class="qnum">PREGUNTA ${i+1} Â· ${$('qType').value==='inferencial'?'Inferencial':'ComprensiÃ³n'}</div>
      <div class="qtxt">${E(q.q)}</div>
      <button class="btn g" style="align-self:flex-start" onclick="this.nextElementSibling.classList.toggle('vis');this.textContent=this.textContent.includes('Ver')?'Ocultar respuesta':'Ver respuesta'">Ver respuesta</button>
      <div class="qans">
        <strong>Respuesta:</strong> ${E(q.a)}<br/>
        <span class="qjust">JustificaciÃ³n: ${E(q.j)}</span>
        ${q.orig?`<br/><span class="qjust" style="color:var(--acc)">Fragmento: "${E(summarizeSentence(q.orig))}"</span>`:''}
      </div>`;
    c.appendChild(card);
  });
}

$('bCopyQ').onclick=()=>{
  if(!lastQs.length){ toast('Genera preguntas primero.'); return; }
  const text=lastQs.map((q,i)=>`${i+1}. ${q.q}\nRespuesta: ${q.a}\nJustificaciÃ³n: ${q.j}`).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€\n\n');
  navigator.clipboard.writeText(text).then(()=>toast('âœ“ Preguntas copiadas'));
};

// â”€â”€ EXPORT DOCX / XLSX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bExQDocx').onclick=()=>{ if(!lastQs.length){ toast('Genera preguntas primero.'); return; } exportQDocx(lastQs); };
$('bExQXlsx').onclick=()=>{ if(!lastQs.length){ toast('Genera preguntas primero.'); return; } exportQXlsx(lastQs); };

function makeDocxPara(text,bold=false,align='left',color='1a1d2e'){
  const jc=align==='center'?'<w:jc w:val="center"/>':'<w:jc w:val="left"/>';
  const rPr=`<w:rPr>${bold?'<w:b/>':''}<w:color w:val="${color}"/><w:sz w:val="${bold?'24':'20'}"/></w:rPr>`;
  const esc=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  return `<w:p><w:pPr>${jc}</w:pPr><w:r>${rPr}<w:t xml:space="preserve">${esc}</w:t></w:r></w:p>`;
}

function exportQDocx(qs){
  const paragraphs=[];
  paragraphs.push(makeDocxPara('Preguntas de ComprensiÃ³n â€” Stoica Reader',true,'center','1a3a6e'));
  paragraphs.push(makeDocxPara(`Generado: ${new Date().toLocaleDateString('es-CO')}`,false,'center','888888'));
  paragraphs.push(makeDocxPara(''));
  qs.forEach((q,i)=>{
    paragraphs.push(makeDocxPara(`${i+1}. ${q.q}`,true,'left','1a1d2e'));
    paragraphs.push(makeDocxPara(`Respuesta: ${q.a}`,false,'left','2d3560'));
    paragraphs.push(makeDocxPara(`JustificaciÃ³n: ${q.j}`,false,'left','666880'));
    if(q.orig) paragraphs.push(makeDocxPara(`Fragmento: "${summarizeSentence(q.orig)}"`,false,'left','888aaa'));
    paragraphs.push(makeDocxPara(''));
  });
  const docXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <w:body>${paragraphs.join('\n')}
    <w:sectPr><w:pgSz w:w="12240" w:h="15840"/><w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/></w:sectPr>
  </w:body>
</w:document>`;
  const zip=buildZip({
    '[Content_Types].xml':`<?xml version="1.0" encoding="UTF-8"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/></Types>`,
    '_rels/.rels':`<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/></Relationships>`,
    'word/document.xml':docXml,
    'word/_rels/document.xml.rels':`<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"></Relationships>`
  });
  dlBlob(zip,'stoica-preguntas.docx');
  toast('âœ“ Exportado como Word (.docx)');
}

function exportQXlsx(qs){
  const sharedStrings=[]; const ssMap={};
  function addStr(s){ const k=String(s); if(ssMap[k]===undefined){ ssMap[k]=sharedStrings.length; sharedStrings.push(k); } return ssMap[k]; }
  const headers=['#','Pregunta','Respuesta','JustificaciÃ³n','Fragmento'];
  const rows=[headers,...qs.map((q,i)=>[String(i+1),q.q,q.a,q.j,q.orig?summarizeSentence(q.orig):'â€”'])];
  const sheetRows=rows.map((row,ri)=>`<row r="${ri+1}">${row.map((cell,ci)=>`<c r="${String.fromCharCode(65+ci)}${ri+1}" t="s"><v>${addStr(cell)}</v></c>`).join('')}</row>`).join('\n');
  const zip=buildZip({
    '[Content_Types].xml':`<?xml version="1.0" encoding="UTF-8"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/><Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/><Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/></Types>`,
    '_rels/.rels':`<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>`,
    'xl/workbook.xml':`<?xml version="1.0" encoding="UTF-8"?><workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets><sheet name="Preguntas" sheetId="1" r:id="rId1"/></sheets></workbook>`,
    'xl/_rels/workbook.xml.rels':`<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/><Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/></Relationships>`,
    'xl/worksheets/sheet1.xml':`<?xml version="1.0" encoding="UTF-8"?><worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><sheetData>${sheetRows}</sheetData></worksheet>`,
    'xl/sharedStrings.xml':`<?xml version="1.0" encoding="UTF-8"?><sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${sharedStrings.length}" uniqueCount="${sharedStrings.length}">${sharedStrings.map(s=>`<si><t xml:space="preserve">${String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</t></si>`).join('')}</sst>`
  });
  dlBlob(zip,'stoica-preguntas.xlsx');
  toast('âœ“ Exportado como Excel (.xlsx)');
}

function buildZip(files){
  const enc=new TextEncoder();
  const entries=[]; let offset=0;
  Object.entries(files).forEach(([name,content])=>{
    const nameBytes=enc.encode(name);
    const dataBytes=enc.encode(content);
    const crc=crc32(dataBytes);
    const local=new Uint8Array(30+nameBytes.length+dataBytes.length);
    const view=new DataView(local.buffer);
    view.setUint32(0,0x04034b50,true); view.setUint16(4,20,true); view.setUint16(6,0,true); view.setUint16(8,0,true);
    view.setUint16(10,0,true); view.setUint16(12,0,true); view.setUint32(14,crc,true);
    view.setUint32(18,dataBytes.length,true); view.setUint32(22,dataBytes.length,true);
    view.setUint16(26,nameBytes.length,true); view.setUint16(28,0,true);
    local.set(nameBytes,30); local.set(dataBytes,30+nameBytes.length);
    entries.push({local,name:nameBytes,crc,size:dataBytes.length,offset});
    offset+=local.length;
  });
  const cdParts=[]; let cdSize=0;
  entries.forEach(({name,crc,size,offset})=>{
    const cd=new Uint8Array(46+name.length);
    const view=new DataView(cd.buffer);
    view.setUint32(0,0x02014b50,true); view.setUint16(4,20,true); view.setUint16(6,20,true);
    view.setUint16(8,0,true); view.setUint16(10,0,true); view.setUint16(12,0,true); view.setUint16(14,0,true);
    view.setUint32(16,crc,true); view.setUint32(20,size,true); view.setUint32(24,size,true);
    view.setUint16(28,name.length,true); view.setUint16(30,0,true); view.setUint16(32,0,true);
    view.setUint16(34,0,true); view.setUint32(38,0,true); view.setUint32(42,offset,true);
    cd.set(name,46); cdParts.push(cd); cdSize+=cd.length;
  });
  const eocd=new Uint8Array(22);
  const ev=new DataView(eocd.buffer);
  ev.setUint32(0,0x06054b50,true); ev.setUint16(4,0,true); ev.setUint16(6,0,true);
  ev.setUint16(8,entries.length,true); ev.setUint16(10,entries.length,true);
  ev.setUint32(12,cdSize,true); ev.setUint32(16,offset,true); ev.setUint16(20,0,true);
  const total=offset+cdSize+22;
  const result=new Uint8Array(total);
  let pos=0;
  entries.forEach(e=>{ result.set(e.local,pos); pos+=e.local.length; });
  cdParts.forEach(e=>{ result.set(e,pos); pos+=e.length; });
  result.set(eocd,pos);
  return new Blob([result],{type:'application/zip'});
}

function crc32(data){
  let crc=0xFFFFFFFF;
  const table=crc32.table||(crc32.table=(()=>{
    const t=[];
    for(let i=0;i<256;i++){ let c=i; for(let j=0;j<8;j++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); t[i]=c; }
    return t;
  })());
  for(let i=0;i<data.length;i++) crc=table[(crc^data[i])&0xFF]^(crc>>>8);
  return (crc^0xFFFFFFFF)>>>0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HERRAMIENTAS â€” AnÃ¡lisis conceptual mejorado
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genMapData(text){
  const freq=tfidf(text);
  const sorted=Object.entries(freq).filter(([w])=>w.length>3).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length) return null;

  const central=sorted[0][0];
  const rest=sorted.slice(1,41).map(e=>e[0]);

  // 6 grupos temÃ¡ticos con colores acadÃ©micos
  const GROUPS=[
    {name:'Conceptos principales', color:'var(--acc)', light:'var(--acc-dim)'},
    {name:'TÃ©rminos clave', color:'var(--acc2)', light:'var(--acc2-dim)'},
    {name:'Ideas secundarias', color:'var(--acc3)', light:'var(--acc3-dim)'},
    {name:'Contexto', color:'var(--gold)', light:'rgba(200,166,83,.1)'},
    {name:'Detalles', color:'#8b78d4', light:'rgba(139,120,212,.1)'},
    {name:'AmpliaciÃ³n', color:'#4fa8a8', light:'rgba(79,168,168,.1)'},
  ];
  const N=6;
  const branches=[];
  for(let i=0;i<rest.length;i+=N){
    const chunk=rest.slice(i,i+N);
    if(chunk.length) branches.push({...GROUPS[Math.floor(i/N)%GROUPS.length], conceptos:chunk});
  }

  // Oraciones clave
  const sentences=(text.match(/[^.!?]+[.!?]*/g)||[]).map(s=>s.trim()).filter(s=>s.length>25);
  const scoredS=scoreSentences(sentences,freq).sort((a,b)=>b.score-a.score).slice(0,10);

  // Niveles para jerarquÃ­a
  const hierLevels=[
    sorted.slice(0,4).map(e=>e[0]),
    sorted.slice(4,12).map(e=>e[0]),
    sorted.slice(12,28).map(e=>e[0])
  ];

  // Cuadro comparativo
  const compRows=[];
  sorted.slice(0,10).map(e=>e[0]).forEach(kw=>{
    const matching=sentences.filter(s=>s.toLowerCase().includes(kw)).slice(0,2);
    if(matching.length>=2) compRows.push({concepto:kw, a:summarizeSentence(matching[0]), b:summarizeSentence(matching[1])});
  });

  return {central, branches, ideas:scoredS.map(x=>x.s), hierLevels, compRows};
}

$('bGenAll').onclick=()=>{
  if(!fullText){ toast('Carga texto primero.'); return; }
  load(30);
  setTimeout(()=>{
    const data=genMapData(fullText);
    load(100);
    if(!data){ $('mmOut').textContent='Texto muy corto para analizar.'; return; }
    lastMapData=data;
    renderMindMap(data);
    renderHierarchy(data);
    renderComparative(data);
    renderIdeas(data);
    toast('âœ“ AnÃ¡lisis conceptual generado');
  },150);
};

function renderMindMap(data){
  const c=$('mmOut');
  let html=`<div style="display:flex;flex-direction:column;align-items:center;gap:18px;width:100%">`;
  html+=`<div style="text-align:center"><span class="mm-center">${E(data.central)}</span></div>`;
  html+=`<div class="mm-grid">`;
  data.branches.forEach(b=>{
    html+=`<div class="mm-branch" style="border-top:3px solid ${b.color};background:${b.light||'var(--surf2)'}">
      <div class="mm-branch-title" style="color:${b.color}">${E(b.name)}</div>
      <div class="mm-chips">`;
    b.conceptos.forEach(con=>html+=`<span class="mm-chip">${E(con)}</span>`);
    html+=`</div></div>`;
  });
  html+=`</div></div>`;
  c.innerHTML=html;
}

function renderHierarchy(data){
  const c=$('hierOut');
  const L=data.hierLevels;
  let html='<ul class="hier-root">';
  L[0].forEach(kw=>{
    html+=`<li class="hier-item"><span class="hier-node l0">${E(kw)}</span>`;
    if(L[1]&&L[1].length){
      html+='<ul class="hier-children">';
      L[1].slice(0,4).forEach(k1=>{
        html+=`<li class="hier-item"><span class="hier-node l1">${E(k1)}</span>`;
        if(L[2]&&L[2].length){
          html+='<ul class="hier-children">';
          L[2].slice(0,4).forEach(k2=>html+=`<li class="hier-item"><span class="hier-node l2">${E(k2)}</span></li>`);
          html+='</ul>';
        }
        html+='</li>';
      });
      html+='</ul>';
    }
    html+='</li>';
  });
  html+='</ul>';
  c.innerHTML=html;
}

function renderComparative(data){
  const c=$('compOut');
  if(!data.compRows||!data.compRows.length){
    c.innerHTML=`<div class="infobox">No hay suficientes coincidencias para el cuadro comparativo. Prueba con un texto mÃ¡s extenso.</div>`;
    return;
  }
  let html=`<table class="comp-table">
    <thead><tr>
      <th style="width:18%">Concepto</th>
      <th style="width:41%">Contexto A</th>
      <th style="width:41%">Contexto B</th>
    </tr></thead><tbody>`;
  data.compRows.slice(0,12).forEach(row=>{
    html+=`<tr>
      <td class="concept-cell">${E(row.concepto)}</td>
      <td>${E(row.a)}</td>
      <td>${E(row.b)}</td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  c.innerHTML=html;
}

function renderIdeas(data){
  const c=$('ideasOut');
  c.innerHTML='';
  data.ideas.forEach((s,i)=>{
    const card=document.createElement('div');
    card.className='idea-card';
    card.innerHTML=`<div class="idea-num">${i+1}</div><div class="idea-text">${E(s)}</div>`;
    c.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TECLADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  const tag=e.target.tagName;
  if(tag==='TEXTAREA'||tag==='INPUT') return;
  if(e.code==='Space'){ e.preventDefault(); togglePlay(); }
  if(e.code==='Escape') stopSpeech();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('sw.js').catch(()=>{}); });
}

console.log('%câœ¦ STOICA READER v4.2 â€” Academic Edition â€” 100% gratuito',
  'color:#5b8dee;font-family:monospace;font-weight:500;font-size:12px');
</script>
</body>
</html>

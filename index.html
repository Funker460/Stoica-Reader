<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stoica Reader</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0d0d14" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER v2 â€” Design System
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:        #faf7f2;
  --surface:   #f0ebe0;
  --surface2:  #e6dfd2;
  --border:    #c8bfad;
  --text:      #1a1612;
  --muted:     #7a7060;
  --accent:    #9b2335;
  --accent2:   #2a4a6b;
  --accent3:   #2d6a4f;
  --gold:      #b8860b;
  --btn-bg:    #1a1612;
  --btn-txt:   #faf7f2;
  --shadow-sm: 0 2px 8px rgba(26,22,18,0.10);
  --shadow-md: 0 8px 32px rgba(26,22,18,0.15);
  --shadow-lg: 0 20px 60px rgba(26,22,18,0.20);
  --radius:    8px;
  --radius-lg: 14px;
  --font-main: 'Libre Baskerville', Georgia, serif;
  --font-mono: 'JetBrains Mono', monospace;
  --font-size: 18px;
  --line-height: 1.9;
}
[data-theme="dark"] {
  --bg:        #0d0d14;
  --surface:   #14141f;
  --surface2:  #1c1c2a;
  --border:    #2a2a3d;
  --text:      #e8e4f8;
  --muted:     #6e6a88;
  --accent:    #e05c72;
  --accent2:   #7c9fd6;
  --accent3:   #52b788;
  --gold:      #d4a017;
  --btn-bg:    #e8e4f8;
  --btn-txt:   #0d0d14;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-md: 0 8px 32px rgba(0,0,0,0.4);
  --shadow-lg: 0 20px 60px rgba(0,0,0,0.5);
}

*,*::before,*::after { box-sizing: border-box; margin:0; padding:0; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--font-main);
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: background .3s, color .3s;
}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€ HEADER â”€â”€ */
header {
  height: 52px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  flex-shrink: 0;
  box-shadow: var(--shadow-sm);
  z-index: 50;
}
.logo {
  font-family: var(--font-mono);
  font-size: .95rem;
  font-weight: 500;
  letter-spacing: .12em;
  color: var(--accent);
}
.logo em { color: var(--text); font-style: normal; }
.header-right { display: flex; gap: 6px; align-items: center; }

/* â”€â”€ TABS â”€â”€ */
.tabs {
  display: flex;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  gap: 0;
  flex-shrink: 0;
}
.tab {
  padding: 8px 16px;
  font-family: var(--font-mono);
  font-size: .72rem;
  letter-spacing: .06em;
  border: none;
  background: none;
  color: var(--muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: color .15s, border-color .15s;
  white-space: nowrap;
}
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab:hover:not(.active) { color: var(--text); }

/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 10px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  align-items: center;
  flex-shrink: 0;
}
.sep { width: 1px; height: 22px; background: var(--border); margin: 0 2px; }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 14px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--btn-bg);
  color: var(--btn-txt);
  font-family: var(--font-mono);
  font-size: .72rem;
  cursor: pointer;
  transition: opacity .15s, transform .1s, box-shadow .15s;
  white-space: nowrap;
  letter-spacing: .04em;
}
.btn:hover { opacity: .85; box-shadow: var(--shadow-sm); }
.btn:active { transform: scale(.97); }
.btn.ghost {
  background: transparent;
  color: var(--text);
}
.btn.success { background: var(--accent3); color: #fff; border-color: var(--accent3); }
.btn.info    { background: var(--accent2); color: #fff; border-color: var(--accent2); }
.btn.warn    { background: var(--gold);    color: #fff; border-color: var(--gold); }
.icon-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  cursor: pointer;
  width: 34px; height: 34px;
  display: flex; align-items: center; justify-content: center;
  font-size: .9rem;
  transition: background .15s;
}
.icon-btn:hover { background: var(--border); }

/* â”€â”€ STATS BAR â”€â”€ */
.statsbar {
  display: flex; gap: 18px; flex-wrap: wrap;
  padding: 5px 20px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  font-family: var(--font-mono);
  font-size: .68rem;
  color: var(--muted);
  align-items: center;
  flex-shrink: 0;
}
.statsbar b { color: var(--text); font-weight: 500; }
.status-pill {
  font-family: var(--font-mono);
  font-size: .66rem;
  padding: 3px 9px;
  border-radius: 20px;
  background: var(--border);
  color: var(--muted);
  margin-left: auto;
}
.status-pill.playing { background: var(--accent);  color: #fff; }
.status-pill.paused  { background: var(--accent2); color: #fff; }

/* â”€â”€ PROGRESS BAR â”€â”€ */
.progress-wrap {
  padding: 0 20px 6px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.progress-track {
  width: 100%;
  height: 6px;
  background: var(--surface2);
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 3px;
  width: 0%;
  transition: width .3s;
  pointer-events: none;
}

/* â”€â”€ PANEL LAYOUT â”€â”€ */
.panel-layout {
  display: flex;
  flex: 1;
  overflow: hidden;
  min-height: 0;
}

/* â”€â”€ READER PANE â”€â”€ */
.reader-pane {
  flex: 1;
  overflow-y: auto;
  padding: 40px 80px;
  min-width: 0;
}
@media(max-width:700px) { .reader-pane { padding: 24px 18px; } }

#textDisplay {
  font-size: var(--font-size);
  line-height: var(--line-height);
  white-space: pre-wrap;
  word-break: break-word;
  outline: none;
  max-width: 780px;
  margin: 0 auto;
}
#textDisplay.empty::before {
  content: "Carga un PDF, un .txt o pega tu textoâ€¦";
  color: var(--muted);
  font-style: italic;
}
.word-span { display: inline; }
.word-span.reading {
  background: var(--accent);
  color: #fff;
  border-radius: 3px;
  padding: 0 2px;
  transition: background .1s;
}
.word-span.done {
  background: rgba(155,35,53,0.12);
  border-radius: 2px;
}
mark.hl {
  background: #f6d55c;
  color: #1a1612;
  border-radius: 3px;
  padding: 0 1px;
}

/* â”€â”€ SIDE PANEL â”€â”€ */
.side-panel {
  width: 340px;
  min-width: 280px;
  border-left: 1px solid var(--border);
  background: var(--surface);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
  transition: width .3s;
}
.side-panel.collapsed { width: 0; min-width: 0; border: none; overflow: hidden; }
.side-inner {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.side-section {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.side-section h3 {
  font-family: var(--font-mono);
  font-size: .72rem;
  letter-spacing: .08em;
  color: var(--muted);
  text-transform: uppercase;
}

/* â”€â”€ TTS PANEL â”€â”€ */
.tts-bar {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 12px 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  flex-shrink: 0;
  box-shadow: 0 -4px 16px rgba(0,0,0,.06);
}
.play-btn {
  width: 48px; height: 48px;
  border-radius: 50%;
  border: none;
  background: var(--accent);
  color: #fff;
  font-size: 1.25rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform .15s, box-shadow .15s;
  box-shadow: 0 4px 18px rgba(155,35,53,.4);
  flex-shrink: 0;
}
.play-btn:hover { transform: scale(1.08); box-shadow: 0 6px 24px rgba(155,35,53,.5); }
.play-btn.sel-btn { background: var(--accent2); box-shadow: 0 4px 18px rgba(42,74,107,.4); }
.slider-grp { display: flex; flex-direction: column; gap: 3px; min-width: 110px; }
.slider-grp label { font-family: var(--font-mono); font-size: .66rem; color: var(--muted); }
input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }
select {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-mono);
  font-size: .72rem;
  padding: 5px 8px;
  cursor: pointer;
}

/* â”€â”€ FLOATING CONTROL â”€â”€ */
.float-ctrl {
  position: fixed;
  bottom: 110px;
  right: 20px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  box-shadow: var(--shadow-lg);
  z-index: 300;
  align-items: center;
  min-width: 56px;
  transition: opacity .2s, transform .2s;
  cursor: move;
  user-select: none;
}
.float-ctrl.hidden { opacity: 0; pointer-events: none; transform: scale(.8); }
.float-ctrl .drag-handle {
  font-size: .6rem;
  color: var(--muted);
  letter-spacing: .1em;
  font-family: var(--font-mono);
  cursor: grab;
}
.float-ctrl .fc-speed {
  font-family: var(--font-mono);
  font-size: .72rem;
  color: var(--muted);
  text-align: center;
}
.fc-btn {
  width: 40px; height: 40px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 1rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background .15s;
}
.fc-btn:hover { background: var(--surface2); }
.fc-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }

/* â”€â”€ OVERLAY / MODAL â”€â”€ */
.overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 400;
  align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
}
.overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 28px;
  width: min(640px, 96vw);
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  display: flex; flex-direction: column; gap: 14px;
  animation: modalIn .2s ease;
}
@keyframes modalIn { from { opacity:0; transform: scale(.96) translateY(10px); } }
.modal h2 { font-family: var(--font-mono); font-size: .9rem; letter-spacing: .06em; }
.modal textarea, .modal select, .modal input[type=text] {
  width: 100%;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-main);
  font-size: .95rem;
  padding: 10px 12px;
}
.modal textarea { min-height: 200px; resize: vertical; }
.modal-footer { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
.modal-row { display: flex; gap: 10px; flex-wrap: wrap; }
.modal-row > * { flex: 1; min-width: 140px; }
.modal-section { display: flex; flex-direction: column; gap: 6px; }
.modal-section label { font-family: var(--font-mono); font-size: .7rem; color: var(--muted); }

/* â”€â”€ OUTPUT BOXES â”€â”€ */
.output-box {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  font-size: .9rem;
  line-height: 1.7;
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 60vh;
  overflow-y: auto;
}
.output-box.questions { font-size: .85rem; }

/* â”€â”€ NOTES â”€â”€ */
.note-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  animation: fadeIn .2s ease;
}
@keyframes fadeIn { from { opacity:0; transform: translateY(4px); } }
.note-meta { font-family: var(--font-mono); font-size: .66rem; color: var(--muted); }
.note-text { font-size: .88rem; line-height: 1.6; white-space: pre-wrap; }
.note-actions { display: flex; gap: 6px; }
.note-textarea {
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font-main);
  font-size: .88rem;
  padding: 6px 8px;
  border-radius: 4px;
  width: 100%;
  resize: none;
  min-height: 60px;
}

/* â”€â”€ MINDMAP CANVAS â”€â”€ */
#mindmapCanvas {
  width: 100%;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  cursor: crosshair;
  touch-action: none;
}

/* â”€â”€ FONT CONTROLS â”€â”€ */
.font-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.font-row label { font-family: var(--font-mono); font-size: .68rem; color: var(--muted); }

/* â”€â”€ LOADING â”€â”€ */
.loading-bar {
  position: fixed;
  top: 0; left: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  z-index: 999;
  width: 0%;
  transition: width .3s;
}
.toast {
  position: fixed;
  bottom: 100px; left: 50%;
  transform: translateX(-50%);
  background: var(--btn-bg);
  color: var(--btn-txt);
  padding: 10px 20px;
  border-radius: 24px;
  font-family: var(--font-mono);
  font-size: .78rem;
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s, transform .3s;
  white-space: nowrap;
  box-shadow: var(--shadow-md);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }

/* hidden */
#fileInput, #txtInput { display: none; }

/* â”€â”€ CONCEPT MAP NODES â”€â”€ */
.concept-node {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 12px;
  font-size: .8rem;
  font-family: var(--font-mono);
  color: var(--text);
  display: inline-block;
  margin: 4px;
  cursor: pointer;
  transition: background .15s;
}
.concept-node:hover { background: var(--accent); color: #fff; }
.concept-central {
  background: var(--accent);
  color: #fff;
  font-weight: 600;
  border-color: var(--accent);
}

/* â”€â”€ QUESTION CARDS â”€â”€ */
.q-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
}
.q-card .q-num {
  font-family: var(--font-mono);
  font-size: .66rem;
  color: var(--muted);
  margin-bottom: 4px;
}
.q-card .q-text { font-size: .9rem; font-weight: 600; margin-bottom: 8px; }
.q-card .q-answer { font-size: .85rem; color: var(--muted); display: none; padding-top: 8px; border-top: 1px dashed var(--border); }
.q-card .q-answer.visible { display: block; color: var(--text); }
.q-card .q-just { font-size: .78rem; color: var(--muted); margin-top: 4px; font-style: italic; }
.q-options label { display: block; font-size: .85rem; margin: 4px 0; cursor: pointer; }
.q-options label:hover { color: var(--accent); }

/* â”€â”€ TRANSLATION PANEL â”€â”€ */
.translate-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.lang-select { min-width: 130px; }

/* TABS CONTENT */
.tab-content { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.tab-content.active { display: flex; }
</style>
</head>
<body data-theme="light">

<!-- Loading bar -->
<div class="loading-bar" id="loadingBar"></div>
<div class="toast" id="toast"></div>

<!-- Hidden inputs -->
<input type="file" id="fileInput" accept=".pdf" />
<input type="file" id="txtInput"  accept=".txt,.md" />

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="logo">STOICA<em>READER</em> <span style="font-size:.6rem;color:var(--muted);letter-spacing:.04em;">v2</span></div>
  <div class="header-right">
    <button class="icon-btn" id="themeBtn" title="Claro/Oscuro">ğŸŒ™</button>
    <button class="icon-btn" id="fsBtn"    title="Pantalla completa">â›¶</button>
    <button class="icon-btn" id="sideBtn"  title="Panel lateral">â–</button>
    <button class="icon-btn" id="floatBtn" title="Control flotante">âŠ•</button>
  </div>
</header>

<!-- â•â•â• TABS â•â•â• -->
<div class="tabs">
  <button class="tab active" data-tab="reader">ğŸ“– Lector</button>
  <button class="tab" data-tab="notes">ğŸ“ Notas</button>
  <button class="tab" data-tab="summary">ğŸ“‹ Resumen</button>
  <button class="tab" data-tab="questions">â“ Preguntas</button>
  <button class="tab" data-tab="mindmap">ğŸ—º Mapa</button>
  <button class="tab" data-tab="translate">ğŸŒ TraducciÃ³n</button>
</div>

<!-- â•â•â• TOOLBAR â•â•â• -->
<div class="toolbar">
  <button class="btn" id="loadPdf">ğŸ“„ PDF</button>
  <button class="btn" id="loadTxt">ğŸ“ TXT</button>
  <button class="btn ghost" id="pasteBtn">ğŸ“‹ Pegar</button>
  <div class="sep"></div>
  <div class="font-row">
    <label>Fuente</label>
    <select id="fontSel">
      <option value="'Libre Baskerville',Georgia,serif">Baskerville</option>
      <option value="Georgia,serif">Georgia</option>
      <option value="'JetBrains Mono',monospace">Mono</option>
      <option value="Arial,sans-serif">Arial</option>
      <option value="'Courier New',monospace">Courier</option>
    </select>
    <label>TamaÃ±o</label>
    <select id="fontSizeSel">
      <option value="14px">14</option>
      <option value="16px">16</option>
      <option value="18px" selected>18</option>
      <option value="20px">20</option>
      <option value="24px">24</option>
      <option value="28px">28</option>
    </select>
    <label>Interlineado</label>
    <select id="lineHSel">
      <option value="1.5">1.5</option>
      <option value="1.9" selected>1.9</option>
      <option value="2.2">2.2</option>
    </select>
  </div>
  <div class="sep"></div>
  <button class="btn ghost" id="hlBtn">ğŸ–Š Resaltar sel.</button>
  <button class="btn ghost" id="saveNoteBtn">ğŸ’¾ Guardar nota</button>
</div>

<!-- â•â•â• STATS â•â•â• -->
<div class="statsbar">
  <span>Palabras: <b id="wordCount">0</b></span>
  <span>PÃ¡ginas: <b id="pageCount">0</b></span>
  <span>â± <b id="readTime">0 min</b></span>
  <span>PosiciÃ³n: <b id="posInfo">0%</b></span>
  <span id="statusPill" class="status-pill">Detenido</span>
</div>

<!-- â•â•â• PROGRESS BAR â•â•â• -->
<div class="progress-wrap">
  <div class="progress-track" id="progressTrack" title="Haz clic para ir a esa posiciÃ³n">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<!-- â•â•â• TAB: READER â•â•â• -->
<div class="tab-content active" id="tab-reader">
  <div class="panel-layout">
    <div class="reader-pane" id="readerPane">
      <div id="textDisplay" class="empty"></div>
    </div>
    <aside class="side-panel" id="sidePanel">
      <div class="side-inner">
        <div class="side-section">
          <h3>Voz</h3>
          <select id="voiceSelect"></select>
          <div class="slider-grp">
            <label>Velocidad: <b id="rateVal">1.0</b>x</label>
            <input type="range" id="rateSlider" min=".5" max="2.5" step=".1" value="1" />
          </div>
          <div class="slider-grp">
            <label>Tono: <b id="pitchVal">1.0</b></label>
            <input type="range" id="pitchSlider" min=".5" max="2" step=".1" value="1" />
          </div>
          <div class="slider-grp">
            <label>Volumen: <b id="volVal">100</b>%</label>
            <input type="range" id="volSlider" min="0" max="1" step=".05" value="1" />
          </div>
        </div>
        <div class="side-section">
          <h3>Exportar audio</h3>
          <input type="text" id="audioName" placeholder="nombre-del-audio" style="border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text);font-family:var(--font-mono);font-size:.72rem;padding:6px 8px;width:100%;" />
          <button class="btn success" id="exportAudio">ğŸ”Š Guardar MP3</button>
          <p style="font-family:var(--font-mono);font-size:.64rem;color:var(--muted);">Nota: usa la voz del sistema. El archivo se genera desde el navegador.</p>
        </div>
        <div class="side-section">
          <h3>TraducciÃ³n rÃ¡pida</h3>
          <select id="sideTransDest" class="lang-select">
            <option value="es">â†’ EspaÃ±ol</option>
            <option value="en">â†’ InglÃ©s</option>
            <option value="fr">â†’ FrancÃ©s</option>
            <option value="de">â†’ AlemÃ¡n</option>
            <option value="pt">â†’ PortuguÃ©s</option>
            <option value="it">â†’ Italiano</option>
          </select>
          <button class="btn info" id="quickTranslate">ğŸŒ Traducir texto</button>
          <p style="font-family:var(--font-mono);font-size:.64rem;color:var(--muted);">Usa el API de Claude para traducir el texto actual.</p>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- â•â•â• TAB: NOTAS â•â•â• -->
<div class="tab-content" id="tab-notes">
  <div style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <h2 style="font-family:var(--font-mono);font-size:.85rem;letter-spacing:.06em;">MIS NOTAS</h2>
      <button class="btn ghost" id="clearNotes" style="margin-left:auto;">ğŸ—‘ Limpiar todo</button>
      <button class="btn" id="exportNotes">â†“ Exportar notas</button>
    </div>
    <div id="notesContainer" style="display:flex;flex-direction:column;gap:10px;">
      <p id="emptyNotes" style="font-family:var(--font-mono);font-size:.78rem;color:var(--muted);padding:20px 0;">AÃºn no tienes notas. Selecciona texto y pulsa "Guardar nota".</p>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: RESUMEN â•â•â• -->
<div class="tab-content" id="tab-summary">
  <div style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <h2 style="font-family:var(--font-mono);font-size:.85rem;letter-spacing:.06em;">RESUMEN AUTOMÃTICO</h2>
      <select id="summaryLevel" style="border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text);font-family:var(--font-mono);font-size:.72rem;padding:5px 8px;">
        <option value="breve">Breve (3-5 oraciones)</option>
        <option value="intermedio" selected>Intermedio (1-2 pÃ¡rrafos)</option>
        <option value="detallado">Detallado (anÃ¡lisis completo)</option>
      </select>
      <button class="btn" id="genSummary">âœ¨ Generar resumen</button>
      <button class="btn ghost" id="copySummary">ğŸ“‹ Copiar</button>
    </div>
    <div id="summaryOutput" class="output-box">El resumen aparecerÃ¡ aquÃ­ una vez que generes uno.</div>
  </div>
</div>

<!-- â•â•â• TAB: PREGUNTAS â•â•â• -->
<div class="tab-content" id="tab-questions">
  <div style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <h2 style="font-family:var(--font-mono);font-size:.85rem;letter-spacing:.06em;">PREGUNTAS AUTOMÃTICAS</h2>
      <select id="qType">
        <option value="mixtas">Mixtas</option>
        <option value="abiertas">Abiertas</option>
        <option value="cerradas">Cerradas</option>
        <option value="opcion_multiple">OpciÃ³n mÃºltiple</option>
      </select>
      <select id="qLevel">
        <option value="literal">Nivel literal</option>
        <option value="inferencial">Nivel inferencial</option>
        <option value="critico">Nivel crÃ­tico-valorativo</option>
        <option value="analogico">Nivel analÃ³gico-intertextual</option>
      </select>
      <input type="number" id="qCount" value="10" min="5" max="30" style="width:60px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text);font-family:var(--font-mono);font-size:.72rem;padding:5px 8px;" />
      <button class="btn" id="genQuestions">âœ¨ Generar preguntas</button>
      <button class="btn ghost" id="copyQuestions">ğŸ“‹ Copiar</button>
    </div>
    <div id="questionsOutput" class="output-box questions">Las preguntas aparecerÃ¡n aquÃ­.</div>
  </div>
</div>

<!-- â•â•â• TAB: MAPA CONCEPTUAL â•â•â• -->
<div class="tab-content" id="tab-mindmap">
  <div style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <h2 style="font-family:var(--font-mono);font-size:.85rem;letter-spacing:.06em;">MAPA CONCEPTUAL</h2>
      <button class="btn" id="genMindmap">âœ¨ Generar mapa</button>
      <button class="btn ghost" id="exportMindmap">â†“ Exportar imagen</button>
    </div>
    <div id="conceptMapContainer" style="display:flex;flex-direction:column;gap:12px;">
      <div id="conceptMapOutput" style="min-height:200px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start;align-content:flex-start;">
        <p style="font-family:var(--font-mono);font-size:.78rem;color:var(--muted);">El mapa de conceptos clave aparecerÃ¡ aquÃ­.</p>
      </div>
      <div id="keyIdeasOutput" class="output-box" style="font-size:.85rem;"></div>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: TRADUCCIÃ“N â•â•â• -->
<div class="tab-content" id="tab-translate">
  <div style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <h2 style="font-family:var(--font-mono);font-size:.85rem;letter-spacing:.06em;">TRADUCCIÃ“N</h2>
      <div class="translate-row">
        <select id="transSource" class="lang-select">
          <option value="auto">Detectar idioma</option>
          <option value="es">EspaÃ±ol</option>
          <option value="en">InglÃ©s</option>
          <option value="fr">FrancÃ©s</option>
          <option value="de">AlemÃ¡n</option>
          <option value="pt">PortuguÃ©s</option>
          <option value="it">Italiano</option>
          <option value="zh">Chino</option>
          <option value="ja">JaponÃ©s</option>
          <option value="ar">Ãrabe</option>
          <option value="ru">Ruso</option>
        </select>
        <span style="font-family:var(--font-mono);font-size:.9rem;">â†’</span>
        <select id="transDest" class="lang-select">
          <option value="es" selected>EspaÃ±ol</option>
          <option value="en">InglÃ©s</option>
          <option value="fr">FrancÃ©s</option>
          <option value="de">AlemÃ¡n</option>
          <option value="pt">PortuguÃ©s</option>
          <option value="it">Italiano</option>
          <option value="zh">Chino</option>
          <option value="ja">JaponÃ©s</option>
          <option value="ar">Ãrabe</option>
          <option value="ru">Ruso</option>
        </select>
        <button class="btn" id="transAll">ğŸŒ Traducir texto completo</button>
        <button class="btn ghost" id="transSel">ğŸŒ Traducir selecciÃ³n</button>
        <button class="btn ghost" id="copyTrans">ğŸ“‹ Copiar</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;flex:1;">
      <div>
        <div style="font-family:var(--font-mono);font-size:.66rem;color:var(--muted);margin-bottom:6px;">TEXTO ORIGINAL</div>
        <div id="transOriginal" class="output-box" style="max-height:none;height:calc(100% - 24px);">El texto original aparecerÃ¡ aquÃ­.</div>
      </div>
      <div>
        <div style="font-family:var(--font-mono);font-size:.66rem;color:var(--muted);margin-bottom:6px;">TRADUCCIÃ“N</div>
        <div id="transOutput" class="output-box" style="max-height:none;height:calc(100% - 24px);">La traducciÃ³n aparecerÃ¡ aquÃ­.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• TTS BOTTOM BAR â•â•â• -->
<div class="tts-bar">
  <button class="play-btn sel-btn" id="readSelBtn" title="Leer selecciÃ³n">â—ˆ</button>
  <button class="play-btn" id="playBtn" title="Reproducir/Pausar">â–¶</button>
  <button class="icon-btn" id="stopBtn" title="Detener" style="width:42px;height:42px;">â¹</button>
  <div style="flex:1;"></div>
  <span style="font-family:var(--font-mono);font-size:.68rem;color:var(--muted);">Espacio = pausar Â· Esc = detener</span>
</div>

<!-- â•â•â• FLOATING CONTROL â•â•â• -->
<div class="float-ctrl hidden" id="floatCtrl">
  <div class="drag-handle" id="dragHandle">â‹®â‹®</div>
  <button class="fc-btn primary" id="fc-play">â–¶</button>
  <button class="fc-btn" id="fc-stop">â¹</button>
  <div class="fc-speed" id="fcSpeedLbl">1.0x</div>
  <button class="fc-btn" id="fc-slower" title="MÃ¡s lento">ğŸ¢</button>
  <button class="fc-btn" id="fc-faster" title="MÃ¡s rÃ¡pido">âš¡</button>
</div>

<!-- â•â•â• MODALS â•â•â• -->

<!-- Paste Modal -->
<div class="overlay" id="pasteOverlay">
  <div class="modal">
    <h2>ğŸ“‹ Pegar texto</h2>
    <textarea id="pasteArea" placeholder="Pega aquÃ­ tu textoâ€¦"></textarea>
    <div class="modal-footer">
      <button class="btn ghost" id="cancelPaste">Cancelar</button>
      <button class="btn" id="confirmPaste">Cargar texto â€º</button>
    </div>
  </div>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER v2 â€” JavaScript Engine
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ CONFIG â”€â”€
const CLAUDE_API = "https://api.anthropic.com/v1/messages";
const CLAUDE_MODEL = "claude-sonnet-4-20250514";
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ STATE â”€â”€
let fullText   = '';
let wordSpans  = [];
let currentWordIdx = 0;
let synth      = window.speechSynthesis;
let voices     = [];
let utterance  = null;
let isPlaying  = false;
let isPaused   = false;
let notes      = JSON.parse(localStorage.getItem('stoica_notes') || '[]');
let readProgress = 0;

// â”€â”€ DOM â”€â”€
const $ = id => document.getElementById(id);
const display    = $('textDisplay');
const playBtn    = $('playBtn');
const stopBtn    = $('stopBtn');
const readSelBtn = $('readSelBtn');
const rateSlider = $('rateSlider');
const pitchSlider= $('pitchSlider');
const volSlider  = $('volSlider');
const voiceSel   = $('voiceSelect');
const rateVal    = $('rateVal');
const pitchVal   = $('pitchVal');
const volVal     = $('volVal');
const statusPill = $('statusPill');
const progressFill = $('progressFill');
const posInfo    = $('posInfo');
const loadingBar = $('loadingBar');

// â”€â”€ TOAST â”€â”€
function showToast(msg, dur=2500) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), dur);
}

// â”€â”€ LOADING â”€â”€
function setLoading(pct) {
  loadingBar.style.width = pct + '%';
  if (pct >= 100) setTimeout(() => loadingBar.style.width = '0%', 400);
}

// â”€â”€ THEME â”€â”€
$('themeBtn').addEventListener('click', () => {
  const dark = document.body.dataset.theme === 'dark';
  document.body.dataset.theme = dark ? 'light' : 'dark';
  $('themeBtn').textContent = dark ? 'ğŸŒ™' : 'â˜€ï¸';
});

// â”€â”€ FULLSCREEN â”€â”€
$('fsBtn').addEventListener('click', () => {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
});

// â”€â”€ SIDE PANEL â”€â”€
$('sideBtn').addEventListener('click', () => {
  $('sidePanel').classList.toggle('collapsed');
});

// â”€â”€ FLOAT CONTROL â”€â”€
$('floatBtn').addEventListener('click', () => {
  $('floatCtrl').classList.toggle('hidden');
});

// â”€â”€ FONT â”€â”€
$('fontSel').addEventListener('change', () => {
  document.documentElement.style.setProperty('--font-main', $('fontSel').value);
});
$('fontSizeSel').addEventListener('change', () => {
  document.documentElement.style.setProperty('--font-size', $('fontSizeSel').value);
});
$('lineHSel').addEventListener('change', () => {
  document.documentElement.style.setProperty('--line-height', $('lineHSel').value);
});

// â”€â”€ TABS â”€â”€
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    $('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXT LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadText(text, source='texto') {
  fullText = text.trim();
  if (!fullText) { showToast('El texto estÃ¡ vacÃ­o.'); return; }
  display.classList.remove('empty');
  buildWordSpans(fullText);
  updateStats();
  stopSpeech();
  setProgress(0);
  showToast(`âœ“ ${source} cargado â€” ${fullText.split(/\s+/).length.toLocaleString()} palabras`);
}

function buildWordSpans(text) {
  wordSpans = [];
  currentWordIdx = 0;
  // Split preserving whitespace groups
  const parts = text.split(/(\s+)/);
  let html = '';
  let wIdx = 0;
  parts.forEach(part => {
    if (/\S/.test(part)) {
      html += `<span class="word-span" data-w="${wIdx}">${escapeHtml(part)}</span>`;
      wIdx++;
    } else {
      html += escapeHtml(part);
    }
  });
  display.innerHTML = html;
  wordSpans = display.querySelectorAll('.word-span');
}

function escapeHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function updateStats() {
  const words = fullText ? fullText.split(/\s+/).filter(Boolean).length : 0;
  $('wordCount').textContent = words.toLocaleString();
  $('pageCount').textContent = Math.ceil(words / 250);
  $('readTime').textContent  = Math.max(1, Math.round(words / 200)) + ' min';
}

// â”€â”€ PDF â”€â”€
$('loadPdf').addEventListener('click', () => $('fileInput').click());
$('fileInput').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  setLoading(10);
  try {
    const ab = await file.arrayBuffer();
    setLoading(30);
    const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
    setLoading(50);
    let text = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(s => s.str).join(' ') + '\n\n';
      setLoading(50 + Math.round((i / pdf.numPages) * 45));
    }
    setLoading(100);
    loadText(text, file.name);
  } catch(err) {
    showToast('Error al leer el PDF: ' + err.message);
    setLoading(100);
  }
  $('fileInput').value = '';
});

// â”€â”€ TXT â”€â”€
$('loadTxt').addEventListener('click', () => $('txtInput').click());
$('txtInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  setLoading(20);
  const reader = new FileReader();
  reader.onload = ev => { setLoading(100); loadText(ev.target.result, file.name); };
  reader.readAsText(file, 'UTF-8');
  $('txtInput').value = '';
});

// â”€â”€ PASTE â”€â”€
$('pasteBtn').addEventListener('click', () => { $('pasteOverlay').classList.add('open'); $('pasteArea').focus(); });
$('cancelPaste').addEventListener('click', () => { $('pasteOverlay').classList.remove('open'); $('pasteArea').value=''; });
$('confirmPaste').addEventListener('click', () => {
  const t = $('pasteArea').value.trim();
  if (t) loadText(t, 'Texto pegado');
  $('pasteOverlay').classList.remove('open');
  $('pasteArea').value = '';
});
$('pasteOverlay').addEventListener('click', e => { if (e.target===$('pasteOverlay')) $('cancelPaste').click(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HIGHLIGHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('hlBtn').addEventListener('click', () => {
  const sel = window.getSelection();
  if (!sel || sel.isCollapsed) { showToast('Selecciona texto primero.'); return; }
  const range = sel.getRangeAt(0);
  const mark = document.createElement('mark');
  mark.className = 'hl';
  try { range.surroundContents(mark); sel.removeAllRanges(); showToast('Texto resaltado âœ“'); }
  catch(e) { showToast('No se puede resaltar esa selecciÃ³n.'); }
});

// â”€â”€ SAVE NOTE â”€â”€
$('saveNoteBtn').addEventListener('click', () => {
  const sel = window.getSelection();
  const txt = (sel && !sel.isCollapsed) ? sel.toString().trim() : null;
  if (!txt) { showToast('Selecciona texto para guardar como nota.'); return; }
  addNote(txt);
  sel.removeAllRanges();
  showToast('Nota guardada âœ“');
});

function addNote(text) {
  const note = { id: Date.now(), text, date: new Date().toLocaleString('es-ES') };
  notes.unshift(note);
  saveNotes();
  renderNotes();
}

function saveNotes() {
  localStorage.setItem('stoica_notes', JSON.stringify(notes));
}

function renderNotes() {
  const c = $('notesContainer');
  $('emptyNotes').style.display = notes.length ? 'none' : 'block';
  // Remove existing cards
  c.querySelectorAll('.note-card').forEach(el => el.remove());
  notes.forEach(note => {
    const card = document.createElement('div');
    card.className = 'note-card';
    card.dataset.id = note.id;
    card.innerHTML = `
      <div class="note-meta">${note.date}</div>
      <div class="note-text">${escapeHtml(note.text)}</div>
      <div class="note-actions">
        <button class="btn ghost" onclick="editNote(${note.id})">âœï¸ Editar</button>
        <button class="btn ghost" onclick="deleteNote(${note.id})">ğŸ—‘ Eliminar</button>
        <button class="btn ghost" onclick="speakText('${escapeHtml(note.text).replace(/'/g,"\\'")}')">ğŸ”Š Leer</button>
      </div>`;
    c.appendChild(card);
  });
}

window.editNote = function(id) {
  const note = notes.find(n => n.id === id);
  if (!note) return;
  const card = document.querySelector(`.note-card[data-id="${id}"]`);
  const ta = document.createElement('textarea');
  ta.className = 'note-textarea';
  ta.value = note.text;
  const txt = card.querySelector('.note-text');
  txt.replaceWith(ta);
  card.querySelector('.note-actions').innerHTML = `
    <button class="btn" onclick="saveEditNote(${id})">ğŸ’¾ Guardar</button>
    <button class="btn ghost" onclick="renderNotes()">Cancelar</button>`;
};

window.saveEditNote = function(id) {
  const card = document.querySelector(`.note-card[data-id="${id}"]`);
  const ta = card.querySelector('textarea');
  const note = notes.find(n => n.id === id);
  if (note && ta) { note.text = ta.value; saveNotes(); renderNotes(); showToast('Nota actualizada âœ“'); }
};

window.deleteNote = function(id) {
  notes = notes.filter(n => n.id !== id);
  saveNotes();
  renderNotes();
  showToast('Nota eliminada');
};

$('clearNotes').addEventListener('click', () => {
  if (confirm('Â¿Eliminar todas las notas?')) { notes = []; saveNotes(); renderNotes(); }
});

$('exportNotes').addEventListener('click', () => {
  const txt = notes.map(n => `[${n.date}]\n${n.text}`).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n');
  downloadText(txt, 'stoica-notas.txt');
});

// Init notes
renderNotes();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICES / TTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadVoices() {
  voices = synth.getVoices();
  voiceSel.innerHTML = '';
  voices.forEach((v, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${v.name} (${v.lang})`;
    if (v.lang.startsWith('es')) opt.selected = true;
    voiceSel.appendChild(opt);
  });
}
loadVoices();
if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;

// Sliders
rateSlider.addEventListener('input',  () => { rateVal.textContent  = parseFloat(rateSlider.value).toFixed(1);  $('fcSpeedLbl').textContent = parseFloat(rateSlider.value).toFixed(1)+'x'; });
pitchSlider.addEventListener('input', () => { pitchVal.textContent = parseFloat(pitchSlider.value).toFixed(1); });
volSlider.addEventListener('input',   () => { volVal.textContent   = Math.round(parseFloat(volSlider.value)*100); });

// â”€â”€ SPEECH ENGINE â”€â”€
function buildUtterance(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.rate   = parseFloat(rateSlider.value);
  u.pitch  = parseFloat(pitchSlider.value);
  u.volume = parseFloat(volSlider.value);
  const vi = parseInt(voiceSel.value);
  if (voices[vi]) u.voice = voices[vi];

  u.onstart = () => {
    isPlaying = true; isPaused = false;
    playBtn.textContent = 'â¸';
    $('fc-play').textContent = 'â¸';
    statusPill.textContent = 'â–¶ Reproduciendo';
    statusPill.className = 'status-pill playing';
  };
  u.onpause = () => {
    isPaused = true;
    playBtn.textContent = 'â–¶';
    $('fc-play').textContent = 'â–¶';
    statusPill.textContent = 'â¸ Pausado';
    statusPill.className = 'status-pill paused';
  };
  u.onresume = () => {
    isPaused = false;
    playBtn.textContent = 'â¸';
    $('fc-play').textContent = 'â¸';
    statusPill.textContent = 'â–¶ Reproduciendo';
    statusPill.className = 'status-pill playing';
  };
  u.onend = u.onerror = () => {
    isPlaying = false; isPaused = false; utterance = null;
    playBtn.textContent = 'â–¶';
    $('fc-play').textContent = 'â–¶';
    statusPill.textContent = 'Detenido';
    statusPill.className = 'status-pill';
    clearWordHighlights();
  };

  // Word boundary for synchronized highlighting
  u.onboundary = (e) => {
    if (e.name !== 'word') return;
    const charIdx = e.charIndex;
    highlightWordAtChar(charIdx, text);
  };

  return u;
}

let charToWordMap = [];
function buildCharMap(text) {
  charToWordMap = [];
  let wIdx = 0;
  let inWord = false;
  let wordStart = 0;
  for (let i = 0; i <= text.length; i++) {
    const ch = i < text.length ? text[i] : ' ';
    const isWS = /\s/.test(ch);
    if (!isWS && !inWord) { inWord = true; wordStart = i; }
    if (isWS && inWord) { inWord = false; wIdx++; }
    if (inWord) charToWordMap[i] = wIdx;
  }
}

function highlightWordAtChar(charIdx, text) {
  if (!wordSpans.length) return;
  // Count word index at charIdx
  const textBefore = text.substring(0, charIdx);
  const words = textBefore.split(/\s+/);
  const wIdx = Math.max(0, words.length - 1);
  if (wIdx === currentWordIdx) return;
  if (currentWordIdx < wordSpans.length) wordSpans[currentWordIdx].classList.replace('reading','done');
  currentWordIdx = wIdx;
  if (currentWordIdx < wordSpans.length) {
    const span = wordSpans[currentWordIdx];
    span.classList.add('reading');
    // scroll into view
    span.scrollIntoView({ behavior: 'smooth', block: 'center' });
    // update progress
    const pct = Math.round((currentWordIdx / wordSpans.length) * 100);
    setProgress(pct);
  }
}

function clearWordHighlights() {
  wordSpans.forEach(s => { s.classList.remove('reading','done'); });
  currentWordIdx = 0;
  setProgress(0);
}

window.speakText = function(text) {
  if (!text) return;
  synth.cancel();
  utterance = buildUtterance(text);
  synth.speak(utterance);
};

function stopSpeech() {
  synth.cancel();
  isPlaying = false; isPaused = false; utterance = null;
  playBtn.textContent = 'â–¶';
  $('fc-play').textContent = 'â–¶';
  statusPill.textContent = 'Detenido';
  statusPill.className = 'status-pill';
  clearWordHighlights();
}

// Play/Pause
function togglePlay() {
  if (!isPlaying && !isPaused) {
    const txt = fullText || display.textContent;
    if (!txt.trim()) { showToast('Carga texto primero.'); return; }
    speakText(txt);
  } else if (isPlaying && !isPaused) {
    synth.pause();
  } else if (isPaused) {
    synth.resume();
  }
}
playBtn.addEventListener('click', togglePlay);
$('fc-play').addEventListener('click', togglePlay);
stopBtn.addEventListener('click', stopSpeech);
$('fc-stop').addEventListener('click', stopSpeech);

// Read selection
readSelBtn.addEventListener('click', () => {
  const sel = window.getSelection();
  const txt = sel && !sel.isCollapsed ? sel.toString().trim() : null;
  if (txt) speakText(txt);
  else showToast('Selecciona texto primero.');
});

// Float speed
$('fc-slower').addEventListener('click', () => {
  let v = Math.max(.5, parseFloat(rateSlider.value) - .1);
  rateSlider.value = v;
  rateVal.textContent = v.toFixed(1);
  $('fcSpeedLbl').textContent = v.toFixed(1)+'x';
});
$('fc-faster').addEventListener('click', () => {
  let v = Math.min(2.5, parseFloat(rateSlider.value) + .1);
  rateSlider.value = v;
  rateVal.textContent = v.toFixed(1);
  $('fcSpeedLbl').textContent = v.toFixed(1)+'x';
});

// â”€â”€ DRAG FLOAT â”€â”€
(function() {
  const el = $('floatCtrl');
  const handle = $('dragHandle');
  let ox=0,oy=0,ex=0,ey=0;
  handle.addEventListener('mousedown', e => {
    ex = el.offsetLeft; ey = el.offsetTop;
    ox = e.clientX; oy = e.clientY;
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', () => document.removeEventListener('mousemove', onDrag));
  });
  function onDrag(e) {
    el.style.right = 'auto';
    el.style.bottom = 'auto';
    el.style.left = (ex + e.clientX - ox) + 'px';
    el.style.top  = (ey + e.clientY - oy) + 'px';
  }
})();

// â”€â”€ PROGRESS BAR â”€â”€
function setProgress(pct) {
  readProgress = pct;
  progressFill.style.width = pct + '%';
  posInfo.textContent = pct + '%';
}
$('progressTrack').addEventListener('click', e => {
  const rect = $('progressTrack').getBoundingClientRect();
  const pct  = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
  const wIdx = Math.floor((pct / 100) * wordSpans.length);
  // Jump reading to that word
  stopSpeech();
  if (!fullText) return;
  const words = fullText.split(/\s+/);
  const remaining = words.slice(wIdx).join(' ');
  setTimeout(() => {
    currentWordIdx = wIdx;
    speakText(remaining);
    if (wordSpans[wIdx]) wordSpans[wIdx].scrollIntoView({ behavior:'smooth', block:'center' });
  }, 100);
  setProgress(Math.round(pct));
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUDE API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callClaude(prompt, maxTokens=2000) {
  const response = await fetch(CLAUDE_API, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: CLAUDE_MODEL,
      max_tokens: maxTokens,
      messages: [{ role: 'user', content: prompt }]
    })
  });
  const data = await response.json();
  if (data.error) throw new Error(data.error.message || 'Error de API');
  return data.content.map(b => b.text || '').join('');
}

function getTextForAI() {
  const t = fullText.trim();
  if (!t) { showToast('Carga texto primero.'); return null; }
  // Limit to ~8000 chars for API
  return t.length > 8000 ? t.substring(0, 8000) + '...' : t;
}

// â”€â”€ SUMMARY â”€â”€
$('genSummary').addEventListener('click', async () => {
  const text = getTextForAI(); if (!text) return;
  const level = $('summaryLevel').value;
  const niveles = { breve: '3-5 oraciones concisas', intermedio: '1-2 pÃ¡rrafos completos', detallado: 'anÃ¡lisis detallado con ideas principales, secundarias y conclusiÃ³n' };
  $('summaryOutput').textContent = 'â³ Generando resumenâ€¦';
  setLoading(30);
  try {
    const res = await callClaude(
      `Genera un resumen en espaÃ±ol del siguiente texto. Nivel: ${niveles[level]}.\n\nTexto:\n${text}`,
      1000
    );
    $('summaryOutput').textContent = res;
    setLoading(100);
    showToast('Resumen generado âœ“');
  } catch(e) {
    $('summaryOutput').textContent = 'âŒ Error: ' + e.message;
    setLoading(100);
  }
});

$('copySummary').addEventListener('click', () => {
  navigator.clipboard.writeText($('summaryOutput').textContent).then(() => showToast('Resumen copiado âœ“'));
});

// â”€â”€ QUESTIONS â”€â”€
$('genQuestions').addEventListener('click', async () => {
  const text = getTextForAI(); if (!text) return;
  const type  = $('qType').value;
  const level = $('qLevel').value;
  const count = parseInt($('qCount').value) || 10;

  const typeMap  = { mixtas:'variadas (abiertas, cerradas y de opciÃ³n mÃºltiple)', abiertas:'abiertas', cerradas:'cerradas (SÃ­/No)', opcion_multiple:'de opciÃ³n mÃºltiple con 4 alternativas (A, B, C, D)' };
  const levelMap = { literal:'literal (informaciÃ³n explÃ­cita)', inferencial:'inferencial (deducciones)', critico:'crÃ­tico-valorativo (juicios y valoraciones)', analogico:'analÃ³gico-intertextual (comparaciones y conexiones)' };

  $('questionsOutput').textContent = 'â³ Generando preguntasâ€¦';
  setLoading(30);
  try {
    const res = await callClaude(
      `Genera exactamente ${count} preguntas en espaÃ±ol sobre el siguiente texto.
Tipo de preguntas: ${typeMap[type]}.
Nivel de lectura: ${levelMap[level]}.

Para cada pregunta incluye:
- NÃºmero de pregunta
- La pregunta
- Respuesta correcta
- JustificaciÃ³n breve (por quÃ© esa es la respuesta)
${type === 'opcion_multiple' ? '- Las 4 opciones A, B, C, D' : ''}

Formato:
PREGUNTA 1:
[pregunta]
${type === 'opcion_multiple' ? 'A) ...\nB) ...\nC) ...\nD) ...\n' : ''}RESPUESTA: [respuesta]
JUSTIFICACIÃ“N: [justificaciÃ³n]

Texto:\n${text}`,
      2000
    );
    $('questionsOutput').textContent = res;
    setLoading(100);
    showToast('Preguntas generadas âœ“');
  } catch(e) {
    $('questionsOutput').textContent = 'âŒ Error: ' + e.message;
    setLoading(100);
  }
});

$('copyQuestions').addEventListener('click', () => {
  navigator.clipboard.writeText($('questionsOutput').textContent).then(() => showToast('Preguntas copiadas âœ“'));
});

// â”€â”€ MINDMAP â”€â”€
$('genMindmap').addEventListener('click', async () => {
  const text = getTextForAI(); if (!text) return;
  $('conceptMapOutput').innerHTML = '<p style="font-family:var(--font-mono);font-size:.78rem;color:var(--muted);">â³ Generando mapaâ€¦</p>';
  $('keyIdeasOutput').textContent = 'â³ Analizando ideas claveâ€¦';
  setLoading(30);
  try {
    const res = await callClaude(
      `Analiza el texto y responde SOLO en JSON con esta estructura exacta:
{
  "central": "tema central en 3-5 palabras",
  "ramas": [
    { "nombre": "rama 1", "conceptos": ["concepto a", "concepto b", "concepto c"] },
    { "nombre": "rama 2", "conceptos": ["concepto d", "concepto e"] }
  ],
  "ideas_clave": ["idea 1", "idea 2", "idea 3", "idea 4", "idea 5"]
}
Genera mÃ¡ximo 6 ramas con 3-5 conceptos cada una. Solo JSON, sin texto extra.

Texto:\n${text}`,
      1500
    );
    setLoading(80);
    let parsed;
    try {
      const clean = res.replace(/```json|```/g,'').trim();
      parsed = JSON.parse(clean);
    } catch(e2) {
      throw new Error('No se pudo parsear el mapa. Intenta de nuevo.');
    }
    renderMindmap(parsed);
    setLoading(100);
    showToast('Mapa generado âœ“');
  } catch(e) {
    $('conceptMapOutput').innerHTML = '<p style="color:var(--accent);">âŒ ' + e.message + '</p>';
    setLoading(100);
  }
});

function renderMindmap(data) {
  const c = $('conceptMapOutput');
  let html = `<div style="width:100%;display:flex;flex-direction:column;gap:16px;">`;
  // Central
  html += `<div style="text-align:center;"><span class="concept-node concept-central">${escapeHtml(data.central)}</span></div>`;
  // Branches
  html += `<div style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;">`;
  (data.ramas || []).forEach((rama, i) => {
    const colors = ['var(--accent)','var(--accent2)','var(--accent3)','var(--gold)'];
    const col = colors[i % colors.length];
    html += `<div style="background:var(--surface2);border:1px solid var(--border);border-top:3px solid ${col};border-radius:var(--radius);padding:12px;min-width:160px;max-width:220px;">
      <div style="font-family:var(--font-mono);font-size:.72rem;color:${col};font-weight:500;margin-bottom:8px;">${escapeHtml(rama.nombre)}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;">`;
    (rama.conceptos || []).forEach(c2 => {
      html += `<span class="concept-node" style="font-size:.7rem;padding:4px 8px;">${escapeHtml(c2)}</span>`;
    });
    html += `</div></div>`;
  });
  html += `</div></div>`;
  c.innerHTML = html;
  // Key ideas
  $('keyIdeasOutput').textContent = (data.ideas_clave || []).map((idea, i) => `${i+1}. ${idea}`).join('\n');
}

$('exportMindmap').addEventListener('click', () => {
  const el = $('conceptMapOutput');
  showToast('Copia la pantalla con Win+Shift+S para guardar el mapa.');
});

// â”€â”€ TRANSLATION â”€â”€
async function translateText(text, dest, src='auto') {
  const langs = { es:'espaÃ±ol', en:'inglÃ©s', fr:'francÃ©s', de:'alemÃ¡n', pt:'portuguÃ©s', it:'italiano', zh:'chino', ja:'japonÃ©s', ar:'Ã¡rabe', ru:'ruso', auto:'idioma detectado' };
  const res = await callClaude(
    `Traduce el siguiente texto ${src !== 'auto' ? 'del ' + langs[src] : ''} al ${langs[dest]}. Responde SOLO con la traducciÃ³n, sin explicaciones adicionales.\n\nTexto:\n${text}`,
    2000
  );
  return res;
}

$('transAll').addEventListener('click', async () => {
  const text = fullText.trim();
  if (!text) { showToast('Carga texto primero.'); return; }
  const dest = $('transDest').value;
  const src  = $('transSource').value;
  $('transOriginal').textContent = text.length > 3000 ? text.substring(0,3000)+'...' : text;
  $('transOutput').textContent = 'â³ Traduciendoâ€¦';
  setLoading(30);
  try {
    const truncated = text.length > 5000 ? text.substring(0,5000) : text;
    const res = await translateText(truncated, dest, src);
    $('transOutput').textContent = res;
    setLoading(100);
    showToast('TraducciÃ³n completada âœ“');
  } catch(e) {
    $('transOutput').textContent = 'âŒ Error: ' + e.message;
    setLoading(100);
  }
});

$('transSel').addEventListener('click', async () => {
  const sel = window.getSelection();
  const txt = sel && !sel.isCollapsed ? sel.toString().trim() : null;
  if (!txt) { showToast('Selecciona texto primero.'); return; }
  const dest = $('transDest').value;
  $('transOriginal').textContent = txt;
  $('transOutput').textContent = 'â³ Traduciendoâ€¦';
  setLoading(30);
  try {
    const res = await translateText(txt, dest);
    $('transOutput').textContent = res;
    setLoading(100);
    showToast('TraducciÃ³n completada âœ“');
  } catch(e) {
    $('transOutput').textContent = 'âŒ Error: ' + e.message;
    setLoading(100);
  }
});

$('copyTrans').addEventListener('click', () => {
  navigator.clipboard.writeText($('transOutput').textContent).then(() => showToast('TraducciÃ³n copiada âœ“'));
});

// Quick translate from sidebar
$('quickTranslate').addEventListener('click', async () => {
  const text = fullText.trim(); if (!text) { showToast('Carga texto primero.'); return; }
  const dest = $('sideTransDest').value;
  setLoading(20);
  try {
    const truncated = text.length > 5000 ? text.substring(0,5000) : text;
    showToast('â³ Traduciendoâ€¦', 5000);
    const res = await translateText(truncated, dest);
    // Switch to translate tab and show
    document.querySelector('[data-tab="translate"]').click();
    $('transOriginal').textContent = truncated;
    $('transOutput').textContent = res;
    setLoading(100);
    showToast('TraducciÃ³n completada âœ“');
  } catch(e) {
    showToast('Error: ' + e.message);
    setLoading(100);
  }
});

// â”€â”€ EXPORT AUDIO (via Web Speech + MediaRecorder if available) â”€â”€
$('exportAudio').addEventListener('click', () => {
  const text = fullText.trim() || display.textContent.trim();
  if (!text) { showToast('Carga texto primero.'); return; }

  // Check if MediaRecorder + AudioContext are available
  if (!window.MediaRecorder || !window.AudioContext) {
    showToast('Tu navegador no soporta grabaciÃ³n directa. Usa una herramienta de grabaciÃ³n del sistema.');
    return;
  }

  showToast('â³ Inicia la lectura para grabar el audio...', 4000);
  // We use the Web Speech API + MediaRecorder on the audio output
  // This is a best-effort approach since Web Speech doesn't give raw audio
  // Instead, we'll guide user to use system recording
  const name = ($('audioName').value.trim() || 'stoica-audio').replace(/[^a-zA-Z0-9-_]/g,'_');
  
  // Attempt AudioContext recording (Chrome)
  try {
    const ctx = new AudioContext();
    const dest = ctx.createMediaStreamDestination();
    const chunks = [];
    const mr = new MediaRecorder(dest.stream);
    mr.ondataavailable = e => chunks.push(e.data);
    mr.onstop = () => {
      const blob = new Blob(chunks, { type:'audio/webm' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = name + '.webm';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Audio exportado âœ“ (formato WebM)');
    };
    mr.start();
    speakText(text);
    // Stop recording when speech ends
    const check = setInterval(() => {
      if (!synth.speaking) { mr.stop(); ctx.close(); clearInterval(check); }
    }, 500);
  } catch(e) {
    showToast('ExportaciÃ³n de audio no disponible en este navegador.');
  }
});

// â”€â”€ UTILS â”€â”€
function downloadText(text, filename) {
  const blob = new Blob([text], { type:'text/plain;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€ KEYBOARD â”€â”€
document.addEventListener('keydown', e => {
  const tag = e.target.tagName;
  if (tag==='TEXTAREA'||tag==='INPUT') return;
  if (e.code==='Space') { e.preventDefault(); togglePlay(); }
  if (e.code==='Escape') stopSpeech();
});

// â”€â”€ SERVICE WORKER â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}

// â”€â”€ INIT â”€â”€
console.log('%cStoica Reader v2 âœ“', 'color:#9b2335;font-family:monospace;font-size:14px;font-weight:bold;');
</script>
</body>
</html>

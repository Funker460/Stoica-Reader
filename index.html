<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Stoica Reader v4</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#0d0d12"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER v4 â€” 100% GRATUITO
   Sin APIs de pago. Todo en el navegador.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:      #0d0d12;
  --surf:    #13131a;
  --surf2:   #1a1a24;
  --surf3:   #22222f;
  --bdr:     #2a2a3d;
  --bdr2:    #363650;
  --txt:     #e8e6f0;
  --muted:   #6b6880;
  --acc:     #c45fff;
  --acc2:    #4fa8ff;
  --acc3:    #2ded8a;
  --gold:    #ffb84d;
  --warm:    #ff6b6b;
  --hi:      rgba(196,95,255,.12);
  --hi-now:  #c45fff;
  --btn:     #e8e6f0;
  --btnT:    #0d0d12;
  --shad:    rgba(0,0,0,.6);
  --r: 7px; --r2: 13px; --r3: 20px;
  --fs: 18px; --lh: 1.9;
  --fBody: 'DM Serif Display', Georgia, serif;
  --fSans: 'Outfit', sans-serif;
  --fMono: 'DM Mono', monospace;
  --grad: linear-gradient(135deg, var(--acc), var(--acc2));
}
[data-theme=light] {
  --bg:#f4f2f9; --surf:#ebe8f5; --surf2:#e0ddf0;
  --surf3:#d5d1e8; --bdr:#c5c0db; --bdr2:#b0aacf;
  --txt:#1a1625; --muted:#7a759a;
  --shad:rgba(26,22,37,.15); --btn:#1a1625; --btnT:#f4f2f9;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{
  font-family:var(--fSans);background:var(--bg);color:var(--txt);
  display:flex;flex-direction:column;
  transition:background .3s,color .3s;
}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:4px}

/* â”€â”€ HEADER â”€â”€ */
header {
  height:48px;background:var(--surf);
  border-bottom:1px solid var(--bdr);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;flex-shrink:0;
  box-shadow:0 1px 20px var(--shad);z-index:60;
}
.logo {
  font-family:var(--fMono);font-size:.78rem;font-weight:500;
  letter-spacing:.22em;
  background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  display:flex;align-items:center;gap:10px;
}
.logo .badge {
  font-size:.5rem;background:var(--surf3);
  -webkit-text-fill-color:var(--acc3);color:var(--acc3);
  padding:2px 7px;border-radius:10px;letter-spacing:.08em;font-weight:400;
  border:1px solid var(--bdr2);
}
.hdr-r{display:flex;gap:4px;align-items:center}

/* â”€â”€ TABS â”€â”€ */
.tabs {
  display:flex;background:var(--surf);border-bottom:1px solid var(--bdr);
  padding:0 12px;flex-shrink:0;overflow-x:auto;gap:1px;
}
.tabs::-webkit-scrollbar{height:0}
.tab {
  padding:7px 12px;font-family:var(--fMono);font-size:.62rem;
  letter-spacing:.08em;border:none;background:none;
  color:var(--muted);cursor:pointer;white-space:nowrap;
  border-bottom:2px solid transparent;
  transition:color .15s,border-color .15s;
  position:relative;
}
.tab.on{color:var(--acc);border-bottom-color:var(--acc)}
.tab:hover:not(.on){color:var(--txt)}

/* â”€â”€ TOOLBAR â”€â”€ */
.bar {
  display:flex;flex-wrap:wrap;gap:4px;padding:6px 14px;
  background:var(--surf);border-bottom:1px solid var(--bdr);
  align-items:center;flex-shrink:0;
}
.vline{width:1px;height:20px;background:var(--bdr2);margin:0 2px;flex-shrink:0}

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display:inline-flex;align-items:center;gap:4px;
  padding:5px 11px;border-radius:var(--r);
  border:1px solid var(--bdr2);background:var(--surf3);color:var(--txt);
  font-family:var(--fMono);font-size:.62rem;letter-spacing:.04em;
  cursor:pointer;white-space:nowrap;
  transition:all .15s;
}
.btn:hover{background:var(--surf2);border-color:var(--muted)}
.btn:active{transform:scale(.97)}
.btn.g  {background:transparent;color:var(--muted);border-color:var(--bdr)}
.btn.g:hover{background:var(--surf2);color:var(--txt)}
.btn.acc{background:var(--acc);color:#fff;border-color:var(--acc)}
.btn.acc:hover{filter:brightness(1.12)}
.btn.b  {background:var(--acc2);color:#fff;border-color:var(--acc2)}
.btn.gr {background:var(--acc3);color:#111;border-color:var(--acc3)}
.btn.go {background:var(--gold);color:#111;border-color:var(--gold)}
.btn.red{background:var(--warm);color:#fff;border-color:var(--warm)}
.ibtn {
  background:none;border:1px solid var(--bdr);border-radius:var(--r);
  color:var(--muted);cursor:pointer;width:30px;height:30px;
  display:flex;align-items:center;justify-content:center;font-size:.8rem;
  transition:all .15s;flex-shrink:0;
}
.ibtn:hover{background:var(--surf2);color:var(--txt);border-color:var(--bdr2)}

/* â”€â”€ STATS BAR â”€â”€ */
.stats {
  display:flex;gap:12px;flex-wrap:wrap;padding:3px 14px;
  background:var(--bg);border-bottom:1px solid var(--bdr);
  font-family:var(--fMono);font-size:.58rem;color:var(--muted);
  align-items:center;flex-shrink:0;
}
.stats b{color:var(--txt);font-weight:500}
.pill {
  font-family:var(--fMono);font-size:.56rem;padding:2px 8px;
  border-radius:20px;background:var(--surf2);color:var(--muted);
  border:1px solid var(--bdr);
}
.pill.play{background:rgba(196,95,255,.2);color:var(--acc);border-color:var(--acc);animation:blink 1.4s infinite}
.pill.pause{background:rgba(79,168,255,.15);color:var(--acc2);border-color:var(--acc2)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.55}}

/* â”€â”€ PROGRESS BAR â”€â”€ */
.pbwrap{
  padding:0 14px 5px;background:var(--bg);
  border-bottom:1px solid var(--bdr);flex-shrink:0;
}
.pbtrack{
  width:100%;height:4px;background:var(--surf2);
  border-radius:4px;cursor:pointer;overflow:visible;
  position:relative;
}
.pbtrack:hover .pbfill::after{opacity:1}
.pbfill{
  height:100%;width:0%;border-radius:4px;pointer-events:none;
  background:var(--grad);
  transition:width .12s;position:relative;
}
.pbfill::after{
  content:'';position:absolute;right:-5px;top:-3px;
  width:10px;height:10px;border-radius:50%;
  background:var(--acc);opacity:0;transition:opacity .15s;
}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:flex;flex:1;overflow:hidden;min-height:0}

/* â”€â”€ READER PANE â”€â”€ */
.rpane{flex:1;overflow-y:auto;padding:48px 88px;min-width:0;scroll-behavior:smooth}
@media(max-width:680px){.rpane{padding:24px 18px}}
#textDisplay{
  font-size:var(--fs);line-height:var(--lh);
  white-space:pre-wrap;word-break:break-word;
  outline:none;max-width:760px;margin:0 auto;
}
#textDisplay.mt::before{
  content:'Carga un archivo o pega tu texto aquÃ­â€¦';
  color:var(--muted);font-style:italic;pointer-events:none;
}
.w{display:inline}
.w.now{
  background:var(--hi-now);color:#fff;border-radius:3px;padding:0 2px;
  box-shadow:0 0 16px rgba(196,95,255,.4);
}
.w.done{background:var(--hi);border-radius:2px}
mark.hl{background:rgba(255,184,77,.28);color:var(--txt);border-radius:2px;padding:0 1px;border-bottom:2px solid var(--gold);}
mark.find{background:rgba(255,184,77,.35);color:var(--txt);border-radius:2px}
mark.find.cur{background:var(--warm);color:#fff}

/* â”€â”€ SIDE PANEL â”€â”€ */
.side{
  width:290px;min-width:270px;
  border-left:1px solid var(--bdr);background:var(--surf);
  display:flex;flex-direction:column;overflow:hidden;
  flex-shrink:0;transition:width .22s,min-width .22s;
}
.side.off{width:0;min-width:0;border:none}
.sinner{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:10px}
.card{
  background:var(--bg);border:1px solid var(--bdr);
  border-radius:var(--r2);padding:12px;
  display:flex;flex-direction:column;gap:7px;
}
.card h3{font-family:var(--fMono);font-size:.58rem;letter-spacing:.12em;color:var(--muted);text-transform:uppercase}
.sl-lbl{font-family:var(--fMono);font-size:.58rem;color:var(--muted);display:flex;justify-content:space-between}
input[type=range]{width:100%;accent-color:var(--acc);cursor:pointer;height:3px}
select,input[type=text]{
  border:1px solid var(--bdr);border-radius:var(--r);
  background:var(--surf2);color:var(--txt);
  font-family:var(--fMono);font-size:.62rem;padding:5px 8px;
}
select{width:100%;cursor:pointer}

/* â”€â”€ TTS BAR â”€â”€ */
.ttsbar{
  background:var(--surf);border-top:1px solid var(--bdr);
  padding:9px 14px;display:flex;align-items:center;gap:8px;
  flex-shrink:0;box-shadow:0 -4px 20px var(--shad);z-index:40;
}
.pbig{
  width:42px;height:42px;border-radius:50%;border:none;
  background:var(--grad);color:#fff;font-size:1rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:transform .15s,box-shadow .15s;flex-shrink:0;
  box-shadow:0 4px 16px rgba(196,95,255,.35);
}
.pbig:hover{transform:scale(1.1)}
.pbig.b2{background:linear-gradient(135deg,var(--acc2),var(--acc3));box-shadow:0 4px 14px rgba(79,168,255,.3)}
.hint{font-family:var(--fMono);font-size:.58rem;color:var(--muted);margin-left:auto}

/* â”€â”€ FLOAT â”€â”€ */
#fc{
  position:fixed;bottom:90px;right:14px;
  background:var(--surf2);border:1px solid var(--bdr2);
  border-radius:var(--r2);padding:10px;
  display:flex;flex-direction:column;gap:6px;align-items:center;
  box-shadow:0 8px 32px var(--shad);z-index:300;
  cursor:move;user-select:none;
  transition:opacity .2s,transform .2s;
}
#fc.off{opacity:0;pointer-events:none;transform:scale(.82) translateY(8px)}
.fcdrg{font-family:var(--fMono);font-size:.52rem;color:var(--muted);letter-spacing:.08em;cursor:grab}
.fcspd{font-family:var(--fMono);font-size:.62rem;color:var(--muted);text-align:center}
.fcbtn{
  width:34px;height:34px;border-radius:50%;border:1px solid var(--bdr2);
  background:var(--surf3);color:var(--txt);font-size:.8rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:background .15s;
}
.fcbtn:hover{background:var(--surf2)}
.fcbtn.r{background:var(--grad);color:#fff;border:none;box-shadow:0 3px 10px rgba(196,95,255,.3)}

/* â”€â”€ OVERLAY â”€â”€ */
.ov{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);
  z-index:500;align-items:center;justify-content:center;
  backdrop-filter:blur(4px);
}
.ov.on{display:flex}
.modal{
  background:var(--surf);border:1px solid var(--bdr2);border-radius:var(--r2);
  padding:24px;width:min(600px,96vw);max-height:90vh;overflow-y:auto;
  box-shadow:0 24px 60px var(--shad);display:flex;flex-direction:column;gap:12px;
  animation:mIn .18s ease;
}
@keyframes mIn{from{opacity:0;transform:scale(.95) translateY(8px)}}
.modal h2{font-family:var(--fMono);font-size:.78rem;letter-spacing:.08em}
.modal textarea{
  border:1px solid var(--bdr);border-radius:var(--r);
  background:var(--bg);color:var(--txt);font-family:var(--fSans);font-size:.95rem;
  padding:10px 12px;width:100%;min-height:200px;resize:vertical;
}
.mfooter{display:flex;gap:7px;justify-content:flex-end;flex-wrap:wrap}

/* â”€â”€ TAB PANES â”€â”€ */
.tpane{display:none;flex:1;overflow:hidden;flex-direction:column}
.tpane.on{display:flex}
.pinner{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.phead{display:flex;gap:6px;flex-wrap:wrap;align-items:center;flex-shrink:0}
.phead h2{font-family:var(--fMono);font-size:.72rem;letter-spacing:.1em;margin-right:4px}

/* â”€â”€ OUTPUT â”€â”€ */
.out{
  background:var(--bg);border:1px solid var(--bdr);border-radius:var(--r);
  padding:16px;font-size:.9rem;line-height:1.75;
  white-space:pre-wrap;word-break:break-word;overflow-y:auto;flex:1;
  font-family:var(--fSans);
}
.out.mt{color:var(--muted);font-style:italic}

/* â”€â”€ INFO BOX â”€â”€ */
.infobox{
  font-family:var(--fMono);font-size:.6rem;color:var(--muted);
  background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r);
  padding:7px 11px;line-height:1.6;flex-shrink:0;
}
.infobox b{color:var(--acc3);}

/* â”€â”€ NOTES â”€â”€ */
.ncard{
  background:var(--bg);border:1px solid var(--bdr);border-radius:var(--r);
  padding:12px;display:flex;flex-direction:column;gap:6px;
  animation:fi .18s ease;
}
@keyframes fi{from{opacity:0;transform:translateY(4px)}}
.nmeta{font-family:var(--fMono);font-size:.58rem;color:var(--muted)}
.nbody{font-size:.87rem;line-height:1.65;white-space:pre-wrap;font-family:var(--fSans)}
.nacts{display:flex;gap:5px;flex-wrap:wrap}
.nta{
  border:1px solid var(--bdr);background:var(--surf2);color:var(--txt);
  font-family:var(--fSans);font-size:.87rem;padding:6px 8px;
  border-radius:4px;width:100%;resize:none;min-height:60px;
}

/* â”€â”€ TRANSLATE â”€â”€ */
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1;min-height:0}
@media(max-width:580px){.tgrid{grid-template-columns:1fr}}
.tcol{display:flex;flex-direction:column;gap:5px;min-height:0}
.tlbl{font-family:var(--fMono);font-size:.58rem;color:var(--muted)}

/* â”€â”€ MAP â”€â”€ */
.mapwrap{
  background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r2);
  padding:18px;display:flex;flex-wrap:wrap;gap:10px;
  min-height:160px;align-items:flex-start;align-content:flex-start;
}
.mnode{
  background:var(--surf2);border:1px solid var(--bdr2);border-radius:var(--r);
  padding:6px 11px;font-family:var(--fMono);font-size:.62rem;cursor:pointer;
  transition:all .15s;
}
.mnode:hover{background:var(--acc);color:#fff;border-color:var(--acc)}
.mnode.ctr{
  background:linear-gradient(135deg,var(--acc),var(--acc2));
  color:#fff;border:none;font-weight:500;font-size:.72rem;padding:8px 16px;
  box-shadow:0 4px 16px rgba(196,95,255,.35);
}
.branch{
  background:var(--surf2);border:1px solid var(--bdr);
  border-top-width:3px;border-radius:var(--r);
  padding:10px;min-width:150px;max-width:220px;flex:1;
}
.btitle{font-family:var(--fMono);font-size:.6rem;font-weight:500;margin-bottom:6px}
.bchips{display:flex;flex-wrap:wrap;gap:4px}

/* â”€â”€ MAP ENHANCED â”€â”€ */
.map-section{display:flex;flex-direction:column;gap:14px}
.map-header{
  background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r2);
  padding:14px 18px;text-align:center;
}
.map-central{
  display:inline-block;font-family:var(--fMono);font-size:.85rem;font-weight:500;
  background:var(--grad);color:#fff;padding:10px 24px;border-radius:var(--r3);
  box-shadow:0 4px 20px rgba(196,95,255,.4);letter-spacing:.06em;
}
.map-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
.map-card{
  background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r2);
  overflow:hidden;
}
.map-card-head{
  padding:8px 12px;font-family:var(--fMono);font-size:.62rem;font-weight:500;
  letter-spacing:.06em;
}
.map-card-body{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
.map-chip{
  background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);
  padding:4px 10px;font-family:var(--fMono);font-size:.58rem;
  cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;
}
.map-chip:hover{border-color:var(--acc);color:var(--acc)}
.map-chip::before{content:'â†’';color:var(--muted);font-size:.5rem}
.compare-table{width:100%;border-collapse:collapse;font-size:.82rem;font-family:var(--fSans)}
.compare-table th{
  background:var(--surf2);border:1px solid var(--bdr);
  padding:8px 12px;font-family:var(--fMono);font-size:.62rem;
  letter-spacing:.06em;color:var(--muted);text-align:left;
}
.compare-table td{border:1px solid var(--bdr);padding:7px 12px;line-height:1.5}
.compare-table tr:hover td{background:var(--surf)}

/* â”€â”€ HIERARCHY â”€â”€ */
.hier-list{list-style:none;padding:0}
.hier-item{
  border-left:2px solid var(--bdr2);margin-left:12px;padding-left:12px;
  margin-bottom:4px;
}
.hier-item:first-child{margin-left:0;border:none}
.hier-label{
  font-family:var(--fMono);font-size:.65rem;
  background:var(--surf2);border:1px solid var(--bdr);
  border-radius:var(--r);padding:4px 10px;display:inline-block;
  margin-bottom:4px;cursor:pointer;transition:all .15s;
}
.hier-label:hover{color:var(--acc);border-color:var(--acc)}
.hier-label.level-0{background:var(--acc);color:#fff;border-color:var(--acc);font-weight:500;font-size:.72rem}
.hier-label.level-1{border-left:3px solid var(--acc2);color:var(--acc2)}
.hier-label.level-2{border-left:3px solid var(--acc3);color:var(--acc3);font-size:.6rem}

/* â”€â”€ QUESTIONS â”€â”€ */
.qcard{
  background:var(--bg);border:1px solid var(--bdr);border-radius:var(--r);
  padding:13px;display:flex;flex-direction:column;gap:6px;
  transition:border-color .15s;
}
.qcard:hover{border-color:var(--bdr2)}
.qnum{font-family:var(--fMono);font-size:.58rem;color:var(--muted)}
.qtxt{font-size:.9rem;font-weight:500;line-height:1.5;font-family:var(--fSans)}
.qans{
  font-size:.84rem;padding-top:8px;border-top:1px solid var(--bdr);
  display:none;color:var(--txt);font-family:var(--fSans);line-height:1.65;
}
.qans.vis{display:block;animation:fi .2s ease}
.qjust{font-size:.78rem;color:var(--muted);margin-top:4px;font-style:italic}

/* â”€â”€ VOICES SECTION â”€â”€ */
.voice-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
.vcard{
  background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);
  padding:10px;display:flex;flex-direction:column;gap:5px;
  cursor:pointer;transition:all .15s;
}
.vcard:hover,.vcard.sel{border-color:var(--acc);background:var(--surf3)}
.vcard.sel{box-shadow:0 0 0 2px rgba(196,95,255,.3)}
.vname{font-family:var(--fMono);font-size:.68rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.vlang{font-family:var(--fMono);font-size:.56rem;color:var(--muted)}
.vtag{
  font-family:var(--fMono);font-size:.52rem;padding:2px 6px;border-radius:10px;
  background:var(--surf);border:1px solid var(--bdr);color:var(--muted);
  display:inline-block;margin-top:2px;
}
.vtag.es{color:var(--gold);border-color:var(--gold);background:rgba(255,184,77,.1)}
.vtag.en{color:var(--acc2);border-color:var(--acc2);background:rgba(79,168,255,.1)}
.voice-filter{display:flex;gap:6px;flex-wrap:wrap;align-items:center;flex-shrink:0}

/* â”€â”€ LOADING â”€â”€ */
.lbar{
  position:fixed;top:0;left:0;height:2px;
  background:var(--grad);
  z-index:999;width:0%;transition:width .25s;pointer-events:none;
}
.toast{
  position:fixed;bottom:74px;left:50%;transform:translateX(-50%);
  background:var(--surf2);color:var(--txt);
  border:1px solid var(--bdr2);
  padding:8px 16px;border-radius:var(--r3);
  font-family:var(--fMono);font-size:.66rem;
  z-index:999;opacity:0;pointer-events:none;
  transition:opacity .22s,transform .22s;white-space:nowrap;
  box-shadow:0 6px 24px var(--shad);
}
.toast.on{opacity:1;transform:translateX(-50%) translateY(-4px)}

/* â”€â”€ FONT ROW â”€â”€ */
.frow{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.frow label{font-family:var(--fMono);font-size:.58rem;color:var(--muted)}
.frow select{width:auto}

/* â”€â”€ SEARCH â”€â”€ */
.srchwrap{
  display:flex;gap:5px;align-items:center;
  background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);
  padding:4px 9px;
}
.srchwrap input{
  border:none;background:transparent;color:var(--txt);
  font-family:var(--fMono);font-size:.66rem;outline:none;flex:1;min-width:0;
}

/* â”€â”€ AUDIO REC â”€â”€ */
.rec-badge{
  display:inline-flex;align-items:center;gap:5px;
  font-family:var(--fMono);font-size:.62rem;
  background:rgba(255,107,107,.15);color:var(--warm);
  padding:3px 9px;border-radius:12px;border:1px solid var(--warm);
}
.rec-dot{width:7px;height:7px;background:var(--warm);border-radius:50%;animation:blink 1s infinite}

/* hidden */
#fileInput{display:none}

/* â”€â”€ MAP TABS â”€â”€ */
.mtabs{display:flex;gap:4px;margin-bottom:10px}
.mtab{
  font-family:var(--fMono);font-size:.6rem;padding:4px 11px;
  border:1px solid var(--bdr);border-radius:var(--r3);
  background:transparent;color:var(--muted);cursor:pointer;transition:all .15s;
}
.mtab.on{background:var(--acc);color:#fff;border-color:var(--acc)}

/* â”€â”€ EXPORT BTNS â”€â”€ */
.export-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:4px}
</style>
</head>
<body>

<div class="lbar" id="lb"></div>
<div class="toast" id="toast"></div>
<input type="file" id="fileInput" accept=".pdf,.txt,.md,.csv,.docx,.pptx,.epub"/>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="logo">
    STOICA<span style="-webkit-text-fill-color:var(--muted);font-weight:300">READER</span>
    <span class="badge">v4 Â· gratis</span>
  </div>
  <div class="hdr-r">
    <button class="ibtn" id="bTheme"  title="Claro / Oscuro">â˜€ï¸</button>
    <button class="ibtn" id="bFS"     title="Pantalla completa">â›¶</button>
    <button class="ibtn" id="bSide"   title="Panel lateral">â–</button>
    <button class="ibtn" id="bFloat"  title="Control flotante">âŠ•</button>
  </div>
</header>

<!-- â•â•â• TABS â•â•â• -->
<div class="tabs">
  <button class="tab on"  data-tab="reader">ğŸ“– Lector</button>
  <button class="tab"     data-tab="voices">ğŸ™ Voces</button>
  <button class="tab"     data-tab="notes">ğŸ“ Notas</button>
  <button class="tab"     data-tab="summary">ğŸ“‹ Resumen</button>
  <button class="tab"     data-tab="questions">â“ Preguntas</button>
  <button class="tab"     data-tab="mindmap">ğŸ—º Mapa</button>
  <button class="tab"     data-tab="translate">ğŸŒ TraducciÃ³n</button>
</div>

<!-- â•â•â• TOOLBAR â•â•â• -->
<div class="bar">
  <button class="btn acc" id="bFile">ğŸ“‚ Cargar archivo</button>
  <button class="btn g"   id="bPaste">ğŸ“‹ Pegar texto</button>
  <div class="vline"></div>
  <div class="frow">
    <label>Fuente</label>
    <select id="sfont">
      <option value="'DM Serif Display',Georgia,serif">Serif</option>
      <option value="'Outfit',sans-serif">Sans</option>
      <option value="'DM Mono',monospace">Mono</option>
      <option value="Georgia,serif">Georgia</option>
      <option value="'Courier New',monospace">Courier</option>
    </select>
    <label>TamaÃ±o</label>
    <select id="ssize">
      <option value="14px">14</option><option value="16px">16</option>
      <option value="18px" selected>18</option><option value="20px">20</option>
      <option value="24px">24</option><option value="28px">28</option>
    </select>
    <label>LÃ­nea</label>
    <select id="slh">
      <option value="1.5">1.5</option>
      <option value="1.9" selected>1.9</option>
      <option value="2.3">2.3</option>
    </select>
  </div>
  <div class="vline"></div>
  <button class="btn g" id="bHL">ğŸ–Š Resaltar</button>
  <button class="btn g" id="bNote">ğŸ’¾ Nota</button>
  <div class="vline"></div>
  <div class="srchwrap">
    <input type="text" id="srchInput" placeholder="Buscar en el textoâ€¦"/>
    <button class="ibtn" id="bSrchPrev" style="border:none;width:20px;height:20px">â—€</button>
    <button class="ibtn" id="bSrchNext" style="border:none;width:20px;height:20px">â–¶</button>
    <span id="srchInfo" style="font-family:var(--fMono);font-size:.58rem;color:var(--muted);white-space:nowrap"></span>
  </div>
</div>

<!-- â•â•â• STATS â•â•â• -->
<div class="stats">
  <span>Palabras: <b id="sw">0</b></span>
  <span>PÃ¡ginas: <b id="sp">0</b></span>
  <span>â± <b id="st">0 min</b></span>
  <span>Avance: <b id="spos">0%</b></span>
  <span id="statPill" class="pill">Detenido</span>
</div>

<!-- â•â•â• PROGRESS BAR â•â•â• -->
<div class="pbwrap">
  <div class="pbtrack" id="pbtrack" title="Clic para ir a esa posiciÃ³n">
    <div class="pbfill" id="pbfill"></div>
  </div>
</div>

<!-- â•â•â• TAB: READER â•â•â• -->
<div class="tpane on" id="tab-reader">
  <div class="layout">
    <div class="rpane" id="rPane"><div id="textDisplay" class="mt"></div></div>
    <aside class="side" id="sideP">
      <div class="sinner">
        <!-- Voice quick select -->
        <div class="card">
          <h3>ğŸ™ Voz activa</h3>
          <select id="voiceSel"></select>
          <div class="sl-lbl"><span>Velocidad</span><b id="rV">1.0x</b></div>
          <input type="range" id="rRate" min=".5" max="2.5" step=".1" value="1"/>
          <div class="sl-lbl"><span>Tono</span><b id="pV">1.0</b></div>
          <input type="range" id="rPitch" min=".5" max="2" step=".1" value="1"/>
          <div class="sl-lbl"><span>Volumen</span><b id="vV">100%</b></div>
          <input type="range" id="rVol" min="0" max="1" step=".05" value="1"/>
          <button class="btn g" onclick="goTab('voices')">â†’ Gestionar voces</button>
        </div>
        <!-- Export audio -->
        <div class="card">
          <h3>ğŸ”Š Exportar audio</h3>
          <input type="text" id="audioName" placeholder="nombre-del-archivo"/>
          <button class="btn gr" id="bExport">â¬‡ Iniciar grabaciÃ³n</button>
          <button class="btn red" id="bStopRec" style="display:none">â¹ Detener y guardar</button>
          <div id="recStatus" style="display:none">
            <span class="rec-badge"><span class="rec-dot"></span>Grabandoâ€¦</span>
          </div>
          <p style="font-family:var(--fMono);font-size:.55rem;color:var(--muted);line-height:1.55">
            Chrome: comparte la pestaÃ±a y activa "Compartir audio". Firefox: captura directa desde AudioContext.
          </p>
        </div>
        <!-- Quick translate -->
        <div class="card">
          <h3>ğŸŒ TraducciÃ³n rÃ¡pida</h3>
          <select id="sdest">
            <option value="es">â†’ EspaÃ±ol</option>
            <option value="en">â†’ InglÃ©s</option>
            <option value="fr">â†’ FrancÃ©s</option>
            <option value="de">â†’ AlemÃ¡n</option>
            <option value="pt">â†’ PortuguÃ©s</option>
            <option value="it">â†’ Italiano</option>
          </select>
          <button class="btn b" id="bQTrans">ğŸŒ Traducir texto</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- â•â•â• TAB: VOCES â•â•â• -->
<div class="tpane" id="tab-voices">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ™ VOCES DEL SISTEMA</h2>
      <div class="voice-filter">
        <select id="vLangFilter">
          <option value="">Todos los idiomas</option>
          <option value="es">EspaÃ±ol</option>
          <option value="en">InglÃ©s</option>
          <option value="fr">FrancÃ©s</option>
          <option value="de">AlemÃ¡n</option>
          <option value="pt">PortuguÃ©s</option>
          <option value="it">Italiano</option>
        </select>
        <button class="btn g" id="bRefreshVoices">â†º Actualizar</button>
        <span id="vCount" style="font-family:var(--fMono);font-size:.6rem;color:var(--muted)"></span>
      </div>
    </div>
    <div class="infobox">
      <b>Tip:</b> Haz clic en una voz para seleccionarla como activa Â· Usa â–¶ para previsualizar Â· Las voces dependen del sistema operativo y el navegador.
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
      <input type="text" id="previewTxt" placeholder="Texto de pruebaâ€¦" style="flex:1;max-width:400px"/>
    </div>
    <div class="voice-grid" id="voiceGrid"></div>
  </div>
</div>

<!-- â•â•â• TAB: NOTAS â•â•â• -->
<div class="tpane" id="tab-notes">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ“ MIS NOTAS</h2>
      <button class="btn g" id="bClearNotes" style="margin-left:auto">ğŸ—‘ Limpiar todo</button>
      <button class="btn g" id="bExNotesTxt">â¬‡ TXT</button>
    </div>
    <p id="emptyN" style="font-family:var(--fMono);font-size:.72rem;color:var(--muted)">
      Selecciona texto en el lector â†’ pulsa "ğŸ’¾ Nota".
    </p>
    <div id="notesCont"></div>
  </div>
</div>

<!-- â•â•â• TAB: RESUMEN â•â•â• -->
<div class="tpane" id="tab-summary">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ“‹ RESUMEN AUTOMÃTICO</h2>
      <select id="sLevel">
        <option value="breve">Breve (~5 oraciones)</option>
        <option value="medio" selected>Intermedio (~10 oraciones)</option>
        <option value="completo">Detallado (~20 oraciones)</option>
      </select>
      <button class="btn acc" id="bSumm">âœ¨ Generar</button>
      <button class="btn g"   id="bCopySumm">ğŸ“‹ Copiar</button>
      <button class="btn g"   id="bExSumm">â¬‡ TXT</button>
    </div>
    <div class="infobox">âœ… Funciona <b>sin internet</b> â€” algoritmo extractivo TF-IDF. Sin APIs de pago.</div>
    <div id="summOut" class="out mt">El resumen aparecerÃ¡ aquÃ­. Carga un texto y pulsa "Generar".</div>
  </div>
</div>

<!-- â•â•â• TAB: PREGUNTAS â•â•â• -->
<div class="tpane" id="tab-questions">
  <div class="pinner">
    <div class="phead">
      <h2>â“ PREGUNTAS DE COMPRENSIÃ“N</h2>
      <select id="qType">
        <option value="literal">Literal</option>
        <option value="inferencial">Inferencial</option>
        <option value="mixto" selected>Mixto</option>
      </select>
      <input type="number" id="qNum" value="10" min="5" max="30"
        style="width:52px;border:1px solid var(--bdr);border-radius:var(--r);
        background:var(--surf2);color:var(--txt);font-family:var(--fMono);font-size:.62rem;padding:5px 7px"/>
      <button class="btn acc" id="bGenQ">âœ¨ Generar</button>
      <button class="btn g"   id="bCopyQ">ğŸ“‹ Copiar</button>
      <button class="btn go"  id="bExQDocx">â¬‡ Word</button>
      <button class="btn gr"  id="bExQXlsx">â¬‡ Excel</button>
    </div>
    <div class="infobox">âœ… Genera preguntas <b>sin internet</b>. Exporta a Word (.docx) o Excel (.xlsx) con un clic.</div>
    <div id="questOut"></div>
  </div>
</div>

<!-- â•â•â• TAB: MAPA â•â•â• -->
<div class="tpane" id="tab-mindmap">
  <div class="pinner">
    <div class="phead">
      <h2>ğŸ—º MAPA CONCEPTUAL</h2>
      <button class="btn acc" id="bGenMap">âœ¨ Generar</button>
    </div>
    <div class="infobox">âœ… AnÃ¡lisis TF-IDF <b>sin internet</b>. Incluye mapa mental, jerarquÃ­a, cuadro comparativo.</div>
    <div class="mtabs" id="mapTabsBar">
      <button class="mtab on" data-mpane="mmapa">ğŸ—º Mapa mental</button>
      <button class="mtab"    data-mpane="mhier">ğŸ“‹ JerarquÃ­a</button>
      <button class="mtab"    data-mpane="mcomp">âš–ï¸ Comparativo</button>
      <button class="mtab"    data-mpane="mideas">ğŸ’¡ Ideas clave</button>
    </div>
    <div id="mmapa" class="mpane on" style="display:flex;flex-direction:column;gap:10px">
      <div id="mapOut" class="mapwrap">
        <span style="font-family:var(--fMono);font-size:.7rem;color:var(--muted)">El mapa conceptual aparecerÃ¡ aquÃ­.</span>
      </div>
    </div>
    <div id="mhier" class="mpane" style="display:none">
      <div id="hierOut" class="out mt" style="max-height:none;font-family:var(--fMono)">La jerarquÃ­a aparecerÃ¡ aquÃ­.</div>
    </div>
    <div id="mcomp" class="mpane" style="display:none;overflow-x:auto">
      <div id="compOut"></div>
    </div>
    <div id="mideas" class="mpane" style="display:none">
      <div id="ideasOut" class="out mt">Las ideas clave aparecerÃ¡n aquÃ­.</div>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: TRADUCCIÃ“N â•â•â• -->
<div class="tpane" id="tab-translate">
  <div class="pinner" style="height:100%">
    <div class="phead">
      <h2>ğŸŒ TRADUCCIÃ“N</h2>
      <select id="tSrc" style="min-width:120px">
        <option value="auto">Detectar</option>
        <option value="es">EspaÃ±ol</option>
        <option value="en">InglÃ©s</option>
        <option value="fr">FrancÃ©s</option>
        <option value="de">AlemÃ¡n</option>
        <option value="pt">PortuguÃ©s</option>
        <option value="it">Italiano</option>
        <option value="ru">Ruso</option>
        <option value="zh">Chino</option>
        <option value="ar">Ãrabe</option>
        <option value="ja">JaponÃ©s</option>
      </select>
      <span style="font-family:var(--fMono)">â†’</span>
      <select id="tDest" style="min-width:120px">
        <option value="es" selected>EspaÃ±ol</option>
        <option value="en">InglÃ©s</option>
        <option value="fr">FrancÃ©s</option>
        <option value="de">AlemÃ¡n</option>
        <option value="pt">PortuguÃ©s</option>
        <option value="it">Italiano</option>
        <option value="ru">Ruso</option>
        <option value="zh">Chino</option>
        <option value="ar">Ãrabe</option>
        <option value="ja">JaponÃ©s</option>
      </select>
      <button class="btn acc" id="bTransAll">ğŸŒ Traducir todo</button>
      <button class="btn g"   id="bTransSel">ğŸŒ SelecciÃ³n</button>
      <button class="btn g"   id="bCopyTrans">ğŸ“‹ Copiar</button>
    </div>
    <div class="infobox">âœ… Usa <b>MyMemory API</b> (sin registro, sin clave). LÃ­mite: ~10.000 palabras/dÃ­a.</div>
    <div class="tgrid" style="flex:1">
      <div class="tcol">
        <div class="tlbl">TEXTO ORIGINAL</div>
        <div id="tOrig" class="out mt" style="flex:1">El texto original aparecerÃ¡ aquÃ­.</div>
      </div>
      <div class="tcol">
        <div class="tlbl">TRADUCCIÃ“N</div>
        <div id="tOut" class="out mt" style="flex:1">La traducciÃ³n aparecerÃ¡ aquÃ­.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• TTS BAR â•â•â• -->
<div class="ttsbar">
  <button class="pbig b2" id="bSel"  title="Leer selecciÃ³n">â—ˆ</button>
  <button class="pbig"    id="bPlay" title="Reproducir / Pausar">â–¶</button>
  <button class="ibtn"    id="bStop" title="Detener" style="width:38px;height:38px;font-size:.9rem">â¹</button>
  <div class="hint">Espacio = pausar Â· Esc = detener Â· â—ˆ = leer selecciÃ³n</div>
</div>

<!-- â•â•â• CONTROL FLOTANTE â•â•â• -->
<div id="fc" class="off">
  <div class="fcdrg" id="fcdrag">â‹®â‹®</div>
  <button class="fcbtn r" id="fc-p">â–¶</button>
  <button class="fcbtn"   id="fc-s">â¹</button>
  <div class="fcspd" id="fcspd">1.0x</div>
  <button class="fcbtn" id="fc-sl" title="MÃ¡s lento">ğŸ¢</button>
  <button class="fcbtn" id="fc-fa" title="MÃ¡s rÃ¡pido">âš¡</button>
</div>

<!-- â•â•â• MODAL: PEGAR â•â•â• -->
<div class="ov" id="pasteOv">
  <div class="modal">
    <h2>ğŸ“‹ Pegar texto</h2>
    <textarea id="pasteA" placeholder="Pega aquÃ­ tu textoâ€¦"></textarea>
    <div class="mfooter">
      <button class="btn g"   id="bCancelP">Cancelar</button>
      <button class="btn acc" id="bConfP">Cargar texto â€º</button>
    </div>
  </div>
</div>

<!-- External Libraries -->
<!-- PDF.js (Mozilla, open source) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- mammoth.js for DOCX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOICA READER v4 â€” 100% Gratuito
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Nuevas funcionalidades v4:
   â€¢ Soporte multi-formato: PDF, DOCX, PPTX, TXT, EPUB
   â€¢ SecciÃ³n de voces unificada con previsualizaciÃ³n
   â€¢ ExportaciÃ³n de preguntas a Word (.docx) y Excel (.xlsx)
   â€¢ Mapa conceptual mejorado: mapa mental, jerarquÃ­a, comparativo
   â€¢ ExportaciÃ³n de audio mejorada
   â€¢ Resaltado TTS sincronizado mejorado
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ UTILIDADES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $  = id => document.getElementById(id);
const qs = (s,ctx=document) => ctx.querySelector(s);
const qsAll = (s,ctx=document) => [...ctx.querySelectorAll(s)];
const E  = txt => String(txt).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function toast(msg, dur=2600){
  const t=$('toast'); t.textContent=msg;
  t.classList.add('on');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('on'),dur);
}
function load(pct){
  $('lb').style.width=pct+'%';
  if(pct>=100) setTimeout(()=>$('lb').style.width='0%',500);
}
function dl(text, name){
  const b=new Blob([text],{type:'text/plain;charset=utf-8'});
  const u=URL.createObjectURL(b);
  Object.assign(document.createElement('a'),{href:u,download:name}).click();
  URL.revokeObjectURL(u);
}
function dlBlob(blob, name){
  const u=URL.createObjectURL(blob);
  Object.assign(document.createElement('a'),{href:u,download:name}).click();
  setTimeout(()=>URL.revokeObjectURL(u),2000);
}
function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
function goTab(name){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.tpane').forEach(x=>x.classList.remove('on'));
  const t=qs(`[data-tab="${name}"]`);
  if(t) t.classList.add('on');
  $('tab-'+name)?.classList.add('on');
}
window.goTab=goTab;

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fullText='';
let wordEls=[];
let curW=0;
let synth=window.speechSynthesis;
let voices=[];
let utt=null;
let playing=false, paused=false;
let notes=JSON.parse(localStorage.getItem('sr_notes_v4')||'[]');
let mediaRec=null, recChunks=[], recording=false;
let keepTimer=null;
let srchMatches=[], srchIdx=0;
let lastQs=[];
let allMapData=null;

// â”€â”€ PDF.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pdfjsLib.GlobalWorkerOptions.workerSrc=
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ TEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bTheme').onclick=()=>{
  const dark=document.documentElement.dataset.theme==='dark';
  document.documentElement.dataset.theme=dark?'light':'dark';
  $('bTheme').textContent=dark?'ğŸŒ™':'â˜€ï¸';
};

$('bFS').onclick=()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};
$('bSide').onclick=()=>$('sideP').classList.toggle('off');
$('bFloat').onclick=()=>$('fc').classList.toggle('off');
$('sfont').onchange=()=>document.documentElement.style.setProperty('--fBody',$('sfont').value);
$('ssize').onchange=()=>document.documentElement.style.setProperty('--fs',$('ssize').value);
$('slh').onchange=()=>document.documentElement.style.setProperty('--lh',$('slh').value);

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tpane').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    $('tab-'+t.dataset.tab).classList.add('on');
  };
});

// â”€â”€ MAP SUB-TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.mtab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.mtab').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.mpane').forEach(x=>x.style.display='none');
    t.classList.add('on');
    const pane=$(t.dataset.mpane);
    if(pane) pane.style.display='flex', pane.style.flexDirection='column', pane.style.gap='10px';
    if(t.dataset.mpane==='mcomp') $(t.dataset.mpane).style.display='block';
    if(t.dataset.mpane==='mideas') $(t.dataset.mpane).style.display='flex';
  };
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGA DE TEXTO â€” Multiformato
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadText(text, src='Texto'){
  fullText=text.trim();
  if(!fullText){toast('El texto estÃ¡ vacÃ­o.');return;}
  buildSpans(fullText);
  updateStats();
  stopSpeech();
  setProgress(0);
  clearSearch();
  const n=fullText.split(/\s+/).filter(Boolean).length;
  toast(`âœ“ ${src} cargado â€” ${n.toLocaleString()} palabras`);
}

function buildSpans(text){
  const tokens=text.split(/(\s+)/);
  let html=''; let wi=0;
  tokens.forEach(tok=>{
    if(/\S/.test(tok)){
      html+=`<span class="w" data-i="${wi}">${E(tok)}</span>`;
      wi++;
    } else {
      html+=tok.replace(/\n/g,'<br/>');
    }
  });
  const d=$('textDisplay');
  d.innerHTML=html;
  d.classList.remove('mt');
  wordEls=[...d.querySelectorAll('.w')];
  curW=0;
}

function updateStats(){
  if(!fullText){$('sw').textContent='0';$('sp').textContent='0';$('st').textContent='0 min';return;}
  const w=fullText.split(/\s+/).filter(Boolean).length;
  $('sw').textContent=w.toLocaleString();
  $('sp').textContent=Math.max(1,Math.ceil(w/250));
  $('st').textContent=Math.max(1,Math.round(w/200))+' min';
}

// â”€â”€ FILE INPUT UNIFICADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bFile').onclick=()=>$('fileInput').click();
$('fileInput').onchange=async e=>{
  const file=e.target.files[0]; if(!file)return;
  const name=file.name.toLowerCase();
  load(10);
  try{
    if(name.endsWith('.pdf'))       await loadPDF(file);
    else if(name.endsWith('.docx')) await loadDOCX(file);
    else if(name.endsWith('.pptx')) await loadPPTX(file);
    else if(name.endsWith('.epub')) await loadEPUB(file);
    else                            await loadTXT(file);
  }catch(err){toast('Error: '+err.message);load(100);}
  $('fileInput').value='';
};

async function loadPDF(file){
  toast('â³ Leyendo PDFâ€¦',15000);
  const ab=await file.arrayBuffer(); load(30);
  let pdf;
  try{ pdf=await pdfjsLib.getDocument({data:ab}).promise; }
  catch(e){ toast('PDF daÃ±ado o protegido: '+e.message); load(100); return; }
  load(40);
  let text=''; let hasText=false;
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const ct=await page.getTextContent();
    if(ct.items.length) hasText=true;
    let pageText=''; let lastY=null; let lastX=null;
    ct.items.forEach(item=>{
      const y=item.transform[5], x=item.transform[4];
      if(lastY!==null){
        const dy=Math.abs(y-lastY);
        if(dy>12) pageText+='\n\n';
        else if(dy>4) pageText+='\n';
        else if(x-lastX>20) pageText+=' ';
      }
      pageText+=item.str;
      lastY=y; lastX=x+(item.width||0);
    });
    text+=pageText.trim()+'\n\n';
    load(40+Math.round((i/pdf.numPages)*55));
  }
  load(100);
  if(!hasText){
    toast('âš ï¸ PDF escaneado (imagen) â€” no contiene texto extraÃ­ble. Usa OCR primero.',5000);
    return;
  }
  loadText(text, file.name);
}

async function loadDOCX(file){
  toast('â³ Leyendo DOCXâ€¦',10000);
  if(typeof mammoth==='undefined'){
    toast('âš ï¸ LibrerÃ­a mammoth no disponible. Recarga la pÃ¡gina.');load(100);return;
  }
  const ab=await file.arrayBuffer(); load(50);
  const result=await mammoth.extractRawText({arrayBuffer:ab});
  load(100);
  if(result.value) loadText(result.value, file.name);
  else toast('No se pudo extraer texto del DOCX.');
}

async function loadPPTX(file){
  toast('â³ Leyendo PPTXâ€¦',10000);
  // PPTX is a ZIP, extract slide XML and parse text
  try{
    const ab=await file.arrayBuffer(); load(30);
    // Use basic ZIP parsing with DataView
    const text=await extractPPTXText(ab);
    load(100);
    if(text.trim()) loadText(text, file.name);
    else toast('No se pudo extraer texto del PPTX. Formato no soportado completamente.');
  }catch(e){
    toast('Error al leer PPTX: '+e.message); load(100);
  }
}

async function extractPPTXText(ab){
  // Minimal ZIP parser to get slide XML
  const bytes=new Uint8Array(ab);
  const files=parseZip(bytes);
  const slideFiles=Object.keys(files).filter(k=>k.match(/^ppt\/slides\/slide\d+\.xml$/)).sort((a,b)=>{
    const na=parseInt(a.match(/\d+/)[0]), nb=parseInt(b.match(/\d+/)[0]);
    return na-nb;
  });
  let text='';
  slideFiles.forEach((sf,i)=>{
    const xml=new TextDecoder('utf-8').decode(files[sf]);
    // Extract all text nodes from XML
    const matches=xml.match(/<a:t[^>]*>([^<]*)<\/a:t>/g)||[];
    const slideText=matches.map(m=>m.replace(/<[^>]+>/g,'')).filter(Boolean).join(' ');
    if(slideText.trim()) text+=`[Diapositiva ${i+1}]\n${slideText.trim()}\n\n`;
    load(30+Math.round((i/slideFiles.length)*65));
  });
  return text;
}

function parseZip(bytes){
  // Minimal ZIP central directory parser
  const files={};
  let i=0;
  const view=new DataView(bytes.buffer);
  while(i<bytes.length-4){
    if(view.getUint32(i,true)===0x04034b50){
      const fnLen=view.getUint16(i+26,true);
      const extraLen=view.getUint16(i+28,true);
      const compSize=view.getUint32(i+18,true);
      const compMethod=view.getUint16(i+8,true);
      const fname=new TextDecoder().decode(bytes.slice(i+30,i+30+fnLen));
      const dataStart=i+30+fnLen+extraLen;
      if(compMethod===0){
        files[fname]=bytes.slice(dataStart,dataStart+compSize);
      }
      i=dataStart+compSize;
    } else { i++; }
  }
  return files;
}

async function loadEPUB(file){
  toast('â³ Leyendo EPUBâ€¦',10000);
  try{
    const ab=await file.arrayBuffer(); load(30);
    const bytes=new Uint8Array(ab);
    const zipFiles=parseZip(bytes);
    load(50);
    // Extract content from EPUB (HTML files)
    const htmlFiles=Object.keys(zipFiles).filter(k=>k.match(/\.(html|xhtml|htm)$/i) && !k.includes('nav'));
    let text='';
    htmlFiles.forEach(hf=>{
      const html=new TextDecoder('utf-8').decode(zipFiles[hf]);
      const tmp=document.createElement('div');
      tmp.innerHTML=html;
      // Remove scripts and styles
      tmp.querySelectorAll('script,style,nav').forEach(el=>el.remove());
      const t=tmp.innerText||tmp.textContent;
      if(t.trim()) text+=t.trim()+'\n\n';
    });
    load(100);
    if(text.trim()) loadText(text, file.name);
    else toast('No se pudo extraer texto del EPUB.');
  }catch(e){
    toast('Error al leer EPUB: '+e.message); load(100);
  }
}

async function loadTXT(file){
  const r=new FileReader();
  return new Promise((res,rej)=>{
    r.onload=ev=>{load(100);loadText(ev.target.result,file.name);res();};
    r.onerror=rej;
    r.readAsText(file,'UTF-8');
  });
}

// â”€â”€ PEGAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bPaste').onclick=()=>{$('pasteOv').classList.add('on');$('pasteA').focus()};
$('bCancelP').onclick=()=>{$('pasteOv').classList.remove('on');$('pasteA').value=''};
$('bConfP').onclick=()=>{
  const t=$('pasteA').value.trim();
  if(t) loadText(t,'Texto pegado');
  $('pasteOv').classList.remove('on');$('pasteA').value='';
};
$('pasteOv').onclick=e=>{if(e.target===$('pasteOv'))$('bCancelP').click()};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESALTADO Y NOTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('bHL').onclick=()=>{
  const sel=window.getSelection();
  if(!sel||sel.isCollapsed){toast('Selecciona texto primero.');return;}
  const range=sel.getRangeAt(0);
  const mark=document.createElement('mark');
  mark.className='hl';
  try{range.surroundContents(mark);sel.removeAllRanges();toast('âœ“ Texto resaltado');}
  catch{toast('SelecciÃ³n invÃ¡lida â€” intenta seleccionar dentro de un pÃ¡rrafo.');}
};

$('bNote').onclick=()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(!txt){toast('Selecciona texto para guardar como nota.');return;}
  addNote(txt); sel.removeAllRanges(); toast('âœ“ Nota guardada');
};

function addNote(text){
  notes.unshift({id:Date.now(),text,date:new Date().toLocaleString('es-CO')});
  saveNotes(); renderNotes();
}
function saveNotes(){localStorage.setItem('sr_notes_v4',JSON.stringify(notes));}

function renderNotes(){
  $('emptyN').style.display=notes.length?'none':'block';
  const c=$('notesCont'); c.innerHTML='';
  notes.forEach(n=>{
    const d=document.createElement('div');
    d.className='ncard'; d.dataset.id=n.id;
    d.innerHTML=`
      <div class="nmeta">${E(n.date)}</div>
      <div class="nbody">${E(n.text)}</div>
      <div class="nacts">
        <button class="btn g" onclick="editNote(${n.id})">âœï¸ Editar</button>
        <button class="btn g" onclick="delNote(${n.id})">ğŸ—‘ Borrar</button>
        <button class="btn g" onclick="readNote(${n.id})">ğŸ”Š Leer</button>
      </div>`;
    c.appendChild(d);
  });
}
window.editNote=function(id){
  const n=notes.find(x=>x.id===id); if(!n)return;
  const card=qs(`.ncard[data-id="${id}"]`);
  const body=qs('.nbody',card);
  const ta=document.createElement('textarea');
  ta.className='nta'; ta.value=n.text;
  body.replaceWith(ta);
  qs('.nacts',card).innerHTML=`
    <button class="btn acc" onclick="saveNote(${id})">ğŸ’¾ Guardar</button>
    <button class="btn g" onclick="renderNotes()">Cancelar</button>`;
};
window.saveNote=function(id){
  const ta=qs(`.ncard[data-id="${id}"] textarea`);
  const n=notes.find(x=>x.id===id);
  if(n&&ta){n.text=ta.value;saveNotes();renderNotes();toast('âœ“ Nota actualizada');}
};
window.delNote=function(id){
  if(!confirm('Â¿Eliminar esta nota?'))return;
  notes=notes.filter(x=>x.id!==id);saveNotes();renderNotes();toast('Nota eliminada');
};
window.readNote=function(id){
  const n=notes.find(x=>x.id===id); if(n) speak(n.text);
};
$('bClearNotes').onclick=()=>{
  if(!confirm('Â¿Eliminar TODAS las notas?'))return;
  notes=[];saveNotes();renderNotes();
};
$('bExNotesTxt').onclick=()=>{
  if(!notes.length){toast('No hay notas para exportar.');return;}
  dl(notes.map(n=>`[${n.date}]\n${n.text}`).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n'),'stoica-notas.txt');
  toast('âœ“ Notas exportadas');
};
renderNotes();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BÃšSQUEDA EN EL TEXTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearSearch(){
  srchMatches=[];srchIdx=0;$('srchInfo').textContent='';
}
$('srchInput').addEventListener('input',debounce(doSearch,300));
$('bSrchNext').onclick=()=>{if(srchMatches.length){srchIdx=(srchIdx+1)%srchMatches.length;highlightSearchCurrent();}};
$('bSrchPrev').onclick=()=>{if(srchMatches.length){srchIdx=(srchIdx-1+srchMatches.length)%srchMatches.length;highlightSearchCurrent();}};

function doSearch(){
  const q=$('srchInput').value.trim().toLowerCase();
  document.querySelectorAll('mark.find').forEach(m=>{
    const parent=m.parentNode;
    parent.replaceChild(document.createTextNode(m.textContent),m);
    parent.normalize();
  });
  srchMatches=[];srchIdx=0;
  if(!q||!fullText){$('srchInfo').textContent='';return;}
  const d=$('textDisplay');
  const walker=document.createTreeWalker(d,NodeFilter.SHOW_TEXT,null);
  const textNodes=[]; let node;
  while((node=walker.nextNode())) textNodes.push(node);
  let count=0;
  textNodes.forEach(tn=>{
    const val=tn.nodeValue; const lower=val.toLowerCase();
    let idx=0,pos;
    const frag=document.createDocumentFragment();
    while((pos=lower.indexOf(q,idx))!==-1){
      if(pos>idx) frag.appendChild(document.createTextNode(val.slice(idx,pos)));
      const mark=document.createElement('mark');
      mark.className='find';mark.textContent=val.slice(pos,pos+q.length);
      frag.appendChild(mark);srchMatches.push(mark);idx=pos+q.length;count++;
    }
    if(idx<val.length) frag.appendChild(document.createTextNode(val.slice(idx)));
    if(count) tn.parentNode.replaceChild(frag,tn);
  });
  $('srchInfo').textContent=count?`${count} encontrado${count!==1?'s':''}`:' sin resultados';
  if(srchMatches.length) highlightSearchCurrent();
}

function highlightSearchCurrent(){
  srchMatches.forEach((m,i)=>m.className=i===srchIdx?'find cur':'find');
  if(srchMatches[srchIdx]) srchMatches[srchIdx].scrollIntoView({behavior:'smooth',block:'center'});
  $('srchInfo').textContent=`${srchIdx+1}/${srchMatches.length}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEB SPEECH API â€” VOCES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadVoices(){
  voices=synth.getVoices();
  // Populate quick select
  const sel=$('voiceSel'); sel.innerHTML='';
  let esDefault=0;
  voices.forEach((v,i)=>{
    const o=document.createElement('option');
    o.value=i; o.textContent=`${v.name} (${v.lang})`;
    sel.appendChild(o);
    if(v.lang.startsWith('es')&&!esDefault) esDefault=i;
  });
  sel.value=esDefault;
  // Render voice cards
  renderVoiceGrid();
}
loadVoices();
if(speechSynthesis.onvoiceschanged!==undefined) speechSynthesis.onvoiceschanged=loadVoices;

function renderVoiceGrid(){
  const filter=$('vLangFilter').value;
  const grid=$('voiceGrid'); grid.innerHTML='';
  const curIdx=parseInt($('voiceSel').value)||0;
  const filtered=voices.map((v,i)=>({v,i})).filter(({v})=>!filter||v.lang.startsWith(filter));
  $('vCount').textContent=`${filtered.length} voz${filtered.length!==1?'es':''}`;
  filtered.forEach(({v,i})=>{
    const card=document.createElement('div');
    card.className='vcard'+(i===curIdx?' sel':'');
    const langCode=v.lang.split('-')[0].toLowerCase();
    const tagClass=(langCode==='es'||langCode==='en')?langCode:'';
    card.innerHTML=`
      <div class="vname">${E(v.name)}</div>
      <div class="vlang">${E(v.lang)}</div>
      <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">
        <span class="vtag ${tagClass}">${E(v.lang)}</span>
        ${v.localService?'<span class="vtag" style="color:var(--acc3)">Local</span>':''}
        ${v.default?'<span class="vtag" style="color:var(--gold)">Default</span>':''}
        <button class="btn g" style="margin-left:auto;padding:2px 8px;font-size:.55rem"
          onclick="previewVoice(${i})">â–¶ Prueba</button>
      </div>`;
    card.onclick=e=>{if(e.target.tagName==='BUTTON')return;selectVoice(i);};
    grid.appendChild(card);
  });
}

window.selectVoice=function(i){
  $('voiceSel').value=i;
  document.querySelectorAll('.vcard').forEach((c,ci)=>{
    const v_i=parseInt(c.querySelector('.vlang')?.parentElement?.previousElementSibling?.previousElementSibling?.dataset?.i||'-1');
  });
  // Re-render to update sel state
  renderVoiceGrid();
  toast(`âœ“ Voz: ${voices[i]?.name}`);
};

window.previewVoice=function(i){
  const txt=$('previewTxt').value.trim()||'Hola, esta es una prueba de voz. Hello, this is a voice test.';
  const u=new SpeechSynthesisUtterance(txt);
  if(voices[i]) u.voice=voices[i];
  u.rate=parseFloat($('rRate').value);
  u.pitch=parseFloat($('rPitch').value);
  u.volume=parseFloat($('rVol').value);
  synth.cancel();synth.speak(u);
  toast(`â–¶ ${voices[i]?.name}`);
};

$('vLangFilter').onchange=renderVoiceGrid;
$('bRefreshVoices').onclick=()=>{loadVoices();toast('âœ“ Voces actualizadas');};

// Sliders
$('rRate').oninput=()=>{
  const v=parseFloat($('rRate').value).toFixed(1);
  $('rV').textContent=v+'x'; $('fcspd').textContent=v+'x';
};
$('rPitch').oninput=()=>$('pV').textContent=parseFloat($('rPitch').value).toFixed(1);
$('rVol').oninput=()=>$('vV').textContent=Math.round(parseFloat($('rVol').value)*100)+'%';

// â”€â”€ Crear utterance â”€â”€
function makeUtt(text){
  const u=new SpeechSynthesisUtterance(text);
  u.rate=parseFloat($('rRate').value);
  u.pitch=parseFloat($('rPitch').value);
  u.volume=parseFloat($('rVol').value);
  const vi=parseInt($('voiceSel').value);
  if(voices[vi]) u.voice=voices[vi];

  u.onstart=()=>{
    playing=true;paused=false;
    $('bPlay').textContent='â¸'; $('fc-p').textContent='â¸';
    $('statPill').textContent='â–¶ Reproduciendo';
    $('statPill').className='pill play';
  };
  u.onpause=()=>{
    paused=true;
    $('bPlay').textContent='â–¶'; $('fc-p').textContent='â–¶';
    $('statPill').textContent='â¸ Pausado';
    $('statPill').className='pill pause';
  };
  u.onresume=()=>{
    paused=false;
    $('bPlay').textContent='â¸'; $('fc-p').textContent='â¸';
    $('statPill').textContent='â–¶ Reproduciendo';
    $('statPill').className='pill play';
  };
  u.onend=u.onerror=()=>resetPlay();

  // â”€â”€ RESALTADO SINCRONIZADO â”€â”€
  u.onboundary=ev=>{
    if(ev.name!=='word') return;
    const before=text.substring(0,ev.charIndex);
    const wIdx=before.split(/\s+/).filter(Boolean).length;
    hlWord(wIdx);
  };
  return u;
}

function hlWord(idx){
  if(!wordEls.length) return;
  if(curW<wordEls.length) wordEls[curW].classList.remove('now');
  curW=Math.min(idx,wordEls.length-1);
  const el=wordEls[curW];
  if(!el) return;
  el.classList.add('now');
  el.classList.add('done');
  el.scrollIntoView({behavior:'smooth',block:'center',inline:'nearest'});
  const pct=Math.round((curW/Math.max(1,wordEls.length-1))*100);
  setProgress(pct);
}

function clearHL(){wordEls.forEach(w=>{w.classList.remove('now','done');});curW=0;setProgress(0);}

function resetPlay(){
  clearInterval(keepTimer);
  playing=false;paused=false;utt=null;
  $('bPlay').textContent='â–¶'; $('fc-p').textContent='â–¶';
  $('statPill').textContent='Detenido';
  $('statPill').className='pill';
  clearHL(); stopRec();
}

function keepAlive(){
  clearInterval(keepTimer);
  keepTimer=setInterval(()=>{
    if(!synth.speaking){clearInterval(keepTimer);return;}
    if(document.hidden){synth.pause();setTimeout(()=>{if(playing&&paused)synth.resume();},80);}
  },12000);
}

function speak(text){
  if(!text.trim())return;
  synth.cancel();clearHL();
  utt=makeUtt(text);
  keepAlive();
  synth.speak(utt);
}

function stopSpeech(){clearInterval(keepTimer);synth.cancel();resetPlay();}

function togglePlay(){
  if(!playing&&!paused){
    const txt=fullText||$('textDisplay').textContent;
    if(!txt.trim()){toast('Carga texto primero.');return;}
    speak(txt);
  } else if(playing&&!paused){synth.pause();}
  else if(paused){synth.resume();}
}

$('bPlay').onclick=togglePlay;
$('fc-p').onclick=togglePlay;
$('bStop').onclick=stopSpeech;
$('fc-s').onclick=stopSpeech;
$('bSel').onclick=()=>{
  const sel=window.getSelection();
  const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(txt) speak(txt); else toast('Selecciona texto primero.');
};
$('fc-sl').onclick=()=>{
  const v=Math.max(.5,parseFloat($('rRate').value)-.1);
  $('rRate').value=v;$('rV').textContent=v.toFixed(1)+'x';$('fcspd').textContent=v.toFixed(1)+'x';
};
$('fc-fa').onclick=()=>{
  const v=Math.min(2.5,parseFloat($('rRate').value)+.1);
  $('rRate').value=v;$('rV').textContent=v.toFixed(1)+'x';$('fcspd').textContent=v.toFixed(1)+'x';
};

function setProgress(pct){
  $('pbfill').style.width=pct+'%';$('spos').textContent=pct+'%';
}

$('pbtrack').onclick=e=>{
  if(!fullText){toast('Carga texto primero.');return;}
  const rect=$('pbtrack').getBoundingClientRect();
  const pct=Math.max(0,Math.min(100,((e.clientX-rect.left)/rect.width)*100));
  const wIdx=Math.floor((pct/100)*(wordEls.length-1));
  stopSpeech();
  const words=fullText.split(/\s+/).filter(Boolean);
  const from=words.slice(wIdx).join(' ');
  curW=wIdx;
  setTimeout(()=>{speak(from);if(wordEls[wIdx]) wordEls[wIdx].scrollIntoView({behavior:'smooth',block:'center'});},80);
  setProgress(Math.round(pct));
};

// â”€â”€ ARRASTRAR FLOTANTE â”€â”€
(()=>{
  const el=$('fc'),handle=$('fcdrag');
  let ox,oy,ex,ey;
  function onMove(cx,cy){
    el.style.right='auto';el.style.bottom='auto';
    el.style.left=(ex+cx-ox)+'px';el.style.top=(ey+cy-oy)+'px';
  }
  handle.addEventListener('mousedown',e=>{
    ex=el.offsetLeft;ey=el.offsetTop;ox=e.clientX;oy=e.clientY;e.preventDefault();
    const mm=ev=>onMove(ev.clientX,ev.clientY);
    document.addEventListener('mousemove',mm);
    document.addEventListener('mouseup',()=>document.removeEventListener('mousemove',mm),{once:true});
  });
  handle.addEventListener('touchstart',e=>{
    const t=e.touches[0];ex=el.offsetLeft;ey=el.offsetTop;ox=t.clientX;oy=t.clientY;
    const tm=ev=>{const t2=ev.touches[0];onMove(t2.clientX,t2.clientY);};
    document.addEventListener('touchmove',tm,{passive:true});
    document.addEventListener('touchend',()=>document.removeEventListener('touchmove',tm),{once:true});
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTAR AUDIO (MediaRecorder + getDisplayMedia)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('bExport').onclick=async()=>{
  const text=fullText.trim()||$('textDisplay').textContent.trim();
  if(!text){toast('Carga texto primero.');return;}
  try{
    const stream=await navigator.mediaDevices.getDisplayMedia({
      video:{displaySurface:'browser'},
      audio:{echoCancellation:false,noiseSuppression:false,sampleRate:48000}
    });
    const aTracks=stream.getAudioTracks();
    if(!aTracks.length){
      stream.getTracks().forEach(t=>t.stop());
      toast('âš ï¸ Activa "Compartir audio de la pestaÃ±a" cuando el navegador lo pida.');
      return;
    }
    stream.getVideoTracks().forEach(t=>t.stop());
    const aStream=new MediaStream(aTracks);
    recChunks=[];
    const mimeType=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ?'audio/webm;codecs=opus':'audio/webm';
    mediaRec=new MediaRecorder(aStream,{mimeType});
    mediaRec.ondataavailable=e=>{if(e.data.size>0)recChunks.push(e.data);};
    mediaRec.onstop=()=>{
      const name=($('audioName').value.trim()||'stoica-audio').replace(/[^\w\-]/g,'_');
      const blob=new Blob(recChunks,{type:'audio/webm'});
      dlBlob(blob, name+'.webm');
      aStream.getTracks().forEach(t=>t.stop());
      showRecUI(false);
      toast('âœ“ Audio guardado: '+name+'.webm');
      recording=false;mediaRec=null;
    };
    mediaRec.start(1000);recording=true;
    showRecUI(true);speak(text);
    toast('ğŸ”´ Grabando â€” pulsa "Detener y guardar" cuando termines.',5000);
  }catch(err){
    if(err.name==='NotAllowedError') toast('Permiso denegado. Permite compartir la pantalla.');
    else toast('Error: '+err.message);
  }
};
$('bStopRec').onclick=()=>{stopSpeech();if(mediaRec&&recording)mediaRec.stop();};
function stopRec(){if(mediaRec&&recording)mediaRec.stop();}
function showRecUI(on){
  $('bExport').style.display=on?'none':'';
  $('bStopRec').style.display=on?'':'none';
  $('recStatus').style.display=on?'':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADUCCIÃ“N â€” MyMemory API (gratis, sin clave)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANG_NAMES={es:'EspaÃ±ol',en:'InglÃ©s',fr:'FrancÃ©s',de:'AlemÃ¡n',pt:'PortuguÃ©s',it:'Italiano',ru:'Ruso',zh:'Chino',ar:'Ãrabe',ja:'JaponÃ©s',auto:'auto'};

async function translateText(text,src,dest){
  const chunks=splitChunks(text,480);
  let translated='';
  for(let i=0;i<chunks.length;i++){
    load(Math.round((i/chunks.length)*90));
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(chunks[i])}&langpair=${src==='auto'?`en|${dest}`:src+'|'+dest}`;
    const res=await fetch(url);
    if(!res.ok) throw new Error('Error de red: '+res.status);
    const data=await res.json();
    if(data.responseStatus!==200) throw new Error(data.responseDetails||'Error');
    translated+=data.responseData.translatedText+' ';
  }
  return translated.trim();
}

function splitChunks(text,maxLen){
  const sentences=text.match(/[^.!?]+[.!?]*/g)||[text];
  const chunks=[];let cur='';
  sentences.forEach(s=>{
    if((cur+s).length>maxLen){if(cur)chunks.push(cur.trim());cur=s;}else cur+=s;
  });
  if(cur.trim())chunks.push(cur.trim());
  return chunks.length?chunks:[text];
}

async function runTranslate(text,src,dest,origEl,outEl){
  if(!text.trim()){toast('No hay texto para traducir.');return;}
  origEl.textContent=text.length>4000?text.substring(0,4000)+'[â€¦]':text;
  origEl.classList.remove('mt');outEl.textContent='â³ Traduciendoâ€¦';outEl.classList.remove('mt');
  load(10);
  try{
    const result=await translateText(text.length>4000?text.substring(0,4000):text,src,dest);
    outEl.textContent=result;load(100);toast(`âœ“ Traducido al ${LANG_NAMES[dest]}`);
    document.querySelector('[data-tab="translate"]').click();
  }catch(err){
    outEl.textContent='âŒ Error: '+err.message+'\n\nPosibles causas:\nâ€¢ Sin conexiÃ³n\nâ€¢ LÃ­mite MyMemory alcanzado\nâ€¢ Texto muy largo';
    load(100);
  }
}

$('bTransAll').onclick=async()=>await runTranslate(fullText,$('tSrc').value,$('tDest').value,$('tOrig'),$('tOut'));
$('bTransSel').onclick=async()=>{
  const sel=window.getSelection();const txt=sel&&!sel.isCollapsed?sel.toString().trim():null;
  if(!txt){toast('Selecciona texto primero.');return;}
  await runTranslate(txt,$('tSrc').value,$('tDest').value,$('tOrig'),$('tOut'));
};
$('bCopyTrans').onclick=()=>{
  const t=$('tOut').textContent;
  if(!t||t.startsWith('La traducciÃ³n')){toast('No hay traducciÃ³n.');return;}
  navigator.clipboard.writeText(t).then(()=>toast('âœ“ TraducciÃ³n copiada'));
};
$('bQTrans').onclick=async()=>{
  if(!fullText.trim()){toast('Carga texto primero.');return;}
  $('tDest').value=$('sdest').value;
  await runTranslate(fullText,'auto',$('sdest').value,$('tOrig'),$('tOut'));
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALGORITMOS NLP â€” TF-IDF, resumen, preguntas, mapa
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STOP_ES=new Set('a al ante aquÃ©l aquella aquello aquel como con cual de del desde dos el ella ellas ellos en entre era eres es esta estaba estas este esto estos fue hay la las le les lo los me mi mis muy no nos o para pero por que quien se si sin son su sus tambiÃ©n tan te tenÃ­a todo todos una uno unos voy ya yo un mÃ¡s ni'.split(' '));
const STOP_EN=new Set('a an the and or but if in on at to of for is are was were be been being have has had do does did will would shall should may might must can could am i we you he she it they their them there this that these those with from by as into then than also'.split(' '));

function extractWords(text){
  return text.toLowerCase().replace(/[^a-zÃ¡Ã©Ã­Ã³ÃºÃ¼Ã±\w\s]/gi,' ').split(/\s+/).filter(w=>w.length>3&&!STOP_ES.has(w)&&!STOP_EN.has(w));
}
function tfidf(text){
  const words=extractWords(text);const freq={};
  words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const max=Math.max(...Object.values(freq),1);
  Object.keys(freq).forEach(k=>freq[k]/=max);
  return freq;
}
function scoreSentences(sentences,freq){
  return sentences.map(s=>{
    const words=extractWords(s);
    if(!words.length) return {s,score:0};
    const score=words.reduce((acc,w)=>acc+(freq[w]||0),0)/words.length;
    return {s,score};
  });
}

// â”€â”€ RESUMEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genSummary(text,n){
  const rawSentences=text.match(/[^.!?]+[.!?]*/g)||[];
  const sentences=rawSentences.map(s=>s.trim()).filter(s=>s.length>20);
  if(!sentences.length) return 'No se encontraron oraciones suficientes.';
  const freq=tfidf(text);
  const scored=scoreSentences(sentences,freq);
  const top=scored.slice().sort((a,b)=>b.score-a.score).slice(0,n).map(x=>x.s);
  const ordered=sentences.filter(s=>top.includes(s));
  return ordered.join(' ');
}

$('bSumm').onclick=()=>{
  if(!fullText){toast('Carga texto primero.');return;}
  const nMap={breve:5,medio:10,completo:20};
  const n=nMap[$('sLevel').value];
  load(30);
  setTimeout(()=>{
    try{
      const result=genSummary(fullText,n);
      $('summOut').textContent=result;$('summOut').classList.remove('mt');
      load(100);toast('âœ“ Resumen generado ('+n+' oraciones)');
    }catch(e){$('summOut').textContent='Error: '+e.message;load(100);}
  },100);
};
$('bCopySumm').onclick=()=>{
  if($('summOut').classList.contains('mt')){toast('Genera un resumen primero.');return;}
  navigator.clipboard.writeText($('summOut').textContent).then(()=>toast('âœ“ Copiado'));
};
$('bExSumm').onclick=()=>{
  if($('summOut').classList.contains('mt')){toast('Genera un resumen primero.');return;}
  dl($('summOut').textContent,'stoica-resumen.txt');toast('âœ“ Exportado');
};

// â”€â”€ PREGUNTAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractSubject(sentence){
  const words=sentence.trim().split(/\s+/);
  const meaningful=words.filter(w=>w.length>2&&!STOP_ES.has(w.toLowerCase())&&!STOP_EN.has(w.toLowerCase()));
  return meaningful.slice(0,3).join(' ').replace(/[.,;:]/g,'')||words.slice(0,2).join(' ');
}
function summarizeSentence(s){
  const words=s.split(/\s+/);
  return words.length>15?words.slice(0,12).join(' ')+'â€¦':s;
}

function genQuestions(text,type,count){
  const rawSentences=text.match(/[^.!?]+[.!?]*/g)||[];
  const sentences=rawSentences.map(s=>s.trim()).filter(s=>s.split(/\s+/).length>6);
  if(sentences.length<3) return null;
  const freq=tfidf(text);
  const scored=scoreSentences(sentences,freq).sort((a,b)=>b.score-a.score);
  const questions=[];const used=new Set();
  const templates={
    literal:[
      (s)=>({q:`Â¿QuÃ© se menciona sobre "${extractSubject(s)}"?`,a:s,j:'InformaciÃ³n explÃ­cita en el texto.'}),
      (s)=>({q:`SegÃºn el texto, Â¿quÃ© dice sobre ${extractSubject(s)}?`,a:s,j:'El texto lo expresa directamente.'}),
      (s)=>({q:`Â¿CÃ³mo describe el texto a "${extractSubject(s)}"?`,a:s,j:'DescripciÃ³n literal en el fragmento.'}),
      (s)=>({q:`Â¿QuÃ© afirma el autor sobre ${extractSubject(s)}?`,a:s,j:'AfirmaciÃ³n presente de forma explÃ­cita.'}),
    ],
    inferencial:[
      (s)=>({q:`Â¿Por quÃ© crees que "${extractSubject(s)}" es importante en el texto?`,a:'Respuesta inferida: '+summarizeSentence(s),j:'ConclusiÃ³n deducida del contenido implÃ­cito.'}),
      (s)=>({q:`Â¿QuÃ© consecuencias se derivan de lo afirmado sobre ${extractSubject(s)}?`,a:'Posible consecuencia: '+summarizeSentence(s),j:'Se infiere del contexto general.'}),
      (s)=>({q:`Â¿QuÃ© intenciÃ³n tiene el autor al mencionar "${extractSubject(s)}"?`,a:'IntenciÃ³n probable: contextualizar el tema central.',j:'Deducido del tono y estructura.'}),
      (s)=>({q:`Â¿QuÃ© relaciÃ³n existe entre "${extractSubject(s)}" y el tema principal?`,a:'RelaciÃ³n: '+summarizeSentence(s),j:'Establecida implÃ­citamente.'}),
    ]
  };
  const pool=type==='mixto'?[...templates.literal,...templates.inferencial]:(templates[type]||templates.literal);
  let qi=0;
  for(let i=0;i<scored.length&&questions.length<count;i++){
    const sent=scored[i].s;if(used.has(sent))continue;used.add(sent);
    const tpl=pool[qi%pool.length];qi++;
    try{const q=tpl(sent);if(q.q&&q.a)questions.push({...q,orig:sent});}catch(e){}
  }
  if(questions.length<count){
    const keywords=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,20).map(e=>e[0]);
    keywords.forEach(kw=>{
      if(questions.length>=count)return;
      questions.push({q:`Â¿CuÃ¡l es la importancia de "${kw}" en el texto?`,a:`El tÃ©rmino "${kw}" aparece como concepto de alta frecuencia y relevancia.`,j:'Identificado como palabra clave.',orig:''});
    });
  }
  return questions.slice(0,count);
}

$('bGenQ').onclick=()=>{
  if(!fullText){toast('Carga texto primero.');return;}
  const count=Math.min(30,Math.max(5,parseInt($('qNum').value)||10));
  const type=$('qType').value;
  load(30);
  setTimeout(()=>{
    const qs=genQuestions(fullText,type,count);
    load(100);
    if(!qs||!qs.length){
      $('questOut').innerHTML='<p style="color:var(--muted);font-family:var(--fMono);font-size:.72rem">Texto muy corto. Prueba con mÃ¡s contenido.</p>';
      return;
    }
    lastQs=qs;
    renderQuestions(qs);
    toast(`âœ“ ${qs.length} preguntas generadas`);
  },150);
};

function renderQuestions(list){
  const c=$('questOut');c.innerHTML='';
  list.forEach((q,i)=>{
    const card=document.createElement('div');
    card.className='qcard';
    card.innerHTML=`
      <div class="qnum">PREGUNTA ${i+1} Â· ${$('qType').value==='inferencial'?'Inferencial':'ComprensiÃ³n'}</div>
      <div class="qtxt">${E(q.q)}</div>
      <button class="btn g" style="align-self:flex-start" onclick="this.nextElementSibling.classList.toggle('vis');this.textContent=this.textContent.includes('Ver')?'Ocultar':'Ver respuesta'">Ver respuesta</button>
      <div class="qans">
        <strong>Respuesta:</strong> ${E(q.a)}<br/>
        <span class="qjust">JustificaciÃ³n: ${E(q.j)}</span>
        ${q.orig?`<br/><span class="qjust" style="color:var(--acc2)">Fragmento: "${E(summarizeSentence(q.orig))}"</span>`:''}
      </div>`;
    c.appendChild(card);
  });
}

$('bCopyQ').onclick=()=>{
  if(!lastQs.length){toast('Genera preguntas primero.');return;}
  const text=lastQs.map((q,i)=>`${i+1}. ${q.q}\nRespuesta: ${q.a}\nJustificaciÃ³n: ${q.j}`).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€\n\n');
  navigator.clipboard.writeText(text).then(()=>toast('âœ“ Preguntas copiadas'));
};

// â”€â”€â”€ EXPORTAR PREGUNTAS A WORD (.docx) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bExQDocx').onclick=()=>{
  if(!lastQs.length){toast('Genera preguntas primero.');return;}
  exportQuestionsDocx(lastQs);
};
function exportQuestionsDocx(qs){
  // Build a minimal DOCX from scratch using XML
  const title='Preguntas de ComprensiÃ³n â€” Stoica Reader';
  const date=new Date().toLocaleDateString('es-CO');
  
  const paragraphs=[];
  // Title paragraph
  paragraphs.push(makeDocxParagraph(title,true,'center','2C0A2C'));
  paragraphs.push(makeDocxParagraph(`Generado: ${date}`,false,'center','888888'));
  paragraphs.push(makeDocxParagraph(''));
  
  qs.forEach((q,i)=>{
    paragraphs.push(makeDocxParagraph(`${i+1}. ${q.q}`,true,'left','1a1625'));
    paragraphs.push(makeDocxParagraph(`Respuesta: ${q.a}`,false,'left','333355'));
    paragraphs.push(makeDocxParagraph(`JustificaciÃ³n: ${q.j}`,false,'left','666680'));
    if(q.orig) paragraphs.push(makeDocxParagraph(`Fragmento: "${summarizeSentence(q.orig)}"`,false,'left','888899'));
    paragraphs.push(makeDocxParagraph(''));
  });
  
  const docXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
  xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <w:body>
    ${paragraphs.join('\n')}
    <w:sectPr>
      <w:pgSz w:w="12240" w:h="15840"/>
      <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/>
    </w:sectPr>
  </w:body>
</w:document>`;

  const relsXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

  const wordRelsXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`;

  const contentTypesXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`;

  const zip=buildZipDocx({
    '[Content_Types].xml': contentTypesXml,
    '_rels/.rels': relsXml,
    'word/document.xml': docXml,
    'word/_rels/document.xml.rels': wordRelsXml
  });
  dlBlob(zip, 'stoica-preguntas.docx');
  toast('âœ“ Exportado como Word (.docx)');
}

function makeDocxParagraph(text,bold=false,align='left',colorHex='000000'){
  const jc=align==='center'?`<w:jc w:val="center"/>`:`<w:jc w:val="left"/>`;
  const rPr=`<w:rPr>${bold?'<w:b/>':''}<w:color w:val="${colorHex}"/><w:sz w:val="${bold?'24':'20'}"/></w:rPr>`;
  const escaped=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  return `<w:p><w:pPr>${jc}</w:pPr><w:r>${rPr}<w:t xml:space="preserve">${escaped}</w:t></w:r></w:p>`;
}

// â”€â”€â”€ EXPORTAR PREGUNTAS A EXCEL (.xlsx) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('bExQXlsx').onclick=()=>{
  if(!lastQs.length){toast('Genera preguntas primero.');return;}
  exportQuestionsXlsx(lastQs);
};

function exportQuestionsXlsx(qs){
  // Build minimal XLSX (which is also a ZIP with XML)
  const sharedStrings=[];
  const ssMap={};
  function addStr(s){
    const k=String(s);
    if(ssMap[k]===undefined){ssMap[k]=sharedStrings.length;sharedStrings.push(k);}
    return ssMap[k];
  }
  
  // Headers
  const headers=['#','Pregunta','Respuesta','JustificaciÃ³n','Fragmento de referencia'];
  const rows=[headers];
  qs.forEach((q,i)=>rows.push([String(i+1),q.q,q.a,q.j,q.orig?summarizeSentence(q.orig):'â€”']));
  
  // Build cells
  const sheetRows=rows.map((row,ri)=>{
    const cells=row.map((cell,ci)=>{
      const col=String.fromCharCode(65+ci);
      const idx=addStr(cell);
      return `<c r="${col}${ri+1}" t="s"><v>${idx}</v></c>`;
    }).join('');
    return `<row r="${ri+1}">${cells}</row>`;
  }).join('\n');
  
  const sharedStrXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${sharedStrings.length}" uniqueCount="${sharedStrings.length}">
${sharedStrings.map(s=>`<si><t xml:space="preserve">${escXml(s)}</t></si>`).join('\n')}
</sst>`;

  const sheetXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
  <sheetData>${sheetRows}</sheetData>
</worksheet>`;

  const workbookXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <sheets><sheet name="Preguntas" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;

  const wbRelsXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>
</Relationships>`;

  const ctXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
  <Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
</Types>`;

  const relsXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;

  const zip=buildZipDocx({
    '[Content_Types].xml': ctXml,
    '_rels/.rels': relsXml,
    'xl/workbook.xml': workbookXml,
    'xl/_rels/workbook.xml.rels': wbRelsXml,
    'xl/worksheets/sheet1.xml': sheetXml,
    'xl/sharedStrings.xml': sharedStrXml
  });
  dlBlob(zip,'stoica-preguntas.xlsx');
  toast('âœ“ Exportado como Excel (.xlsx)');
}

function escXml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// â”€â”€ MINIMAL ZIP BUILDER (uncompressed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildZipDocx(files){
  // Build a ZIP file in memory (store method, no compression)
  const enc=new TextEncoder();
  const fileEntries=[];
  let offset=0;
  const localHeaders=[];
  
  Object.entries(files).forEach(([name,content])=>{
    const nameBytes=enc.encode(name);
    const dataBytes=enc.encode(content);
    const crc=crc32(dataBytes);
    const local=new Uint8Array(30+nameBytes.length+dataBytes.length);
    const view=new DataView(local.buffer);
    view.setUint32(0,0x04034b50,true); // local file header signature
    view.setUint16(4,20,true);  // version needed
    view.setUint16(6,0,true);   // flags
    view.setUint16(8,0,true);   // compression: store
    view.setUint16(10,0,true);  // mod time
    view.setUint16(12,0,true);  // mod date
    view.setUint32(14,crc,true);
    view.setUint32(18,dataBytes.length,true);
    view.setUint32(22,dataBytes.length,true);
    view.setUint16(26,nameBytes.length,true);
    view.setUint16(28,0,true);
    local.set(nameBytes,30);
    local.set(dataBytes,30+nameBytes.length);
    localHeaders.push({local,name:nameBytes,nameStr:name,crc,size:dataBytes.length,offset});
    fileEntries.push(local);
    offset+=local.length;
  });
  
  // Central directory
  const centralDirParts=[];
  let cdSize=0;
  localHeaders.forEach(({name,nameStr,crc,size,offset})=>{
    const cd=new Uint8Array(46+name.length);
    const view=new DataView(cd.buffer);
    view.setUint32(0,0x02014b50,true);
    view.setUint16(4,20,true);view.setUint16(6,20,true);
    view.setUint16(8,0,true);view.setUint16(10,0,true);
    view.setUint16(12,0,true);view.setUint16(14,0,true);
    view.setUint32(16,crc,true);
    view.setUint32(20,size,true);view.setUint32(24,size,true);
    view.setUint16(28,name.length,true);
    view.setUint16(30,0,true);view.setUint16(32,0,true);
    view.setUint16(34,0,true);view.setUint32(38,0,true);
    view.setUint32(42,offset,true);
    cd.set(name,46);
    centralDirParts.push(cd);cdSize+=cd.length;
  });
  
  // End of central directory
  const eocd=new Uint8Array(22);
  const ev=new DataView(eocd.buffer);
  ev.setUint32(0,0x06054b50,true);
  ev.setUint16(4,0,true);ev.setUint16(6,0,true);
  ev.setUint16(8,localHeaders.length,true);ev.setUint16(10,localHeaders.length,true);
  ev.setUint32(12,cdSize,true);ev.setUint32(16,offset,true);
  ev.setUint16(20,0,true);
  
  const totalSize=offset+cdSize+22;
  const result=new Uint8Array(totalSize);
  let pos=0;
  fileEntries.forEach(e=>{result.set(e,pos);pos+=e.length;});
  centralDirParts.forEach(e=>{result.set(e,pos);pos+=e.length;});
  result.set(eocd,pos);
  
  return new Blob([result],{type:'application/zip'});
}

function crc32(data){
  let crc=0xFFFFFFFF;
  const table=crc32.table||(crc32.table=(()=>{
    const t=[];
    for(let i=0;i<256;i++){
      let c=i;for(let j=0;j<8;j++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);
      t[i]=c;
    }return t;
  })());
  for(let i=0;i<data.length;i++) crc=table[(crc^data[i])&0xFF]^(crc>>>8);
  return (crc^0xFFFFFFFF)>>>0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAPA CONCEPTUAL MEJORADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genMap(text){
  const freq=tfidf(text);
  const sorted=Object.entries(freq).filter(([w])=>w.length>3).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length) return null;

  const central=sorted[0][0];
  const rest=sorted.slice(1,41).map(e=>e[0]);
  const branchColors=[
    {bg:'var(--acc)',text:'#fff',border:'var(--acc)'},
    {bg:'var(--acc2)',text:'#fff',border:'var(--acc2)'},
    {bg:'var(--acc3)',text:'#111',border:'var(--acc3)'},
    {bg:'var(--gold)',text:'#111',border:'var(--gold)'},
    {bg:'var(--warm)',text:'#fff',border:'var(--warm)'},
    {bg:'#8b5cf6',text:'#fff',border:'#8b5cf6'},
  ];
  const branchSize=6;
  const branches=[];
  const branchNames=['Conceptos centrales','TÃ©rminos clave','Ideas secundarias','Contexto','Detalles','AmpliaciÃ³n'];
  for(let i=0;i<rest.length;i+=branchSize){
    const chunk=rest.slice(i,i+branchSize);
    if(chunk.length) branches.push({
      nombre:branchNames[Math.floor(i/branchSize)%branchNames.length],
      conceptos:chunk,
      color:branchColors[Math.floor(i/branchSize)%branchColors.length]
    });
  }

  // Key ideas: top sentences
  const sentences=(text.match(/[^.!?]+[.!?]*/g)||[]).map(s=>s.trim()).filter(s=>s.length>25);
  const scoredS=scoreSentences(sentences,freq).sort((a,b)=>b.score-a.score).slice(0,10);

  // Hierarchy: top keywords grouped by frequency bands
  const hierLevels=[
    sorted.slice(0,3).map(e=>e[0]),    // level 0: top 3
    sorted.slice(3,10).map(e=>e[0]),   // level 1: next 7
    sorted.slice(10,25).map(e=>e[0])   // level 2: next 15
  ];

  // Comparative: find pairs of sentences that share keywords
  const compRows=[];
  const keywords=sorted.slice(0,8).map(e=>e[0]);
  keywords.forEach(kw=>{
    const matching=sentences.filter(s=>s.toLowerCase().includes(kw)).slice(0,2);
    if(matching.length>=2){
      compRows.push({concepto:kw,a:summarizeSentence(matching[0]),b:summarizeSentence(matching[1])});
    }
  });

  return {central,branches,ideas:scoredS.map(x=>x.s),hierLevels,compRows};
}

$('bGenMap').onclick=()=>{
  if(!fullText){toast('Carga texto primero.');return;}
  load(30);
  setTimeout(()=>{
    const result=genMap(fullText);
    load(100);
    if(!result){
      $('mapOut').innerHTML='<span style="font-family:var(--fMono);font-size:.7rem;color:var(--muted)">Texto muy corto.</span>';
      return;
    }
    allMapData=result;
    renderMindMap(result);
    renderHierarchy(result);
    renderComparative(result);
    renderIdeas(result);
    toast('âœ“ Mapa conceptual generado');
  },150);
};

function renderMindMap(data){
  const c=$('mapOut');
  let html=`<div style="width:100%;display:flex;flex-direction:column;gap:16px;align-items:center">`;
  html+=`<div style="text-align:center"><div class="map-central">${E(data.central)}</div></div>`;
  html+=`<div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;width:100%">`;
  data.branches.forEach(b=>{
    html+=`<div class="branch" style="border-top-color:${b.color.bg}">
      <div class="btitle" style="color:${b.color.bg}">${E(b.nombre)}</div>
      <div class="bchips">`;
    b.conceptos.forEach(c2=>html+=`<span class="mnode" style="font-size:.6rem;padding:4px 8px">${E(c2)}</span>`);
    html+=`</div></div>`;
  });
  html+=`</div></div>`;
  c.innerHTML=html;
}

function renderHierarchy(data){
  const c=$('hierOut');
  const levels=data.hierLevels;
  let html='<div style="padding:4px"><ul class="hier-list">';
  if(levels[0]&&levels[0].length){
    levels[0].forEach(kw=>{
      html+=`<li class="hier-item"><span class="hier-label level-0">${E(kw)}</span>`;
      // Find level-1 related (just use next band)
      if(levels[1]&&levels[1].length){
        html+='<ul class="hier-list">';
        levels[1].slice(0,4).forEach(kw1=>{
          html+=`<li class="hier-item"><span class="hier-label level-1">${E(kw1)}</span>`;
          if(levels[2]&&levels[2].length){
            html+='<ul class="hier-list">';
            levels[2].slice(0,3).forEach(kw2=>html+=`<li class="hier-item"><span class="hier-label level-2">${E(kw2)}</span></li>`);
            html+='</ul>';
          }
          html+='</li>';
        });
        html+='</ul>';
      }
      html+='</li>';
    });
  }
  html+='</ul></div>';
  c.innerHTML=html;
  c.classList.remove('mt');
}

function renderComparative(data){
  const c=$('compOut');
  if(!data.compRows||!data.compRows.length){
    c.innerHTML='<p style="font-family:var(--fMono);font-size:.7rem;color:var(--muted);padding:12px">No hay suficiente informaciÃ³n para el cuadro comparativo.</p>';
    return;
  }
  let html=`<table class="compare-table" style="width:100%">
    <thead><tr>
      <th style="width:20%">Concepto</th>
      <th style="width:40%">Contexto A</th>
      <th style="width:40%">Contexto B</th>
    </tr></thead><tbody>`;
  data.compRows.slice(0,10).forEach(row=>{
    html+=`<tr>
      <td style="font-family:var(--fMono);font-size:.65rem;font-weight:500;color:var(--acc)">${E(row.concepto)}</td>
      <td>${E(row.a)}</td>
      <td>${E(row.b)}</td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  c.innerHTML=html;
}

function renderIdeas(data){
  const c=$('ideasOut');
  c.textContent=data.ideas.map((s,i)=>`${i+1}. ${s}`).join('\n\n');
  c.classList.remove('mt');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TECLADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  const tag=e.target.tagName;
  if(tag==='TEXTAREA'||tag==='INPUT') return;
  if(e.code==='Space'){e.preventDefault();togglePlay();}
  if(e.code==='Escape') stopSpeech();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER (PWA / Offline)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}

console.log('%câœ¦ STOICA READER v4 â€” 100% gratuito',
  'color:#c45fff;font-family:monospace;font-weight:bold;font-size:12px');
</script>
</body>
</html>
